<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#0e0f12">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="IT Toolkit">
<meta name="mobile-web-app-capable" content="yes">
<meta name="description" content="IT Support Toolkit v5 - PWA para helpdesk, sysadmin y NOC. Offline first, responsive, mobile-native experience.">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>⚡</text></svg>">
<title>IT Support Toolkit v5.0 Mobile</title>
<style>
/* ═══════════════════════════════════════════
   IT TOOLKIT v5.0 MOBILE - RESPONSIVE PWA
   ═══════════════════════════════════════════ */

/* ======= ENV THEMES ======= */
:root{
  --ea:#45d6c6;--ear:69,214,198;--ea2:#2ab3a4;
  --bg:#0e0f12;--bg2:#14161b;--bg3:#1b1f27;--bg4:#222834;
  --bd:#2b313c;--bd2:#343c4a;
  --tx:#f1f3f7;--tx2:#c6cbd3;--tx3:#8892a0;
  --gr:#6fe3a1;--yw:#f2cf64;--or:#f5a768;--rd:#f07b7b;--pu:#a7a0ff;
  /* Desktop defaults */
  --rh:60px;--sh:48px;--sw:270px;--bnh:0px;
  --mono:'JetBrains Mono','Cascadia Mono','Consolas','SFMono-Regular','Menlo',monospace;
  --ui:'Space Grotesk','Sora','IBM Plex Sans','Segoe UI Variable','Segoe UI',sans-serif;--r:10px;
  --shadow:0 14px 40px rgba(0,0,0,.32);
}

/* Tablet (768px - 1199px) */
@media (max-width: 1199px) and (min-width: 768px) {
  :root {
    --sw: 220px;
    --rh: 56px;
    --sh: 46px;
  }
}

/* Mobile (<768px) - drawer navigation + bottom nav */
@media (max-width: 767px) {
  :root {
    --sw: 0px;
    --rh: 52px;
    --sh: 44px;
    --bnh: 56px; /* Bottom nav height */
  }
}
[data-env=win]{--ea:#6bb8ff;--ear:107,184,255;--ea2:#4b95e6;--eh:#10151c;--es:#0d1117;}
[data-env=lin]{--ea:#f6a96e;--ear:246,169,110;--ea2:#e19052;--eh:#17120e;--es:#12100d;}
[data-env=mac]{--ea:#cfd7e2;--ear:207,215,226;--ea2:#b0bac7;--eh:#11151a;--es:#0d1116;}
[data-env=ad] {--ea:#b2a3ff;--ear:178,163,255;--ea2:#8f7fe6;--eh:#12131a;--es:#0e0f14;}
[data-env=corp]{--ea:#6edbc4;--ear:110,219,196;--ea2:#48c3ab;--eh:#0f1416;--es:#0c1113;}
[data-env=sd] {--ea:#f5d26a;--ear:245,210,106;--ea2:#e0b64e;--eh:#16130e;--es:#11100c;}
[data-env=sec]{--ea:#f08787;--ear:240,135,135;--ea2:#dc6a6a;--eh:#151012;--es:#110d0e;}
[data-env=net]{--ea:#75e3a8;--ear:117,227,168;--ea2:#55c98a;--eh:#0f1411;--es:#0c110e;}
/* LIGHT MODE */
.lm{--bg:#f0f4f8;--bg2:#ffffff;--bg3:#e8edf4;--bg4:#dde4ed;--bd:#b8c8d8;--bd2:#a0b4c8;--tx:#0e1a2a;--tx2:#2a4060;--tx3:#5070a0;}
/* ═══ LIGHT MODE COMPLETE OVERRIDES ═══ */
.lm .cmd-code{color:#1a3a5c!important;background:#dde4ed!important;border-color:#b8c8d8!important;}
.lm .cmd-name{color:#0e1a2a!important;font-weight:700!important;}
.lm .cmd-desc{color:#2a4060!important;}
.lm .cmd-tag{color:#5070a0!important;background:#dde4ed!important;border-color:#b8c8d8!important;}
/* OS PILL STYLES */
.os-pill {
  position: relative;
}
.os-pill.on {
  background:linear-gradient(180deg,rgba(var(--ear),.18),rgba(var(--ear),.08))!important;
  color:var(--ea)!important;
  border-color:rgba(var(--ear),.55)!important;
}
.os-pill:hover {
  background:rgba(255,255,255,.05)!important;
  border-color:var(--bd2)!important;
}
.os-pill[data-tip]:hover::after {
  content:attr(data-tip);
  position:absolute;
  bottom:100%;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,.9);
  color:#fff;
  padding:6px 10px;
  border-radius:8px;
  font-size:11px;
  font-weight:600;
  white-space:nowrap;
  z-index:1000;
  margin-bottom:8px;
  font-family:var(--ui);
  text-transform:none;
  letter-spacing:0;
  pointer-events:none;
  animation:tooltipSlideUp .2s ease;
}
.os-pill[data-tip]:hover::before {
  content:'';
  position:absolute;
  bottom:100%;
  left:50%;
  transform:translateX(-50%);
  border:5px solid transparent;
  border-top-color:rgba(0,0,0,.9);
  z-index:1001;
  margin-bottom:0;
  pointer-events:none;
  animation:tooltipSlideUp .2s ease;
}
.lm .ob-w{color:#0064b8!important;background:rgba(0,100,184,.1)!important;}
.lm .ob-l{color:#c44010!important;background:rgba(196,64,16,.1)!important;}
.lm .ob-m{color:#4a5060!important;background:rgba(74,80,96,.1)!important;}
.lm .fvb,.lm .cpb{color:#5070a0!important;border-color:#b8c8d8!important;}
.lm .fvb.on{color:#c09000!important;background:rgba(192,144,0,.1)!important;border-color:#c09000!important;}
.lm .result-val,.lm .h-code,.lm .cheat-val{color:var(--ea2)!important;}
.lm .timer-disp{color:var(--ea2)!important;text-shadow:none!important;}
.lm .stat-num,.lm .logo h1,.lm .nav-item.act,.lm .hero-t{color:var(--ea2)!important;}
.lm .panel-ttl,.lm .grp-ttl,.lm .cheat-h4,.lm .env-ind{color:var(--ea2)!important;}
.lm #rep-out,.lm .notes-form,.lm .ff input,.lm .ff select,.lm .ff textarea{color:#0e1a2a!important;}
.lm #rep-out{color:#0e1a2a!important;background:#f8fafc!important;}
.lm body::after,.lm body::before{display:none!important;}
.lm .env-bar{border-bottom-color:rgba(var(--ear),.4)!important;background:var(--bg3)!important;}
.lm header{background:#ffffff!important;}
.lm .sidebar{background:#f5f8fc!important;}
.lm .cmd-card{background:#ffffff!important;border-color:#c8d4e0!important;}
.lm .cmd-card:hover{border-color:var(--ea2)!important;}
.lm .cheat-box,.lm .tool-c,.lm .chi,.lm .inc-entry,.lm .h-entry{background:#ffffff!important;border-color:#c8d4e0!important;}
.lm .chi-t{color:#0e1a2a!important;}
.lm .chi-s{color:#5070a0!important;}
.lm .note-tt,.lm .h-nm,.lm .sr-name,.lm .qc-t{color:#0e1a2a!important;}
.lm .note-bd,.lm .tool-desc,.lm .tout{color:#2a4060!important;}
.lm .tout{background:#dde4ed!important;color:#1a3a5c!important;}
.lm .nav-item{color:#5070a0!important;}
.lm .nav-item:hover{color:#0e1a2a!important;background:rgba(var(--ear),.06)!important;}
.lm .grp-ttl::after{background:#c8d4e0!important;}
.lm .inc-time{color:var(--ea2)!important;}
.lm .env-tab{color:#5070a0!important;}
.lm .env-tab.on{color:var(--ea2)!important;}
.lm .ninfo-val{color:var(--ea2)!important;}
.lm .ninfo-lbl{color:#5070a0!important;}
/* BASE */
*,::before,::after{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{background:radial-gradient(1200px 800px at 15% -10%,rgba(var(--ear),.12),transparent 60%),linear-gradient(180deg,var(--bg) 0%,#0b0d12 100%);color:var(--tx);font-family:var(--ui);min-height:100vh;overflow-x:hidden;transition:background .35s,color .35s;}
body::after{content:'';position:fixed;inset:0;background:radial-gradient(circle at 20% 30%,rgba(255,255,255,.03),transparent 35%),radial-gradient(circle at 80% 10%,rgba(255,255,255,.02),transparent 40%);pointer-events:none;z-index:9997;}
body::before{content:'';position:fixed;top:-220px;right:-220px;width:620px;height:620px;background:radial-gradient(ellipse,rgba(var(--ear),.08) 0%,transparent 70%);pointer-events:none;z-index:0;transition:background .4s;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-thumb{background:var(--bd2);border-radius:2px;}
/* ENV BAR */
.env-bar{background:rgba(16,19,24,.85);border-bottom:1px solid rgba(var(--ear),.18);height:var(--sh);display:flex;align-items:center;padding:0 16px;position:sticky;top:0;z-index:400;transition:background .4s,border-color .4s;backdrop-filter:saturate(1.15) blur(10px);}
.env-lbl{font-family:var(--mono);font-size:9px;letter-spacing:3px;color:var(--tx3);white-space:nowrap;margin-right:12px;text-transform:uppercase;}
.env-tabs{display:flex;flex:1;overflow-x:auto;overflow-y:hidden;scrollbar-width:none;}
.env-tabs::-webkit-scrollbar{display:none;}
.env-tab{display:flex;align-items:center;gap:6px;padding:0 10px;height:28px;cursor:pointer;font-size:12px;font-weight:600;color:var(--tx3);border:1px solid transparent;border-radius:999px;white-space:nowrap;transition:all .2s;font-family:var(--ui);}
.env-tab:hover{color:var(--tx);background:rgba(255,255,255,.05);border-color:var(--bd2);}
.env-tab.on{color:var(--ea);border-color:rgba(var(--ear),.55);background:linear-gradient(180deg,rgba(var(--ear),.18),rgba(var(--ear),.08));}
.env-right{display:flex;gap:6px;align-items:center;margin-left:8px;flex-shrink:0;}
.ico-btn{background:none;border:1px solid var(--bd2);color:var(--tx3);width:32px;height:32px;cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:var(--r);transition:all .2s;font-size:15px;}
.ico-btn:hover{border-color:var(--ea);color:var(--ea);}
/* HEADER */
header{background:rgba(18,22,28,.92);border-bottom:1px solid var(--bd);padding:0 20px;display:flex;align-items:center;gap:14px;height:var(--rh);position:sticky;top:var(--sh);z-index:300;transition:background .3s;box-shadow:0 6px 18px rgba(0,0,0,.35);backdrop-filter:saturate(1.15) blur(10px);}
.logo{display:flex;align-items:center;gap:10px;flex-shrink:0;}
.logo-ico{width:34px;height:34px;border:1px solid rgba(var(--ear),.45);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:16px;animation:lpulse 3s infinite;transition:border-color .4s;background:rgba(var(--ear),.12);}
@keyframes lpulse{0%,100%{box-shadow:0 0 0 0 rgba(var(--ear),.5)}70%{box-shadow:0 0 0 7px rgba(var(--ear),0)}}
.logo h1{font-size:16px;font-weight:700;letter-spacing:2.4px;color:var(--ea);text-transform:uppercase;font-family:var(--mono);transition:color .4s;}
.logo p{font-size:9px;color:var(--tx3);letter-spacing:2px;font-family:var(--mono);}
.env-ind{font-family:var(--mono);font-size:9px;padding:4px 10px;border:1px solid rgba(var(--ear),.55);color:var(--ea);letter-spacing:2px;text-transform:uppercase;border-radius:999px;transition:all .4s;flex-shrink:0;background:rgba(var(--ear),.12);}
/* SEARCH */
.srch-wrap{flex:1;max-width:440px;position:relative;}
.srch-wrap input{width:100%;background:rgba(20,24,31,.75);border:1px solid var(--bd);color:var(--tx);padding:9px 14px 9px 32px;font-family:var(--mono);font-size:11px;outline:none;border-radius:12px;transition:all .2s;backdrop-filter:blur(6px);}
.srch-wrap input:focus{border-color:rgba(var(--ear),.65);box-shadow:0 0 0 3px rgba(var(--ear),.14);}
.srch-wrap input::placeholder{color:var(--tx3);}
.si{position:absolute;left:9px;top:50%;transform:translateY(-50%);color:var(--tx3);pointer-events:none;font-size:13px;}
.srch-drop{position:absolute;top:calc(100% + 6px);left:0;right:0;background:rgba(18,22,28,.98);border:1px solid rgba(var(--ear),.35);border-radius:14px;z-index:999;max-height:340px;overflow-y:auto;display:none;box-shadow:0 20px 48px rgba(0,0,0,.5);backdrop-filter:blur(8px);}
.srch-drop.open{display:block;}
.sr-item{padding:10px 14px;cursor:pointer;border-bottom:1px solid var(--bd);display:flex;gap:10px;transition:background .15s;}
.sr-item:hover{background:rgba(255,255,255,.05);}
.sr-item:last-child{border-bottom:none;}
.sr-ico{font-size:14px;flex-shrink:0;margin-top:1px;}
.sr-bd{flex:1;min-width:0;}
.sr-name{font-size:12px;font-weight:600;color:var(--tx);}
.sr-code{font-family:var(--mono);font-size:9px;color:var(--ea);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.sr-meta{font-family:var(--mono);font-size:9px;color:var(--tx3);display:flex;gap:8px;margin-top:1px;}
.sr-empty{padding:24px;text-align:center;color:var(--tx3);font-family:var(--mono);font-size:11px;}
/* HEADER RIGHT */
.h-right{display:flex;gap:6px;align-items:center;margin-left:auto;}
.os-pills{display:flex;gap:3px;}
.os-pill{padding:4px 10px;font-family:var(--mono);font-size:9px;border:1px solid var(--bd2);background:none;color:var(--tx3);cursor:pointer;letter-spacing:.5px;border-radius:var(--r);display:flex;align-items:center;gap:4px;transition:all .2s;}
.os-pill.p-all.on{border-color:var(--ea);color:var(--ea);background:rgba(var(--ear),.08);}
.os-pill.p-win.on{border-color:#00a4ef;color:#00a4ef;background:rgba(0,164,239,.08);}
.os-pill.p-lin.on{border-color:#e95420;color:#e95420;background:rgba(233,84,32,.08);}
.os-pill.p-mac.on{border-color:#b0b8c5;color:#b0b8c5;background:rgba(176,184,197,.08);}
.hbtn{display:flex;align-items:center;gap:5px;background:none;border:1px solid var(--bd2);color:var(--tx3);padding:5px 11px;cursor:pointer;font-family:var(--mono);font-size:10px;border-radius:var(--r);transition:all .2s;white-space:nowrap;}
.hbtn:hover{border-color:var(--ea);color:var(--ea);}
.sdot{width:6px;height:6px;border-radius:50%;background:var(--gr);animation:blink 2s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
/* LAYOUT */
.main{display:flex;min-height:calc(100vh - var(--sh) - var(--rh));}
/* SIDEBAR */
.sidebar{width:var(--sw);background:var(--es,var(--bg2));border-right:1px solid var(--bd);padding:12px 0;flex-shrink:0;position:sticky;top:calc(var(--sh) + var(--rh));height:calc(100vh - var(--sh) - var(--rh));overflow-y:auto;transition:background .4s;}
.lm .sidebar{background:var(--bg2)!important;}
.sidebar::-webkit-scrollbar{width:3px;}
.sidebar::-webkit-scrollbar-thumb{background:var(--bd);}
.side-chip-wrap{padding:8px 14px 6px;}
.side-chip{display:inline-flex;align-items:center;gap:6px;font-family:var(--mono);font-size:9px;letter-spacing:1px;padding:4px 8px;border:1px solid rgba(var(--ear),.35);border-radius:999px;color:var(--ea);background:rgba(var(--ear),.12);text-transform:uppercase;}
.s-ttl{font-size:9px;letter-spacing:3px;color:var(--tx3);padding:10px 16px 4px;text-transform:uppercase;font-family:var(--mono);}
.nav-item{display:flex;align-items:center;gap:8px;padding:9px 14px;margin:3px 10px;cursor:pointer;border:1px solid transparent;border-radius:12px;font-size:12px;font-weight:600;color:var(--tx3);font-family:var(--ui);transition:all .18s;user-select:none;}
.nav-item:hover{background:rgba(255,255,255,.04);color:var(--tx);border-color:rgba(var(--ear),.2);}
.nav-item.act{background:linear-gradient(180deg,rgba(var(--ear),.22),rgba(var(--ear),.10));color:var(--ea);border-color:rgba(var(--ear),.55);font-weight:700;}
.n-ico{font-size:14px;width:18px;text-align:center;flex-shrink:0;}
.nav-badge{margin-left:auto;font-size:9px;font-family:var(--mono);background:var(--bg3);border:1px solid var(--bd);padding:1px 6px;color:var(--tx2);border-radius:999px;}
.nav-badge.fv{background:rgba(255,215,0,.1);border-color:rgba(255,215,0,.3);color:var(--yw);}
.n-div{height:1px;background:var(--bd);margin:6px 14px;}

/* ═══ MOBILE: HAMBURGER MENU ═══ */
.hamburger{
  display:none;
  width:44px;height:44px;
  background:none;border:1px solid var(--bd2);
  color:var(--tx);border-radius:var(--r);
  cursor:pointer;font-size:20px;
  align-items:center;justify-content:center;
  transition:all .2s;flex-shrink:0;
}
.hamburger:hover{border-color:var(--ea);color:var(--ea);}
.hamburger:active{transform:scale(0.95);}

/* ═══ MOBILE: DRAWER OVERLAY ═══ */
.sb-overlay{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.7);
  z-index:499;opacity:0;
  transition:opacity .25s;
  backdrop-filter:blur(4px);
}
.sb-overlay.open{opacity:1;}

/* ═══ MOBILE: DRAWER NAVIGATION ═══ */
@media (max-width: 767px) {
  .hamburger{display:flex;}
  
  .sidebar{
    position:fixed;
    left:-280px;
    top:0;
    width:280px;
    height:100vh;
    z-index:500;
    transition:transform .25s ease-out;
    box-shadow:var(--shadow);
    padding-top:calc(var(--sh) + var(--rh) + 12px);
  }
  
  .sidebar.drawer-open{
    transform:translateX(280px);
  }
  
  .sb-overlay{display:block;}
  
  /* Content adjustment for bottom nav */
  .content{
    padding:16px 12px calc(var(--bnh) + 16px) 12px;
  }
  
  /* Hide desktop elements */
  .logo p{display:none;}
  .env-ind{display:none;}
  .os-pills{display:none;}
}

/* ═══ MOBILE: BOTTOM NAVIGATION ═══ */
.bottom-nav{
  display:none;
  position:fixed;
  bottom:0;left:0;right:0;
  height:var(--bnh);
  background:rgba(18,22,28,.96);
  border-top:1px solid var(--bd);
  z-index:400;
  backdrop-filter:saturate(1.15) blur(10px);
  box-shadow:0 -4px 20px rgba(0,0,0,.3);
}

.bottom-nav-items{
  display:flex;
  height:100%;
  justify-content:space-around;
  align-items:center;
  padding:0 8px;
}

.nav-item-mobile{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  flex:1;
  height:100%;
  color:var(--tx3);
  font-size:24px;
  cursor:pointer;
  text-decoration:none;
  transition:all .2s;
  border-radius:8px;
  gap:2px;
  min-width:48px;
}

.nav-item-mobile span{
  font-size:9px;
  font-family:var(--mono);
  letter-spacing:0.5px;
  text-transform:uppercase;
  display:none;
}

.nav-item-mobile:active{
  transform:scale(0.92);
}

.nav-item-mobile.active{
  color:var(--ea);
  background:rgba(var(--ear),.12);
}

@media (max-width: 767px) {
  .bottom-nav{display:block;}
}

/* ═══ RESPONSIVE: HEADER MOBILE ═══ */
@media (max-width: 767px) {
  header{padding:0 12px;gap:10px;}
  .srch-wrap{max-width:none;flex:1;}
  .srch-wrap input{font-size:10px;padding:8px 10px 8px 28px;}
  .logo-ico{width:30px;height:30px;font-size:14px;}
  .logo h1{font-size:14px;letter-spacing:1.8px;}
}

@media (max-width: 480px) {
  .h-right{gap:4px;}
  .hbtn{padding:4px 8px;font-size:9px;}
  .ico-btn{width:36px;height:36px;font-size:14px;}
}

/* ═══ RESPONSIVE: ENV BAR MOBILE ═══ */
@media (max-width: 767px){
  .env-bar{padding:0 12px;height:var(--sh);}
  .env-lbl{font-size:8px;letter-spacing:2px;margin-right:8px;}
  .env-tab{padding:0 8px;height:26px;font-size:10px;gap:4px;}
  .ico-btn{width:30px;height:30px;font-size:13px;}
}

/* CONTENT */
.content{flex:1;padding:22px;overflow-y:auto;position:relative;z-index:1;}
/* SECTIONS */
.sec{display:none;animation:fin .2s ease;}
.sec.act{display:block;}
@keyframes fin{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:none}}
.sec-hdr{margin-bottom:18px;padding-bottom:14px;border-bottom:1px solid var(--bd);}
.sec-hdr h2{font-size:20px;font-weight:700;display:flex;align-items:center;gap:8px;letter-spacing:.2px;}
.sec-hdr p{color:var(--tx3);font-size:10px;margin-top:5px;font-family:var(--mono);}
.lvl{display:inline-flex;align-items:center;gap:6px;padding:3px 10px;font-size:9px;font-family:var(--mono);letter-spacing:1.5px;text-transform:uppercase;border:1px solid;border-radius:999px;margin-bottom:6px;background:rgba(255,255,255,.02);}
.l1{border-color:rgba(98,217,149,.5);color:var(--gr);background:rgba(98,217,149,.08);}
.l2{border-color:rgba(242,201,76,.5);color:var(--yw);background:rgba(242,201,76,.08);}
.l3{border-color:rgba(235,87,87,.5);color:var(--rd);background:rgba(235,87,87,.08);}
.la{border-color:rgba(var(--ear),.5);color:var(--ea);background:rgba(var(--ear),.12);}
/* OS TABS */
.os-tab-bar{display:flex;gap:6px;margin-bottom:16px;border-bottom:1px solid var(--bd);}
.os-tab{display:flex;align-items:center;gap:6px;padding:6px 12px;cursor:pointer;font-size:12px;font-weight:600;color:var(--tx3);border:1px solid transparent;border-radius:999px;transition:all .2s;}
.os-tab:hover{color:var(--tx);border-color:var(--bd2);background:rgba(255,255,255,.03);}
.os-tab.on{color:var(--ea);border-color:rgba(var(--ear),.5);background:rgba(var(--ear),.12);}
.os-tab .tc{font-family:var(--mono);font-size:9px;background:var(--bg3);border:1px solid var(--bd);padding:1px 5px;border-radius:10px;}
/* GROUP */
.grp-ttl{display:flex;align-items:center;gap:8px;font-size:9px;font-family:var(--mono);letter-spacing:3px;color:var(--tx3);text-transform:uppercase;margin:10px 0 12px;padding:3px 0;}
.grp-ttl::before{content:'';width:6px;height:6px;background:var(--gc,var(--ea));border-radius:1px;flex-shrink:0;}
.grp-ttl::after{content:'';flex:1;height:1px;background:var(--bd);}
/* CMD GRID */
.cmd-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(295px,1fr));gap:12px;margin-bottom:22px;}
.cmd-card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0)) ,var(--bg2);border:1px solid var(--bd);border-radius:14px;padding:14px;position:relative;overflow:hidden;transition:all .2s;box-shadow:var(--shadow);}
.cmd-card:hover{border-color:rgba(var(--ear),.6);transform:translateY(-1px);box-shadow:0 16px 34px rgba(0,0,0,.35);}
.cmd-card.cp{border-color:var(--gr)!important;box-shadow:0 0 14px rgba(57,255,20,.18)!important;}
.cmd-card.hid,.cmd-card.osh{display:none;}
.ct{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:8px;flex-wrap:wrap;}
.cmd-name{font-size:12px;font-weight:700;letter-spacing:.3px;color:var(--tx);text-transform:uppercase;font-family:var(--ui);flex:1;}
.cmd-tag{font-size:9px;font-family:var(--mono);padding:3px 8px;background:rgba(var(--ear),.15);border:1px solid rgba(var(--ear),.4);color:var(--ea);border-radius:8px;white-space:nowrap;flex-shrink:0;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;}
.cmd-desc{font-size:11px;color:var(--tx2);margin-bottom:7px;line-height:1.6;}
.cmd-code{background:var(--bg);border:1px solid var(--bd);border-radius:10px;padding:8px 10px;font-family:var(--mono);font-size:10px;color:var(--ca,var(--ea));word-break:break-word;line-height:1.75;max-height:130px;overflow-y:auto;}
.cmd-code::-webkit-scrollbar{width:3px;}
.cmd-code::-webkit-scrollbar-thumb{background:var(--bd2);}
.cf{display:flex;justify-content:space-between;align-items:center;margin-top:7px;gap:4px;}
.os-bs{display:flex;gap:4px;flex-wrap:wrap;}
.ob{font-size:9px;padding:1px 6px;border:1px solid;border-radius:999px;font-family:var(--mono);display:inline-flex;align-items:center;gap:2px;}
.ob-w{border-color:rgba(90,162,255,.5);color:#5aa2ff;background:rgba(90,162,255,.1);}
.ob-l{border-color:rgba(242,153,74,.5);color:#f2994a;background:rgba(242,153,74,.1);}
.ob-m{border-color:rgba(199,208,219,.5);color:#c7d0db;background:rgba(199,208,219,.1);}
.cmd-acts{display:flex;gap:4px;flex-shrink:0;}
.fvb,.cpb{font-size:9px;font-family:var(--mono);background:none;border:1px solid var(--bd);color:var(--tx3);padding:3px 8px;cursor:pointer;border-radius:8px;transition:all .2s;white-space:nowrap;}
.fvb:hover{border-color:var(--yw);color:var(--yw);}
.fvb.on{border-color:var(--yw);color:var(--yw);background:rgba(255,215,0,.08);}
.cpb:hover{border-color:var(--ea);color:var(--ea);}
/* TYPE COLORS */
.tn{--ca:#6ab8ff;}.ts{--ca:#7ee3a1;}.td{--ca:#f5d470;}
.tp{--ca:#f5a267;}.tu{--ca:#b99cff;}.tc2{--ca:#f07777;}
.tr{--ca:#73d6cf;}.tl{--ca:#f1a3c0;}.ta{--ca:#a69bff;}.tex{--ca:#78d7c2;}
/* HOME */
.home-grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-bottom:18px;}
.hero-card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,0)) ,var(--bg2);border:1px solid var(--bd);border-radius:18px;padding:22px;position:relative;overflow:hidden;box-shadow:var(--shadow);}
.hero-card::after{content:'';position:absolute;inset:-60% -30% auto auto;width:260px;height:260px;background:radial-gradient(circle,rgba(var(--ear),.25),rgba(var(--ear),0));opacity:.55;pointer-events:none;}
.hero-badge{display:inline-flex;align-items:center;gap:6px;font-family:var(--mono);font-size:9px;letter-spacing:3px;text-transform:uppercase;border:1px solid rgba(var(--ear),.4);color:var(--ea);padding:4px 10px;border-radius:999px;background:rgba(var(--ear),.1);}
.hero-title{font-size:28px;font-weight:700;color:var(--tx);margin-top:12px;letter-spacing:.2px;line-height:1.2;}
.hero-sub{font-family:var(--mono);color:var(--tx3);font-size:10px;letter-spacing:2px;margin-top:8px;}
.hero-ctas{display:flex;gap:8px;margin-top:16px;flex-wrap:wrap;}
.hero-meta{margin-top:12px;color:var(--tx3);font-size:10px;font-family:var(--mono);letter-spacing:1px;}
.stats-panel{background:var(--bg2);border:1px solid var(--bd);border-radius:18px;padding:18px;box-shadow:var(--shadow);}
.stats-title{font-size:10px;font-family:var(--mono);letter-spacing:3px;text-transform:uppercase;color:var(--tx3);margin-bottom:12px;}
.stats-row{display:grid;grid-template-columns:repeat(2,minmax(120px,1fr));gap:10px;}
.stat-c{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,0)) ,var(--bg3);border:1px solid var(--bd);padding:12px 14px;text-align:left;border-radius:14px;min-width:0;transition:all .2s;box-shadow:var(--shadow);}
.stat-c:hover{border-color:rgba(var(--ear),.6);transform:translateY(-2px);}
.stat-num{font-size:22px;font-weight:700;font-family:var(--mono);color:var(--ea);transition:color .4s;}
.stat-lbl{font-size:9px;color:var(--tx3);letter-spacing:2px;text-transform:uppercase;font-family:var(--mono);margin-top:4px;}
.home-block{margin-bottom:18px;}
.home-hdr{display:flex;align-items:flex-end;justify-content:space-between;gap:10px;margin-bottom:12px;flex-wrap:wrap;}
.home-kicker{font-size:10px;font-family:var(--mono);letter-spacing:3px;text-transform:uppercase;color:var(--tx3);}
.home-title{font-size:18px;font-weight:700;color:var(--tx);margin-top:4px;}
.home-pill{font-size:9px;font-family:var(--mono);letter-spacing:2px;text-transform:uppercase;color:var(--ea);border:1px solid rgba(var(--ear),.4);background:rgba(var(--ear),.12);padding:4px 10px;border-radius:999px;}
.quick-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;}
.qc{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0)) ,var(--bg2);border:1px solid var(--bd);padding:12px 14px;cursor:pointer;border-radius:14px;display:flex;align-items:center;gap:10px;transition:all .2s;box-shadow:var(--shadow);}
.qc:hover{border-color:var(--ea);background:var(--bg3);transform:translateY(-1px);}
.qc-ico{font-size:20px;flex-shrink:0;opacity:.85;filter:saturate(.9);}
.qc-t{font-size:12px;font-weight:600;color:var(--tx);}
.qc-s{font-size:9px;color:var(--tx3);font-family:var(--mono);margin-top:1px;}
/* CUSTOM COMMANDS */
.custom-layout{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:18px;}
.custom-compose,.custom-feed{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,0)) ,var(--bg2);border:1px solid var(--bd);border-radius:16px;padding:16px;box-shadow:var(--shadow);}
.custom-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;padding-bottom:10px;margin-bottom:12px;border-bottom:1px solid var(--bd);}
.custom-meta{display:flex;align-items:center;gap:8px;}
.custom-kicker{font-size:9px;font-family:var(--mono);letter-spacing:3px;text-transform:uppercase;color:var(--tx3);}
.custom-title{font-size:16px;font-weight:700;color:var(--tx);margin-top:4px;}
.custom-sub{font-size:10px;font-family:var(--mono);color:var(--tx3);margin-top:6px;letter-spacing:1px;}
.custom-count{font-size:9px;font-family:var(--mono);letter-spacing:1px;color:var(--tx3);border:1px solid var(--bd);background:var(--bg3);padding:4px 8px;border-radius:999px;white-space:nowrap;}
.custom-chip{font-size:9px;font-family:var(--mono);letter-spacing:2px;text-transform:uppercase;color:var(--ea);border:1px solid rgba(var(--ear),.4);background:rgba(var(--ear),.12);padding:4px 10px;border-radius:999px;white-space:nowrap;}
.custom-form{display:flex;flex-direction:column;gap:10px;}
.custom-item{background:var(--bg3);border:1px solid var(--bd);border-radius:10px;padding:10px;margin-bottom:7px;}
.custom-item:last-child{margin-bottom:0;}
.ci-top{display:flex;justify-content:space-between;align-items:center;gap:8px;}
.ci-name{font-size:12px;font-weight:600;color:var(--tx);}
.ci-meta{font-family:var(--mono);font-size:9px;color:var(--tx3);margin-top:3px;}
.custom-os{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px;}
.cos{font-size:9px;font-family:var(--mono);padding:2px 6px;border-radius:999px;border:1px solid;letter-spacing:1px;}
.cos-w{border-color:rgba(90,162,255,.5);color:#5aa2ff;background:rgba(90,162,255,.12);}
.cos-l{border-color:rgba(242,153,74,.5);color:#f2994a;background:rgba(242,153,74,.12);}
.cos-m{border-color:rgba(199,208,219,.5);color:#c7d0db;background:rgba(199,208,219,.12);}
.ci-actions{display:flex;gap:4px;flex-shrink:0;}
.os-opts{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px;}
.os-opts label{display:flex;align-items:center;gap:4px;font-family:var(--mono);font-size:9px;color:var(--tx3);border:1px solid var(--bd);padding:2px 6px;border-radius:8px;}
.custom-empty{padding:26px;text-align:center;color:var(--tx3);font-family:var(--mono);font-size:11px;}
/* TOOLS */
.tools-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:10px;margin-bottom:20px;}
.tool-c{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0)) ,var(--bg2);border:1px solid var(--bd);border-radius:14px;padding:14px;transition:all .2s;box-shadow:var(--shadow);}
.tool-c:hover{border-color:rgba(var(--ear),.6);transform:translateY(-1px);}
.tool-top{display:flex;align-items:center;gap:8px;margin-bottom:7px;}
.tool-ico{font-size:22px;}
.tool-nm{font-size:13px;font-weight:700;color:var(--tx);}
.tool-bdg{font-size:8px;font-family:var(--mono);padding:2px 6px;border:1px solid;border-radius:10px;margin-left:auto;}
.tf{border-color:var(--gr);color:var(--gr);}
.tp2{border-color:var(--or);color:var(--or);}
.tb{border-color:var(--pu);color:var(--pu);}
.tool-desc{font-size:11px;color:var(--tx2);margin-bottom:8px;line-height:1.6;}
.tool-lnk{display:inline-flex;align-items:center;gap:4px;font-size:9px;font-family:var(--mono);color:var(--ea);text-decoration:none;border:1px solid var(--bd);padding:3px 8px;border-radius:8px;transition:all .2s;}
.tool-lnk:hover{border-color:var(--ea);background:rgba(var(--ear),.07);}
.tool-tags{display:flex;gap:3px;margin-top:7px;flex-wrap:wrap;}
.tool-tag{font-size:8px;font-family:var(--mono);padding:2px 6px;background:var(--bg3);border:1px solid var(--bd);color:var(--tx3);border-radius:8px;}
/* CHECKLIST */
.chklist{display:flex;flex-direction:column;gap:5px;margin-bottom:16px;}
.chi{display:flex;align-items:flex-start;gap:10px;padding:10px 13px;background:var(--bg2);border:1px solid var(--bd);border-radius:12px;cursor:pointer;transition:all .18s;user-select:none;}
.chi:hover{border-color:var(--tx3);}
.chi.dn{opacity:.5;}
.chbox{width:16px;height:16px;border:2px solid var(--bd2);border-radius:3px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:10px;color:var(--gr);transition:all .18s;margin-top:1px;}
.chi.dn .chbox{border-color:var(--gr);background:rgba(57,255,20,.1);}
.chi-t{font-size:12px;font-weight:500;color:var(--tx);}
.chi-s{font-size:10px;color:var(--tx3);font-family:var(--mono);margin-top:2px;}
/* CHEATSHEET */
.cheat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(235px,1fr));gap:10px;margin-bottom:18px;}
.cheat-box{background:var(--bg2);border:1px solid var(--bd);border-radius:12px;padding:13px;box-shadow:var(--shadow);}
.cheat-h4{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--ea);margin-bottom:9px;font-family:var(--mono);}
.ch-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid var(--bd);gap:8px;}
.ch-row:last-child{border-bottom:none;}
.cheat-label{font-size:12px;color:var(--tx2);}
.cheat-val{font-family:var(--mono);font-size:10px;color:var(--ea);cursor:pointer;text-align:right;border-radius:var(--r);padding:1px 4px;transition:all .15s;}
.cheat-val:hover{background:rgba(var(--ear),.12);}
/* SUBNET */
.sub-card{background:var(--bg2);border:1px solid var(--bd);border-radius:12px;padding:20px;margin-bottom:16px;box-shadow:var(--shadow);}
.input-row{display:grid;grid-template-columns:1fr 1fr auto;gap:10px;align-items:end;margin-bottom:16px;}
.field{display:flex;flex-direction:column;gap:5px;}
.field label{font-size:9px;letter-spacing:2px;font-family:var(--mono);color:var(--tx3);text-transform:uppercase;}
.field input,.field select{background:var(--bg3);border:1px solid var(--bd);color:var(--tx);padding:9px 12px;font-family:var(--mono);font-size:12px;outline:none;border-radius:10px;transition:all .2s;width:100%;}
.field input:focus,.field select:focus{border-color:var(--ea);}
.calc-btn{background:rgba(var(--ear),.1);border:1px solid var(--ea);color:var(--ea);padding:8px 18px;font-family:var(--mono);font-size:10px;cursor:pointer;letter-spacing:2px;border-radius:10px;white-space:nowrap;transition:all .2s;text-transform:uppercase;}
.calc-btn:hover{background:rgba(var(--ear),.2);}
.sub-results{display:grid;grid-template-columns:repeat(auto-fill,minmax(185px,1fr));gap:8px;margin-top:16px;}
.res-box{background:var(--bg3);border:1px solid var(--bd);border-radius:10px;padding:10px;}
.res-lbl{font-size:9px;letter-spacing:2px;font-family:var(--mono);color:var(--tx3);text-transform:uppercase;margin-bottom:4px;}
.result-val{font-family:var(--mono);font-size:13px;color:var(--ea);cursor:pointer;transition:color .15s;font-weight:500;}
.result-val:hover{color:var(--gr);}
.cidr-tbl{width:100%;border-collapse:collapse;margin-top:14px;}
.cidr-tbl th{font-size:9px;letter-spacing:2px;font-family:var(--mono);color:var(--tx3);padding:6px 10px;border-bottom:1px solid var(--bd);text-align:left;text-transform:uppercase;}
.cidr-tbl td{font-family:var(--mono);font-size:11px;padding:6px 10px;border-bottom:1px solid var(--bd);color:var(--tx2);cursor:pointer;}
.cidr-tbl tr:hover td{background:rgba(var(--ear),.05);color:var(--ea);}
/* REPORT */
.rep-layout{display:grid;grid-template-columns:1fr 1fr;gap:14px;align-items:start;}
.rep-panel{background:var(--bg2);border:1px solid var(--bd);border-radius:12px;padding:18px;box-shadow:var(--shadow);}
.panel-ttl{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--ea);margin-bottom:14px;font-family:var(--mono);}
.ff{margin-bottom:10px;}
.ff label{display:block;font-size:9px;letter-spacing:2px;font-family:var(--mono);color:var(--tx3);text-transform:uppercase;margin-bottom:4px;}
.ff input,.ff select,.ff textarea{width:100%;background:var(--bg3);border:1px solid var(--bd);color:var(--tx);padding:8px 10px;font-family:var(--mono);font-size:11px;outline:none;border-radius:10px;transition:all .2s;}
.ff input:focus,.ff select:focus,.ff textarea:focus{border-color:var(--ea);}
.ff textarea{min-height:65px;resize:vertical;line-height:1.6;}
.f-actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:12px;}
.btn{padding:7px 12px;font-family:var(--mono);font-size:9px;cursor:pointer;letter-spacing:.5px;border-radius:10px;border:1px solid;white-space:nowrap;transition:all .2s;text-transform:uppercase;position:relative;}
.btn[title]:hover::after,.ico-btn[title]:hover::after,.env-tab[data-tip]:hover::after,[role="menuitem"][data-tip]:hover::after,.fvb[title]:hover::after,.cpb[title]:hover::after{
  content:attr(title);position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.9);color:#fff;padding:6px 10px;border-radius:8px;font-size:11px;font-weight:600;white-space:nowrap;z-index:1000;margin-bottom:8px;font-family:var(--ui);text-transform:none;letter-spacing:0;pointer-events:none;animation:tooltipSlideUp .2s ease;
}
.btn[title]:hover::before,.ico-btn[title]:hover::before,.env-tab[data-tip]:hover::before,[role="menuitem"][data-tip]:hover::before,.fvb[title]:hover::before,.cpb[title]:hover::before{
  content:'';position:absolute;bottom:100%;left:50%;transform:translateX(-50%);border:5px solid transparent;border-top-color:rgba(0,0,0,.9);z-index:1001;margin-bottom:0;pointer-events:none;animation:tooltipSlideUp .2s ease;
}
[data-tip]{
  cursor:help;
}
.env-tab[data-tip]:hover::after{
  content:attr(data-tip);
}
.env-tab[data-tip]:hover::before{
  border-top-color:rgba(0,0,0,.9);
}
/* DISABLE TOOLTIPS WHEN DISABLED */
body.no-tooltips .btn[title]:hover::after,
body.no-tooltips .ico-btn[title]:hover::after,
body.no-tooltips .env-tab[data-tip]:hover::after,
body.no-tooltips [role="menuitem"][data-tip]:hover::after,
body.no-tooltips .fvb[title]:hover::after,
body.no-tooltips .cpb[title]:hover::after{
  display:none!important;
}
body.no-tooltips .btn[title]:hover::before,
body.no-tooltips .ico-btn[title]:hover::before,
body.no-tooltips .env-tab[data-tip]:hover::before,
body.no-tooltips [role="menuitem"][data-tip]:hover::before,
body.no-tooltips .fvb[title]:hover::before,
body.no-tooltips .cpb[title]:hover::before{
  display:none!important;
}
[role="menuitem"][data-tip]:hover::after{
  content:attr(data-tip);
}
[role="menuitem"][data-tip]:hover::before{
  border-top-color:rgba(0,0,0,.9);
}
@keyframes tooltipSlideUp{
  from{opacity:0;transform:translateX(-50%) translateY(5px);}to{opacity:1;transform:translateX(-50%) translateY(0);}
}
.btn-p{border-color:var(--ea);color:var(--ea);background:rgba(var(--ear),.08);}
.btn-p:hover{background:rgba(var(--ear),.18);}
.btn-s{border-color:var(--gr);color:var(--gr);background:rgba(57,255,20,.08);}
.btn-s:hover{background:rgba(57,255,20,.18);}
.btn-d{border-color:var(--rd);color:var(--rd);background:rgba(255,58,74,.08);}
.btn-d:hover{background:rgba(255,58,74,.18);}
.btn-n{border-color:var(--bd2);color:var(--tx3);background:none;}
.btn-n:hover{color:var(--tx);}
#rep-out{font-family:var(--mono);font-size:10px;line-height:1.8;color:var(--tx2);white-space:pre-wrap;min-height:350px;padding:2px;}
/* TIMER */
.timer-layout{display:grid;grid-template-columns:300px 1fr;gap:14px;align-items:start;}
.timer-panel{background:var(--bg2);border:1px solid var(--bd);border-radius:12px;padding:22px;text-align:center;box-shadow:var(--shadow);}
.t-lbl{font-family:var(--mono);font-size:9px;letter-spacing:3px;color:var(--tx3);text-transform:uppercase;margin-bottom:10px;}
.timer-disp{font-family:var(--mono);font-size:44px;font-weight:700;color:var(--ea);letter-spacing:4px;text-shadow:0 0 28px rgba(var(--ear),.4);transition:color .3s;line-height:1;}
.timer-disp.run{color:var(--gr);text-shadow:0 0 28px rgba(57,255,20,.4);}
.timer-disp.pau{color:var(--yw);text-shadow:0 0 28px rgba(255,215,0,.4);}
.sla-ind{font-family:var(--mono);font-size:10px;margin-top:7px;padding:3px 10px;border-radius:var(--r);display:inline-block;}
.sla-ok{color:var(--gr);background:rgba(57,255,20,.08);border:1px solid rgba(57,255,20,.2);}
.sla-wn{color:var(--yw);background:rgba(255,215,0,.08);border:1px solid rgba(255,215,0,.2);}
.sla-cr{color:var(--rd);background:rgba(255,58,74,.08);border:1px solid rgba(255,58,74,.2);}
.t-meta{margin-top:14px;text-align:left;}
.t-meta input,.t-meta select{width:100%;background:var(--bg3);border:1px solid var(--bd);color:var(--tx);padding:8px 10px;font-family:var(--mono);font-size:10px;outline:none;border-radius:10px;margin-bottom:6px;transition:all .2s;}
.t-meta input:focus,.t-meta select:focus{border-color:var(--ea);}
.t-ctrls{display:flex;gap:5px;justify-content:center;margin-top:12px;flex-wrap:wrap;}
.t-btn{padding:7px 12px;font-family:var(--mono);font-size:9px;cursor:pointer;letter-spacing:.5px;border-radius:10px;border:1px solid;transition:all .2s;text-transform:uppercase;}
.tb-s{border-color:var(--gr);color:var(--gr);background:rgba(57,255,20,.07);}
.tb-s:hover{background:rgba(57,255,20,.15);}
.tb-p{border-color:var(--yw);color:var(--yw);background:rgba(255,215,0,.07);}
.tb-p:hover{background:rgba(255,215,0,.15);}
.tb-st{border-color:var(--rd);color:var(--rd);background:rgba(255,58,74,.07);}
.tb-st:hover{background:rgba(255,58,74,.15);}
.inc-panel{background:var(--bg2);border:1px solid var(--bd);border-radius:12px;padding:18px;box-shadow:var(--shadow);}
.inc-entry{background:var(--bg3);border:1px solid var(--bd);border-radius:var(--r);padding:9px 12px;margin-bottom:7px;display:flex;align-items:center;gap:10px;}
.inc-time{font-family:var(--mono);font-size:17px;color:var(--ea);font-weight:700;flex-shrink:0;min-width:75px;text-align:center;}
.inc-info{flex:1;}
.inc-ttl{font-size:12px;font-weight:600;color:var(--tx);}
.inc-meta{font-family:var(--mono);font-size:9px;color:var(--tx3);margin-top:2px;display:flex;gap:8px;}
.xbtn{background:none;border:none;color:var(--tx3);cursor:pointer;font-size:13px;padding:0 3px;}
.xbtn:hover{color:var(--rd);}
/* HISTORY */
.hist-layout{display:grid;grid-template-columns:1fr 255px;gap:14px;}
.hist-list{background:var(--bg2);border:1px solid var(--bd);border-radius:12px;overflow:hidden;box-shadow:var(--shadow);}
.hist-hdr{padding:10px 14px;border-bottom:1px solid var(--bd);display:flex;justify-content:space-between;align-items:center;}
.h-entry{padding:10px 14px;border-bottom:1px solid var(--bd);cursor:pointer;transition:background .15s;display:flex;gap:10px;align-items:start;}
.h-entry:hover{background:var(--bg3);}
.h-entry:last-child{border-bottom:none;}
.h-ico{font-size:14px;flex-shrink:0;margin-top:2px;}
.h-bd{flex:1;min-width:0;}
.h-nm{font-size:12px;font-weight:600;color:var(--tx);}
.h-code{font-family:var(--mono);font-size:9px;color:var(--ea);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.h-meta{font-family:var(--mono);font-size:9px;color:var(--tx3);display:flex;gap:7px;margin-top:1px;}
.h-empty{padding:36px;text-align:center;color:var(--tx3);font-family:var(--mono);font-size:11px;}
.stats-panel{background:var(--bg2);border:1px solid var(--bd);border-radius:12px;padding:14px;box-shadow:var(--shadow);}
.sr-item{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--bd);font-size:11px;}
.sr-item:last-child{border-bottom:none;}
.sr-l{color:var(--tx3);}
.sr-v{font-family:var(--mono);color:var(--tx2);font-size:10px;text-align:right;max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
/* FAVS */
.fav-empty{background:var(--bg2);border:1px solid var(--bd);border-radius:12px;padding:50px;text-align:center;color:var(--tx3);font-family:var(--mono);font-size:11px;box-shadow:var(--shadow);}
/* NOTES */
.notes-layout{display:grid;grid-template-columns:1fr 310px;gap:14px;align-items:start;}
.notes-form,.notes-list{background:var(--bg2);border:1px solid var(--bd);border-radius:12px;padding:18px;box-shadow:var(--shadow);}
.note-c{background:var(--bg3);border:1px solid var(--bd);border-radius:10px;padding:10px;margin-bottom:7px;}
.note-tt{font-size:12px;font-weight:600;color:var(--tx);margin-bottom:4px;}
.note-bd{font-family:var(--mono);font-size:10px;color:var(--tx2);white-space:pre-wrap;line-height:1.7;max-height:60px;overflow:hidden;}
.note-ft{display:flex;justify-content:space-between;align-items:center;margin-top:7px;}
.note-dt{font-size:9px;font-family:var(--mono);color:var(--tx3);}
.note-acts{display:flex;gap:4px;}
.nbtn{background:none;border:1px solid var(--bd);color:var(--tx3);padding:3px 8px;cursor:pointer;font-family:var(--mono);font-size:9px;border-radius:8px;transition:all .2s;}
.nbtn:hover{border-color:var(--ea);color:var(--ea);}
.nbtn.del:hover{border-color:var(--rd);color:var(--rd);}
/* NET TOOLS INFO */
.net-info-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;}
.ninfo-card{background:var(--bg2);border:1px solid var(--bd);border-radius:12px;padding:16px;box-shadow:var(--shadow);}
.ninfo-title{font-size:13px;font-weight:700;color:var(--ea);margin-bottom:10px;display:flex;align-items:center;gap:8px;font-family:var(--ui);}
.ninfo-row{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--bd);font-size:12px;}
.ninfo-row:last-child{border-bottom:none;}
.ninfo-lbl{color:var(--tx3);}
.ninfo-val{font-family:var(--mono);font-size:11px;color:var(--ea);}
/* TOAST */
#toast{position:fixed;bottom:18px;right:18px;background:var(--bg2);border:1px solid var(--gr);color:var(--gr);padding:8px 16px;font-family:var(--mono);font-size:10px;z-index:9999;opacity:0;transform:translateY(6px);transition:all .22s;pointer-events:none;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.35);}
#toast.show{opacity:1;transform:translateY(0);}
hr.dv{border:none;border-top:1px solid var(--bd);margin:16px 0;}
@media(max-width:1100px){.rep-layout,.timer-layout,.hist-layout,.notes-layout,.custom-layout,.home-grid{grid-template-columns:1fr;}}
@media(max-width:800px){
  .sidebar{position:fixed;left:-280px;top:0;height:100vh;z-index:600;transition:left .3s cubic-bezier(.4,0,.2,1);box-shadow:none;width:260px;}
  .sidebar.open{left:0;box-shadow:8px 0 40px rgba(0,0,0,.5);}
  .sb-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:599;backdrop-filter:blur(2px);}
  .sb-overlay.open{display:block;}
  .cmd-grid{grid-template-columns:1fr;}.input-row{grid-template-columns:1fr 1fr;}
  .hamburger{display:flex!important;}
  .logo h1{font-size:13px;letter-spacing:1px;}
  .logo p{display:none;}
  .env-ind{display:none;}
  .os-pills{display:none;}
  .hbtn{display:none;}
  header{gap:8px;padding:0 10px;}
  .srch-wrap{max-width:100%;}
  .hero-title{font-size:22px;}
  .stats-row{grid-template-columns:repeat(2,minmax(120px,1fr));gap:8px;}
  .stat-c{padding:10px 12px;}
  .stat-num{font-size:20px;}
  .quick-grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:6px;}
  .content{padding:14px;}
  .cheat-grid{grid-template-columns:1fr;}
  .net-info-grid{grid-template-columns:1fr;}
  .tools-grid{grid-template-columns:1fr;}
}
@media(max-width:500px){
  .env-bar{padding:0 8px;}
  .env-lbl{display:none;}
  .env-tab{padding:0 9px;font-size:11px;}
  .hero-title{font-size:18px;}
  .hero-ctas{flex-direction:column;align-items:stretch;}
  .quick-grid{grid-template-columns:1fr 1fr;}
}
/* ═══ PHASE 3: UI/UX POLISH ═══ */
/* Card entrance animation */
@keyframes cardIn{from{opacity:0;transform:translateY(12px) scale(.97)}to{opacity:1;transform:none}}
.cmd-card{animation:cardIn .3s ease both;}
.cmd-grid .cmd-card:nth-child(2){animation-delay:.04s;}
.cmd-grid .cmd-card:nth-child(3){animation-delay:.08s;}
.cmd-grid .cmd-card:nth-child(4){animation-delay:.12s;}
.cmd-grid .cmd-card:nth-child(5){animation-delay:.16s;}
.cmd-grid .cmd-card:nth-child(6){animation-delay:.20s;}
.cmd-grid .cmd-card:nth-child(n+7){animation-delay:.24s;}
/* Copy pulse ripple */
@keyframes cpPulse{0%{box-shadow:0 0 0 0 rgba(57,255,20,.4)}100%{box-shadow:0 0 0 14px rgba(57,255,20,0)}}
.cmd-card.cp{animation:cpPulse .5s ease-out;}
/* Scroll-to-top button */
.scroll-top{position:fixed;bottom:22px;left:22px;width:40px;height:40px;border-radius:50%;background:var(--bg2);border:1px solid var(--ea);color:var(--ea);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:500;opacity:0;transform:translateY(12px);transition:all .25s;pointer-events:none;box-shadow:0 4px 16px rgba(0,0,0,.3);}
.scroll-top.vis{opacity:1;transform:none;pointer-events:auto;}
.scroll-top:hover{background:var(--ea);color:var(--bg);transform:scale(1.1);}
/* Hamburger button (mobile) */
.hamburger{display:none;background:none;border:1px solid var(--bd2);color:var(--tx3);width:34px;height:34px;cursor:pointer;border-radius:var(--r);align-items:center;justify-content:center;font-size:18px;transition:all .2s;flex-shrink:0;}
.hamburger:hover{border-color:var(--ea);color:var(--ea);}
/* Focus visible styles (keyboard accessibility) */
*:focus-visible{outline:2px solid var(--ea);outline-offset:2px;border-radius:var(--r);}
.nav-item:focus-visible{background:rgba(var(--ear),.11);color:var(--ea);border-left-color:var(--ea);}
.cmd-card:focus-visible{border-color:var(--ea);box-shadow:0 0 0 3px rgba(var(--ear),.2);}
.env-tab:focus-visible,.env-sc:focus-visible,.qc:focus-visible{outline-offset:0;}
/* Skip link */
.skip-link{position:fixed;top:-100%;left:16px;z-index:9999;background:var(--ea);color:var(--bg);padding:8px 16px;font-family:var(--mono);font-size:11px;border-radius:0 0 var(--r) var(--r);text-decoration:none;transition:top .2s;}
.skip-link:focus{top:0;}
/* Kbd hint badge */
.kbd{display:inline-block;font-family:var(--mono);font-size:8px;background:var(--bg3);border:1px solid var(--bd2);padding:1px 5px;border-radius:3px;color:var(--tx3);margin-left:4px;vertical-align:middle;line-height:1.4;}
/* Search result highlight */
.sr-item.sr-active{background:var(--bg3);}
/* Search highlight mark */
.sr-hl{background:rgba(var(--ear),.25);color:var(--ea);border-radius:2px;padding:0 1px;}
/* Scroll progress bar */
.scroll-progress{position:fixed;top:0;left:0;height:2px;background:linear-gradient(90deg,var(--ea),var(--ea2));z-index:9998;transition:width .1s linear;width:0;}
/* Tooltip system */
[data-tip]{position:relative;}
[data-tip]::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 7px);left:50%;transform:translateX(-50%) translateY(4px);background:var(--bg2);border:1px solid var(--ea);color:var(--ea);padding:4px 10px;font-family:var(--mono);font-size:9px;white-space:nowrap;border-radius:var(--r);pointer-events:none;opacity:0;transition:all .18s;z-index:800;box-shadow:0 4px 12px rgba(0,0,0,.3);}
[data-tip]:hover::after{opacity:1;transform:translateX(-50%) translateY(0);}
/* Stat counter animate */
@keyframes countPop{0%{transform:scale(.7);opacity:0}60%{transform:scale(1.1)}100%{transform:scale(1);opacity:1}}
.stat-num.pop{animation:countPop .4s ease;}
/* Sidebar smooth open */
.sidebar .nav-item{transform:translateX(0);transition:all .18s,transform .25s;}

/* ═══════════════════════════════════════════
   RESPONSIVE MEDIA QUERIES - MOBILE FIRST
   ═══════════════════════════════════════════ */

/* ═══ TABLET (768px - 1199px) ═══ */
@media (max-width: 1199px) and (min-width: 768px) {
  .cmd-grid{grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px;}
  .home-grid{grid-template-columns:1fr;gap:14px;}
  .tools-grid{grid-template-columns:repeat(auto-fill,minmax(240px,1fr));}
  .quick-grid{grid-template-columns:repeat(auto-fill,minmax(160px,1fr));}
}

/* ═══ MOBILE (<768px) ═══ */
@media (max-width: 767px) {
  /* Typography */
  body{font-size:14px;}
  
  /* Grids to single/double column */
  .cmd-grid{
    grid-template-columns:1fr;
    gap:10px;margin-bottom:18px;
  }
  
  .home-grid{
    grid-template-columns:1fr;
    gap:12px;margin-bottom:16px;
  }
  
  .stats-row{
    grid-template-columns:repeat(2,1fr);
    gap:8px;
  }
  
  .quick-grid{
    grid-template-columns:repeat(2,1fr);
    gap:8px;
  }
  
  .tools-grid{
    grid-template-columns:1fr;
    gap:8px;
  }
  
  .cheat-grid{
    grid-template-columns:1fr;
    gap:8px;
  }
  
  .custom-layout{
    grid-template-columns:1fr;
    gap:12px;
  }
  
  .rep-layout{
    grid-template-columns:1fr;
    gap:12px;
  }
  
  .sub-results{
    grid-template-columns:repeat(2,1fr);
    gap:6px;
  }
  
  .hist-layout{
    grid-template-columns:1fr!important;
    gap:12px!important;
  }
  
  /* Touch-friendly buttons (48px minimum) */
  .fvb,.cpb{
    padding:6px 12px;
    font-size:10px;
    min-height:44px;
    min-width:44px;
  }
  
  .btn{
    padding:10px 16px;
    font-size:10px;
    min-height:44px;
  }
  
  .ico-btn{
    width:44px;
    height:44px;
    font-size:16px;
  }
  
  .hbtn{
    min-height:40px;
    padding:6px 12px;
  }
  
  .os-pill{
    min-height:40px;
    padding:6px 12px;
  }
  
  .env-tab{
    min-height:40px;
  }
  
  .qc{
    padding:14px;
    min-height:64px;
  }
  
  /* Cards spacing */
  .cmd-card{padding:12px;border-radius:12px;}
  .hero-card{padding:18px;border-radius:16px;}
  .stat-c{padding:10px 12px;}
  
  /* Section headers */
  .sec-hdr h2{font-size:18px;}
  .sec-hdr p{font-size:9px;}
  
  /* Hero responsive */
  .hero-title{font-size:22px;}
  .hero-sub{font-size:9px;}
  .hero-badge{font-size:8px;padding:3px 8px;}
  
  /* Stats */
  .stat-num{font-size:20px;}
  .stat-lbl{font-size:8px;}
  
  /* Command cards */
  .cmd-name{font-size:11px;}
  .cmd-desc{font-size:10px;line-height:1.5;}
  .cmd-code{font-size:9px;padding:6px 8px;max-height:110px;}
  .cmd-tag{font-size:8px;padding:2px 6px;}
  
  /* Nav items in drawer */
  .nav-item{
    padding:12px;
    margin:4px 10px;
    font-size:13px;
    min-height:48px;
  }
  
  .n-ico{font-size:16px;width:20px;}
  
  /* Forms */
  .ff input,.ff select,.ff textarea{
    padding:10px 12px;
    font-size:12px;
    min-height:44px;
  }
  
  .ff textarea{min-height:80px;}
  
  /* Tables */
  .cidr-tbl{font-size:10px;}
  .cidr-tbl th,.cidr-tbl td{padding:8px 6px;}
  
  /* Reduce margins/padding */
  .sec-hdr{margin-bottom:14px;padding-bottom:10px;}
  .home-block{margin-bottom:14px;}
}

/* ═══ SMALL MOBILE (<480px) ═══ */
@media (max-width: 480px) {
  .content{padding:12px 10px calc(var(--bnh) + 12px) 10px;}
  
  .quick-grid{grid-template-columns:1fr;}
  
  .stats-row{
    grid-template-columns:1fr;
    gap:6px;
  }
  
  .sub-results{
    grid-template-columns:1fr;
  }
  
  .hero-title{font-size:18px;}
  .hero-ctas{flex-direction:column;width:100%;}
  .hero-ctas .btn{width:100%;}
  
  .cmd-card{padding:10px;}
  .stat-c{padding:8px 10px;}
  
  /* Very touch-friendly */
  .fvb,.cpb{
    min-height:48px;
    min-width:48px;
    padding:8px 14px;
  }
  
  .nav-item{min-height:52px;}
}

/* ═══ LANDSCAPE MOBILE ═══ */
@media (max-width: 900px) and (max-height: 500px) and (orientation: landscape) {
  .sidebar{
    padding-top:calc(var(--sh) + var(--rh) + 8px);
  }
  
  .content{
    padding:12px 12px calc(var(--bnh) + 12px) 12px;
  }
  
  .hero-card{padding:14px;}
  .hero-title{font-size:20px;}
}
</style>
</head>
<body data-env="default">
<a class="skip-link" href="#mainContent">Saltar al contenido</a>
<div class="scroll-progress" id="scrollProg"></div>

<!-- ENV BAR -->
<div class="env-bar" id="envBar" role="navigation" aria-label="Selector de entorno">
  <span class="env-lbl">// ENTORNO</span>
  <div class="env-tabs" id="envTabs">
    <div class="env-tab on" data-env="default" data-tip="Ver todos los comandos" onclick="setEnv('default')">⚡ General</div>
    <div class="env-tab" data-env="ad" data-tip="Herramientas Active Directory" onclick="setEnv('ad')">🏢 Active Directory</div>
    <div class="env-tab" data-env="corp" data-tip="Herramientas corporativas" onclick="setEnv('corp')">🏛️ Corporativo</div>
    <div class="env-tab" data-env="sd" data-tip="Service Desk & soporte" onclick="setEnv('sd')">🎧 Service Desk</div>
    <div class="env-tab" data-env="sec" data-tip="Herramientas de seguridad" onclick="setEnv('sec')">🔐 Seguridad</div>
    <div class="env-tab" data-env="net" data-tip="Herramientas de redes" onclick="setEnv('net')">📡 Redes</div>
  </div>
  <div class="env-right">
    <button class="ico-btn" onclick="toggleTooltips()" id="helpBtn" title="Mostrar/ocultar información de ayuda" aria-label="Alternar tooltips">❓</button>
    <button class="ico-btn" onclick="toggleTheme()" id="themeBtn" title="Cambiar a modo claro" aria-label="Cambiar tema claro/oscuro">🌙</button>
  </div>
</div>

<!-- OS FILTER BAR (Global SO selection) -->
<div class="os-filter-bar" id="osFilterBar" style="display:flex;align-items:center;gap:8px;padding:8px 16px;background:var(--bg2);border-bottom:1px solid var(--bd);font-family:var(--ui);font-size:11px;color:var(--tx2);">
  <span style="font-weight:600;letter-spacing:1px;">SISTEMA:</span>
  <button class="os-pill" id="pill-all" onclick="setOsF('all')" title="Mostrar comandos para todos los SO" data-tip="Ver todos" style="display:inline-flex;align-items:center;gap:4px;padding:5px 12px;border-radius:999px;border:1px solid var(--bd);background:transparent;color:var(--tx3);cursor:pointer;transition:all .2s;font-family:var(--ui);font-size:10px;text-transform:uppercase;letter-spacing:.5px;font-weight:600;">✓ TODOS</button>
  <button class="os-pill" id="pill-win" onclick="setOsF('win')" title="Mostrar solo comandos para Windows" data-tip="Windows" style="display:inline-flex;align-items:center;gap:4px;padding:5px 12px;border-radius:999px;border:1px solid var(--bd);background:transparent;color:var(--tx3);cursor:pointer;transition:all .2s;font-family:var(--ui);font-size:10px;text-transform:uppercase;letter-spacing:.5px;font-weight:600;">🪟 WIN</button>
  <button class="os-pill" id="pill-lin" onclick="setOsF('lin')" title="Mostrar solo comandos para Linux" data-tip="Linux" style="display:inline-flex;align-items:center;gap:4px;padding:5px 12px;border-radius:999px;border:1px solid var(--bd);background:transparent;color:var(--tx3);cursor:pointer;transition:all .2s;font-family:var(--ui);font-size:10px;text-transform:uppercase;letter-spacing:.5px;font-weight:600;">🐧 LIN</button>
  <button class="os-pill" id="pill-mac" onclick="setOsF('mac')" title="Mostrar solo comandos para macOS" data-tip="macOS" style="display:inline-flex;align-items:center;gap:4px;padding:5px 12px;border-radius:999px;border:1px solid var(--bd);background:transparent;color:var(--tx3);cursor:pointer;transition:all .2s;font-family:var(--ui);font-size:10px;text-transform:uppercase;letter-spacing:.5px;font-weight:600;">🍎 MAC</button>
</div>

<!-- HEADER -->
<header role="banner">
  <button class="hamburger" onclick="toggleSidebar()" aria-label="Abrir menú lateral" title="Abre el menú de navegación">☰</button>
  <div class="logo">
    <div class="logo-ico">⚡</div>
    <div><h1>IT TOOLKIT</h1><p>// MOBILE PWA v5.0</p></div>
  </div>
  <span class="env-ind" id="envInd" aria-live="polite">GENERAL</span>
  <div class="srch-wrap" style="margin-left:16px;">
    <span class="si">🔍</span>
    <input type="text" id="gSearch" placeholder="Buscar comandos, herramientas, puertos..." autocomplete="off" role="combobox" aria-expanded="false" aria-controls="sDrop" aria-autocomplete="list" aria-label="Búsqueda global">
    <span class="kbd" style="position:absolute;right:9px;top:50%;transform:translateY(-50%)">Ctrl+K</span>
    <div class="srch-drop" id="sDrop" role="listbox" aria-label="Resultados de búsqueda"></div>
  </div>
</header>

<div class="sb-overlay" id="sbOverlay" onclick="toggleSidebar()"></div>
<div class="main">
<!-- SIDEBAR -->
<nav class="sidebar" id="sidebarNav" role="navigation" aria-label="Navegación principal">
  <div class="side-chip-wrap"><span class="side-chip" id="sideEnvChip">⚡ Filtro: General</span></div>
  <div class="s-ttl" role="heading" aria-level="2">// General</div>
  <div class="nav-item act" tabindex="0" role="menuitem" data-tip="Ir a la página principal" onclick="showSec('home')"><span class="n-ico">🏠</span> Inicio</div>
  <div class="nav-item" tabindex="0" role="menuitem" data-tip="Tus comandos marcados como favoritos" onclick="showSec('favs')"><span class="n-ico">⭐</span> Favoritos <span class="nav-badge fv" id="favCnt">0</span></div>
  <div class="nav-item" tabindex="0" role="menuitem" data-tip="Últimos 200 comandos que copiaste" onclick="showSec('hist')"><span class="n-ico">📂</span> Historial <span class="nav-badge" id="histCnt">0</span></div>
  <div class="n-div" role="separator"></div>
  <div class="s-ttl" role="heading" aria-level="2">// N1 — Helpdesk</div>
  <div class="nav-item" tabindex="0" role="menuitem" data-tip="Ping, DNS, traceroute, puertos, WiFi..." onclick="showSec('n1-red')"><span class="n-ico">🌐</span> Red &amp; Conectividad</div>
  <div class="nav-item" tabindex="0" role="menuitem" data-tip="Info ISO, updates, servicios, RDP, BitLocker..." onclick="showSec('n1-sis')"><span class="n-ico">💻</span> Sistema &amp; SO</div>
  <div class="nav-item" tabindex="0" role="menuitem" data-tip="Crear/editar usuarios, contraseñas, grupos..." onclick="showSec('n1-usr')"><span class="n-ico">👤</span> Usuarios &amp; Cuentas</div>
  <div class="nav-item" tabindex="0" role="menuitem" data-tip="Protocolos paso a paso para casos comunes" onclick="showSec('n1-chk')"><span class="n-ico">✅</span> Checklists</div>
  <div class="n-div" role="separator"></div>
  <div class="s-ttl" role="heading" aria-level="2">// N2 — Técnico</div>
  <div class="nav-item" tabindex="0" role="menuitem" data-tip="Particiones, SMART, TRIM, copias, permisos NTFS..." onclick="showSec('n2-disk')"><span class="n-ico">💾</span> Disco &amp; Storage</div>
  <div class="nav-item" tabindex="0" role="menuitem" data-tip="Top procesos, tareas programadas, servicios..." onclick="showSec('n2-proc')"><span class="n-ico">⚙️</span> Procesos &amp; Servicios</div>
  <div class="nav-item" tabindex="0" role="menuitem" data-tip="Event Viewer, tail logs, búsquedas, exportar..." onclick="showSec('n2-logs')"><span class="n-ico">📋</span> Logs &amp; Eventos</div>
  <div class="nav-item" tabindex="0" role="menuitem" data-tip="RDP, SSH, PowerShell Remoting, SCP..." onclick="showSec('n2-rem')"><span class="n-ico">🔗</span> Acceso Remoto</div>
  <div class="n-div" role="separator"></div>
  <div class="s-ttl" role="heading" aria-level="2">// N3 — Sysadmin</div>
  <div class="nav-item" tabindex="0" role="menuitem" data-tip="Usuarios, grupos, GPO, replicación, audit..." onclick="showSec('n3-ad')"><span class="n-ico">🏢</span> Active Directory</div>
  <div class="nav-item" tabindex="0" role="menuitem" data-tip="Firewall, Defender, puertos, certificados, UAC..." onclick="showSec('n3-sec')"><span class="n-ico">🔐</span> Seguridad</div>
  <div class="nav-item" tabindex="0" role="menuitem" data-tip="IIS, DNS, DHCP, Hyper-V, Docker, Exchange..." onclick="showSec('n3-srv')"><span class="n-ico">🖥️</span> Servidores &amp; VM</div>
  <div class="nav-item" tabindex="0" role="menuitem" data-tip="Scripts y funciones PowerShell reutilizables" onclick="showSec('n3-scr')"><span class="n-ico">📜</span> Scripts PowerShell</div>
  <div class="n-div" role="separator"></div>
  <div class="s-ttl" role="heading" aria-level="2">// Herramientas</div>
  <div class="nav-item" tabindex="0" role="menuitem" data-tip="Herramientas útiles en formato portable" onclick="showSec('tools')"><span class="n-ico">🧰</span> Software Portátil</div>
  <div class="nav-item" tabindex="0" role="menuitem" onclick="showSec('cheat')"><span class="n-ico">📌</span> Puertos &amp; Protocolos</div>
  <div class="nav-item" tabindex="0" role="menuitem" onclick="showSec('nettool')"><span class="n-ico">📡</span> Diagnóstico Red</div>
  <div class="n-div" role="separator"></div>
  <div class="s-ttl" role="heading" aria-level="2">// Funciones</div>
  <div class="nav-item" tabindex="0" role="menuitem" onclick="showSec('subnet')"><span class="n-ico">🔢</span> Calc. Subnets</div>
  <div class="nav-item" tabindex="0" role="menuitem" onclick="showSec('report')"><span class="n-ico">📄</span> Generador Reporte</div>
  <div class="nav-item" tabindex="0" role="menuitem" onclick="showSec('timer')"><span class="n-ico">⏱️</span> Timer SLA</div>
  <div class="nav-item" tabindex="0" role="menuitem" onclick="showSec('notes')"><span class="n-ico">📝</span> Mis Notas</div>
</nav>

<main class="content" id="mainContent">
<!-- HOME -->
<div id="home" class="sec act">
<div class="home-grid">
  <section class="hero-card">
    <div class="hero-badge">IT TOOLKIT v5 Mobile</div>
    <div class="hero-title">Operaciones sin friccion, soporte con metodo</div>
    <div class="hero-sub">// v5.0 · PWA responsive para helpdesk, sysadmin y NOC · Mobile-first</div>
    <div class="hero-ctas">
      <button class="btn btn-p" onclick="showSec('n1-red')">Abrir diagnostico</button>
      <button class="btn btn-n" onclick="showSec('tools')">Ver software</button>
    </div>
    <div class="hero-meta">Offline primero · Responsive PWA · Android & iOS ready</div>
  </section>
  <section class="stats-panel">
    <div class="stats-title">Actividad</div>
    <div class="stats-row">
      <div class="stat-c"><div class="stat-num" id="sC">0</div><div class="stat-lbl">Comandos</div></div>
      <div class="stat-c"><div class="stat-num">3</div><div class="stat-lbl">Sistemas OS</div></div>
      <div class="stat-c"><div class="stat-num">8</div><div class="stat-lbl">Entornos</div></div>
      <div class="stat-c"><div class="stat-num" id="sF">0</div><div class="stat-lbl">Favoritos</div></div>
      <div class="stat-c"><div class="stat-num" id="sH">0</div><div class="stat-lbl">Historial</div></div>
      <div class="stat-c"><div class="stat-num">0</div><div class="stat-lbl">Instalacion</div></div>
    </div>
  </section>
</div>

<div class="home-block">
  <div class="home-hdr">
    <div>
      <div class="home-kicker">Rutas rapidas</div>
      <div class="home-title">Accesos criticos</div>
    </div>
    <div class="home-pill">Saltos directos</div>
  </div>
  <div class="quick-grid">
  <div class="qc" onclick="showSec('n1-red')"><div class="qc-ico">🌐</div><div><div class="qc-t">Red</div><div class="qc-s">N1 · Helpdesk</div></div></div>
  <div class="qc" onclick="showSec('n3-ad')"><div class="qc-ico">🏢</div><div><div class="qc-t">Active Directory</div><div class="qc-s">N3 · Sysadmin</div></div></div>
  <div class="qc" onclick="showSec('n3-sec')"><div class="qc-ico">🔐</div><div><div class="qc-t">Seguridad</div><div class="qc-s">N3 · Sysadmin</div></div></div>
  <div class="qc" onclick="showSec('n3-scr')"><div class="qc-ico">📜</div><div><div class="qc-t">Scripts PS</div><div class="qc-s">Automatización</div></div></div>
  <div class="qc" onclick="showSec('subnet')"><div class="qc-ico">🔢</div><div><div class="qc-t">Calc. Subnets</div><div class="qc-s">Herramienta</div></div></div>
  <div class="qc" onclick="showSec('report')"><div class="qc-ico">📄</div><div><div class="qc-t">Reporte IT</div><div class="qc-s">Generador PDF</div></div></div>
  <div class="qc" onclick="showSec('timer')"><div class="qc-ico">⏱️</div><div><div class="qc-t">Timer SLA</div><div class="qc-s">Cronómetro</div></div></div>
  <div class="qc" onclick="showSec('cheat')"><div class="qc-ico">📌</div><div><div class="qc-t">Puertos</div><div class="qc-s">CheatSheet</div></div></div>
  <div class="qc" onclick="showSec('tools')"><div class="qc-ico">🧰</div><div><div class="qc-t">Software</div><div class="qc-s">Herramientas GUI</div></div></div>
  <div class="qc" onclick="showSec('nettool')"><div class="qc-ico">📡</div><div><div class="qc-t">Diagnóstico</div><div class="qc-s">Info de red</div></div></div>
</div>
  </div>

<div class="custom-layout" id="customCmds">
  <div class="custom-compose">
    <div class="custom-head">
      <div>
        <div class="custom-kicker">Composer</div>
        <div class="custom-title">Comandos personalizados</div>
        <div class="custom-sub">Crea comandos reutilizables y guardalos localmente.</div>
      </div>
      <div class="custom-meta">
        <div class="custom-count"><span id="customCount">0</span> comandos</div>
        <div class="custom-chip">LocalStorage</div>
      </div>
    </div>
    <div class="custom-form">
      <div class="ff">
        <label>Nombre de comando</label>
        <input type="text" id="cc-name" placeholder="Ej: Flush DNS remoto" maxlength="60">
      </div>
      <div class="ff" style="display:grid;grid-template-columns:1fr 140px;gap:10px;">
        <div>
          <label>Descripcion tecnica</label>
          <input type="text" id="cc-desc" placeholder="Que resuelve y cuando usar" maxlength="120">
        </div>
        <div>
          <label>Tag operativo</label>
          <input type="text" id="cc-tag" placeholder="DNS/NET" maxlength="16" list="cc-tag-list">
        </div>
      </div>
      <datalist id="cc-tag-list">
        <option value="DNS"></option>
        <option value="NET"></option>
        <option value="AD"></option>
        <option value="SEC"></option>
        <option value="VPN"></option>
        <option value="RDP"></option>
        <option value="SMTP"></option>
        <option value="DHCP"></option>
      </datalist>
      <div class="ff">
        <label>Seccion destino</label>
        <select id="cc-sec"></select>
      </div>
      <div class="ff">
        <label>Plataforma</label>
        <div class="os-opts">
          <label><input type="checkbox" id="cc-os-win" checked> WIN</label>
          <label><input type="checkbox" id="cc-os-lin"> LIN</label>
          <label><input type="checkbox" id="cc-os-mac"> MAC</label>
        </div>
      </div>
      <div class="ff">
        <label>Comandos</label>
        <textarea id="cc-code" placeholder="🪟 ipconfig /flushdns\n🐧 sudo systemd-resolve --flush-caches\n🍎 sudo dscacheutil -flushcache"></textarea>
      </div>
      <input type="hidden" id="cc-id" value="">
      <div class="f-actions">
        <button class="btn btn-p" onclick="saveCustomCmd()" title="Guardar el comando en tu colección local">Guardar</button>
        <button class="btn btn-n" onclick="clearCustomForm()" title="Limpiar el formulario">Limpiar</button>
      </div>
    </div>
  </div>
  <div class="custom-feed">
    <div class="custom-head">
      <div>
        <div class="custom-kicker">Coleccion</div>
        <div class="custom-title">Mis comandos</div>
        <div class="custom-sub">Edita o elimina cuando cambie el caso.</div>
      </div>
      <div class="custom-meta">
        <div class="custom-count"><span id="customCountFeed">0</span> items</div>
        <div class="custom-chip">Guardado local</div>
      </div>
    </div>
    <div class="f-actions" style="margin-bottom:14px;gap:8px;">
      <button class="btn" onclick="exportCustomCmds()" title="Descargar tus comandos como JSON para guardar en el pendrive">💾 Descargar Mis Comandos</button>
      <button class="btn" onclick="importCustomCmds()" title="Cargar comandos desde un archivo JSON (ideal para cambiar de equipo)">📤 Cargar Comandos</button>
    </div>
    <div id="customList"><div class="custom-empty">// Sin comandos personalizados</div></div>
  </div>
</div>
</div>

<!-- FAVS -->
<div id="favs" class="sec">
  <div class="sec-hdr"><h2>⭐ Favoritos</h2><p>// Pulsa ⭐ en cualquier comando para guardarlo aquí</p></div>
  <div id="favsContainer"><div class="fav-empty">// Sin favoritos — pulsa ⭐ en cualquier tarjeta</div></div>
</div>

<!-- HIST -->
<div id="hist" class="sec">
  <div class="sec-hdr"><h2>📂 Historial de Comandos</h2><p>// Registro automático de cada comando copiado con timestamp</p></div>
  <div class="hist-layout">
    <div class="hist-list">
      <div class="hist-hdr"><span class="panel-ttl">// Últimos Comandos</span><div style="display:flex;gap:5px"><button class="btn btn-s" onclick="exportHistory()">💾 CSV</button><button class="btn btn-d" onclick="clearHistory()">🗑️</button></div></div>
      <div id="histList"><div class="h-empty">// Aún no has copiado ningún comando</div></div>
    </div>
    <div class="stats-panel">
      <div class="panel-ttl">// Estadísticas</div>
      <div class="sr-item"><span class="sr-l">Total copiados</span><span class="sr-v" id="hs1">0</span></div>
      <div class="sr-item"><span class="sr-l">Hoy</span><span class="sr-v" id="hs2">0</span></div>
      <div class="sr-item"><span class="sr-l">Más usado</span><span class="sr-v" id="hs3">—</span></div>
      <div class="sr-item"><span class="sr-l">Sección top</span><span class="sr-v" id="hs4">—</span></div>
      <div class="sr-item"><span class="sr-l">OS más copiado</span><span class="sr-v" id="hs5">—</span></div>
    </div>
  </div>
</div>

<!-- N1: RED -->
<div id="n1-red" class="sec">
  <div class="sec-hdr"><div class="lvl l1">● N1 — Helpdesk</div><h2>🌐 Red &amp; Conectividad</h2><p>// diagnóstico de conexión, DNS, routing y puertos · separado por OS</p></div>
  <div class="os-tab-bar"><div class="os-tab on" onclick="osTab(this,'n1-red','all')">🌐 Todos <span class="tc">12</span></div><div class="os-tab" onclick="osTab(this,'n1-red','win')">🪟 Windows</div><div class="os-tab" onclick="osTab(this,'n1-red','lin')">🐧 Linux</div><div class="os-tab" onclick="osTab(this,'n1-red','mac')">🍎 macOS</div></div>
  <div class="cmd-grid" id="g-n1-red"></div>
</div>

<!-- N1: SISTEMA -->
<div id="n1-sis" class="sec">
  <div class="sec-hdr"><div class="lvl l1">● N1 — Helpdesk</div><h2>💻 Sistema &amp; SO</h2><p>// info del equipo, actualizaciones, arranque y hardware</p></div>
  <div class="cmd-grid" id="g-n1-sis"></div>
</div>

<!-- N1: USUARIOS -->
<div id="n1-usr" class="sec">
  <div class="sec-hdr"><div class="lvl l1">● N1 — Helpdesk</div><h2>👤 Usuarios &amp; Cuentas</h2><p>// gestión de cuentas locales, contraseñas y sesiones</p></div>
  <div class="cmd-grid" id="g-n1-usr"></div>
</div>

<!-- N1: CHECKLIST -->
<div id="n1-chk" class="sec">
  <div class="sec-hdr"><div class="lvl l1">● N1 — Helpdesk</div><h2>✅ Checklists de Soporte</h2><p>// protocolos paso a paso · haz clic para marcar completado</p></div>
  <div class="grp-ttl" style="--gc:var(--gr)">🌐 Problema de Conectividad</div>
  <div class="chklist" id="chk1">
    <div class="chi" onclick="chk(this)"><div class="chbox"></div><div><div class="chi-t">1. Verificar cable / señal WiFi</div><div class="chi-s">ping 127.0.0.1 → ping gateway → ping 8.8.8.8</div></div></div>
    <div class="chi" onclick="chk(this)"><div class="chbox"></div><div><div class="chi-t">2. Verificar IP asignada (DHCP vs estática)</div><div class="chi-s">ipconfig /all — buscar Default Gateway y Subnet Mask</div></div></div>
    <div class="chi" onclick="chk(this)"><div class="chbox"></div><div><div class="chi-t">3. Limpiar caché DNS y renovar IP</div><div class="chi-s">ipconfig /flushdns && ipconfig /release && /renew</div></div></div>
    <div class="chi" onclick="chk(this)"><div class="chbox"></div><div><div class="chi-t">4. Verificar resolución DNS</div><div class="chi-s">nslookup google.com 8.8.8.8 — probar DNS alternativo 1.1.1.1</div></div></div>
    <div class="chi" onclick="chk(this)"><div class="chbox"></div><div><div class="chi-t">5. Resetear pila TCP/IP</div><div class="chi-s">netsh winsock reset && netsh int ip reset → reiniciar</div></div></div>
    <div class="chi" onclick="chk(this)"><div class="chbox"></div><div><div class="chi-t">6. Verificar firewall / antivirus</div><div class="chi-s">Deshabilitar temporalmente y probar de nuevo</div></div></div>
    <div class="chi" onclick="chk(this)"><div class="chbox"></div><div><div class="chi-t">7. Comprobar proxy / VPN activos</div><div class="chi-s">Deshabilitar temporalmente y probar de nuevo</div></div></div>
  </div>
  <div class="grp-ttl" style="--gc:var(--or)">💻 PC Lento / Cuelga</div>
  <div class="chklist">
    <div class="chi" onclick="chk(this)"><div class="chbox"></div><div><div class="chi-t">1. Revisar CPU y RAM en Task Manager</div><div class="chi-s">Ctrl+Shift+Esc → Rendimiento y Procesos por CPU</div></div></div>
    <div class="chi" onclick="chk(this)"><div class="chbox"></div><div><div class="chi-t">2. Verificar espacio en disco (mínimo 15% libre)</div><div class="chi-s">Get-PSDrive C | Select Used,Free — limpiar temporales</div></div></div>
    <div class="chi" onclick="chk(this)"><div class="chbox"></div><div><div class="chi-t">3. Revisar programas en el arranque</div><div class="chi-s">msconfig → Inicio o Task Manager → Inicio</div></div></div>
    <div class="chi" onclick="chk(this)"><div class="chbox"></div><div><div class="chi-t">4. Escanear malware</div><div class="chi-s">Windows Defender full scan o Malwarebytes Portable</div></div></div>
    <div class="chi" onclick="chk(this)"><div class="chbox"></div><div><div class="chi-t">5. Verificar temperatura de CPU/GPU</div><div class="chi-s">HWMonitor o HWiNFO portable — limpiar polvo si físico</div></div></div>
    <div class="chi" onclick="chk(this)"><div class="chbox"></div><div><div class="chi-t">6. Revisar estado del disco con SMART</div><div class="chi-s">CrystalDiskInfo portable o chkdsk C:</div></div></div>
  </div>
  <div class="grp-ttl" style="--gc:var(--pu)">🔑 Usuario No Puede Iniciar Sesión AD</div>
  <div class="chklist">
    <div class="chi" onclick="chk(this)"><div class="chbox"></div><div><div class="chi-t">1. Verificar Bloq Mayús / idioma del teclado</div><div class="chi-s">Probar con teclado en pantalla (osk.exe)</div></div></div>
    <div class="chi" onclick="chk(this)"><div class="chbox"></div><div><div class="chi-t">2. Comprobar si cuenta bloqueada en AD</div><div class="chi-s">Get-ADUser USUARIO -Properties LockedOut,LastBadPasswordAttempt</div></div></div>
    <div class="chi" onclick="chk(this)"><div class="chbox"></div><div><div class="chi-t">3. Verificar conectividad con DC</div><div class="chi-s">nltest /sc_verify:DOMINIO y nltest /dsgetdc:DOMINIO</div></div></div>
    <div class="chi" onclick="chk(this)"><div class="chbox"></div><div><div class="chi-t">4. Revisar logs seguridad (Event ID 4625)</div><div class="chi-s">eventvwr → Security → filtrar por EventID 4625</div></div></div>
    <div class="chi" onclick="chk(this)"><div class="chbox"></div><div><div class="chi-t">5. Intentar login con cuenta local de administrador</div><div class="chi-s">.\Administrator o NOMBREPC\Administrador</div></div></div>
    <div class="chi" onclick="chk(this)"><div class="chbox"></div><div><div class="chi-t">6. Verificar caducidad de contraseña</div><div class="chi-s">Get-ADUser USUARIO -Properties PasswordExpired,PasswordLastSet</div></div></div>
  </div>
  <div style="display:flex;gap:8px;margin-top:12px;">
    <button class="btn btn-n" onclick="resetChks()">↺ Resetear todos</button>
  </div>
</div>

<!-- N2: DISCO -->
<div id="n2-disk" class="sec">
  <div class="sec-hdr"><div class="lvl l2">● N2 — Técnico</div><h2>💾 Disco &amp; Storage</h2><p>// particiones, espacio, SMART, permisos y sistema de archivos</p></div>
  <div class="cmd-grid" id="g-n2-disk"></div>
</div>

<!-- N2: PROCESOS -->
<div id="n2-proc" class="sec">
  <div class="sec-hdr"><div class="lvl l2">● N2 — Técnico</div><h2>⚙️ Procesos &amp; Servicios</h2><p>// gestión de procesos, servicios y tareas programadas</p></div>
  <div class="cmd-grid" id="g-n2-proc"></div>
</div>

<!-- N2: LOGS -->
<div id="n2-logs" class="sec">
  <div class="sec-hdr"><div class="lvl l2">● N2 — Técnico</div><h2>📋 Logs &amp; Eventos</h2><p>// visor de eventos, análisis de logs y auditoría del sistema</p></div>
  <div class="cmd-grid" id="g-n2-logs"></div>
</div>

<!-- N2: REMOTO -->
<div id="n2-rem" class="sec">
  <div class="sec-hdr"><div class="lvl l2">● N2 — Técnico</div><h2>🔗 Acceso Remoto</h2><p>// RDP, SSH, WinRM y gestión de equipos remotos</p></div>
  <div class="cmd-grid" id="g-n2-rem"></div>
</div>

<!-- N3: AD -->
<div id="n3-ad" class="sec">
  <div class="sec-hdr"><div class="lvl l3">● N3 — Sysadmin</div><h2>🏢 Active Directory</h2><p>// usuarios, grupos, GPO, OUs, replicación y domain health</p></div>
  <div class="cmd-grid" id="g-n3-ad"></div>
</div>

<!-- N3: SEGURIDAD -->
<div id="n3-sec" class="sec">
  <div class="sec-hdr"><div class="lvl l3">● N3 — Sysadmin</div><h2>🔐 Seguridad</h2><p>// firewall, certificados, auditoría, antivirus y detección de amenazas</p></div>
  <div class="cmd-grid" id="g-n3-sec"></div>
</div>

<!-- N3: SERVIDORES -->
<div id="n3-srv" class="sec">
  <div class="sec-hdr"><div class="lvl l3">● N3 — Sysadmin</div><h2>🖥️ Servidores &amp; Virtualización</h2><p>// IIS, DNS, DHCP, Hyper-V, Docker, Exchange y M365</p></div>
  <div class="cmd-grid" id="g-n3-srv"></div>
</div>

<!-- N3: SCRIPTS -->
<div id="n3-scr" class="sec">
  <div class="sec-hdr"><div class="lvl l3">● N3 — Sysadmin</div><h2>📜 Scripts PowerShell</h2><p>// scripts listos para copiar, adaptar y ejecutar en tu entorno</p></div>
  <div class="cmd-grid" id="g-n3-scr"></div>
</div>
<!-- TOOLS -->
<div id="tools" class="sec">
  <div class="sec-hdr"><div class="lvl la">● HERRAMIENTAS</div><h2>🧰 Software Portátil</h2><p>// herramientas que puedes llevar en el pendrive sin instalación · filtra por entorno y OS</p></div>
  
  <!-- TOOLS FILTER BAR -->
  <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:18px;padding:12px 16px;background:var(--bg2);border:1px solid var(--bd);border-radius:var(--r);">
    <div style="display:flex;align-items:center;gap:8px;flex-shrink:0;">
      <span style="font-size:11px;font-family:var(--mono);color:var(--tx3);letter-spacing:1px;text-transform:uppercase;">🎯 Entorno:</span>
      <select id="toolEnvFilter" onchange="filterTools()" style="background:var(--bg3);border:1px solid var(--bd);color:var(--tx);padding:6px 10px;font-family:var(--mono);font-size:11px;outline:none;border-radius:var(--r);cursor:pointer;transition:all .2s;">
        <option value="all">⚡ Todos los entornos</option>
        <option value="general">⚡ General / Helpdesk</option>
        <option value="win">🪟 Windows</option>
        <option value="lin">🐧 Linux / Unix</option>
        <option value="mac">🍎 macOS</option>
        <option value="ad">🏢 Active Directory</option>
        <option value="corp">🏛️ Corporativo / M365</option>
        <option value="sd">🎧 Service Desk</option>
        <option value="sec">🔐 Seguridad</option>
        <option value="net">📡 Redes</option>
        <option value="dev">⚙️ DevOps / Servidores</option>
      </select>
    </div>
    <div style="display:flex;align-items:center;gap:8px;flex-shrink:0;">
      <span style="font-size:11px;font-family:var(--mono);color:var(--tx3);letter-spacing:1px;text-transform:uppercase;">💻 OS:</span>
      <select id="toolOsFilter" onchange="filterTools()" style="background:var(--bg3);border:1px solid var(--bd);color:var(--tx);padding:6px 10px;font-family:var(--mono);font-size:11px;outline:none;border-radius:var(--r);cursor:pointer;transition:all .2s;">
        <option value="all">🌐 Todos</option>
        <option value="win">🪟 Windows</option>
        <option value="lin">🐧 Linux</option>
        <option value="mac">🍎 macOS</option>
      </select>
    </div>
    <div style="display:flex;align-items:center;gap:8px;flex-shrink:0;">
      <span style="font-size:11px;font-family:var(--mono);color:var(--tx3);letter-spacing:1px;text-transform:uppercase;">💰 Precio:</span>
      <select id="toolPriceFilter" onchange="filterTools()" style="background:var(--bg3);border:1px solid var(--bd);color:var(--tx);padding:6px 10px;font-family:var(--mono);font-size:11px;outline:none;border-radius:var(--r);cursor:pointer;transition:all .2s;">
        <option value="all">Todo</option>
        <option value="free">✅ Solo Gratuitas</option>
        <option value="paid">💼 Incluye de Pago</option>
      </select>
    </div>
    <div style="margin-left:auto;font-family:var(--mono);font-size:10px;color:var(--tx3);">Mostrando: <span id="toolCount" style="color:var(--ea);">0</span> herramientas</div>
  </div>

  <!-- ALL TOOLS DATA (filterable) -->
  <div id="toolsContainer" class="tools-grid">
  </div><!-- toolsContainer populated by JS below -->
</div>

<!-- CHEATSHEET -->
<div id="cheat" class="sec">
  <div class="sec-hdr"><div class="lvl la">● HERRAMIENTAS</div><h2>📌 Puertos &amp; Protocolos</h2><p>// referencia rápida de puertos TCP/UDP comunes · haz clic en el número para copiar</p></div>
  <div class="cheat-grid">
    <div class="cheat-box">
      <div class="cheat-h4">🌐 Web &amp; HTTP</div>
      <div class="ch-row"><span class="cheat-label">HTTP</span><span class="cheat-val" onclick="copyTxt(this)">80/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">HTTPS</span><span class="cheat-val" onclick="copyTxt(this)">443/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">HTTP Alt</span><span class="cheat-val" onclick="copyTxt(this)">8080/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">HTTPS Alt</span><span class="cheat-val" onclick="copyTxt(this)">8443/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">WebSocket</span><span class="cheat-val" onclick="copyTxt(this)">80/443</span></div>
    </div>
    <div class="cheat-box">
      <div class="cheat-h4">📧 Email</div>
      <div class="ch-row"><span class="cheat-label">SMTP</span><span class="cheat-val" onclick="copyTxt(this)">25/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">SMTP TLS</span><span class="cheat-val" onclick="copyTxt(this)">587/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">SMTPS</span><span class="cheat-val" onclick="copyTxt(this)">465/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">POP3</span><span class="cheat-val" onclick="copyTxt(this)">110/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">POP3S</span><span class="cheat-val" onclick="copyTxt(this)">995/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">IMAP</span><span class="cheat-val" onclick="copyTxt(this)">143/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">IMAPS</span><span class="cheat-val" onclick="copyTxt(this)">993/TCP</span></div>
    </div>
    <div class="cheat-box">
      <div class="cheat-h4">📁 Archivos &amp; Transferencia</div>
      <div class="ch-row"><span class="cheat-label">FTP</span><span class="cheat-val" onclick="copyTxt(this)">21/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">FTP Datos</span><span class="cheat-val" onclick="copyTxt(this)">20/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">FTPS</span><span class="cheat-val" onclick="copyTxt(this)">990/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">SFTP/SSH</span><span class="cheat-val" onclick="copyTxt(this)">22/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">SMB/CIFS</span><span class="cheat-val" onclick="copyTxt(this)">445/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">NetBIOS</span><span class="cheat-val" onclick="copyTxt(this)">137-139</span></div>
      <div class="ch-row"><span class="cheat-label">TFTP</span><span class="cheat-val" onclick="copyTxt(this)">69/UDP</span></div>
    </div>
    <div class="cheat-box">
      <div class="cheat-h4">🏢 Active Directory &amp; Windows</div>
      <div class="ch-row"><span class="cheat-label">LDAP</span><span class="cheat-val" onclick="copyTxt(this)">389/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">LDAPS</span><span class="cheat-val" onclick="copyTxt(this)">636/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">Kerberos</span><span class="cheat-val" onclick="copyTxt(this)">88/TCP+UDP</span></div>
      <div class="ch-row"><span class="cheat-label">Global Catalog</span><span class="cheat-val" onclick="copyTxt(this)">3268/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">GC SSL</span><span class="cheat-val" onclick="copyTxt(this)">3269/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">RPC Endpoint</span><span class="cheat-val" onclick="copyTxt(this)">135/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">WinRM HTTP</span><span class="cheat-val" onclick="copyTxt(this)">5985/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">WinRM HTTPS</span><span class="cheat-val" onclick="copyTxt(this)">5986/TCP</span></div>
    </div>
    <div class="cheat-box">
      <div class="cheat-h4">🔗 Acceso Remoto</div>
      <div class="ch-row"><span class="cheat-label">RDP</span><span class="cheat-val" onclick="copyTxt(this)">3389/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">VNC</span><span class="cheat-val" onclick="copyTxt(this)">5900/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">TeamViewer</span><span class="cheat-val" onclick="copyTxt(this)">5938/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">Telnet</span><span class="cheat-val" onclick="copyTxt(this)">23/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">SSH</span><span class="cheat-val" onclick="copyTxt(this)">22/TCP</span></div>
    </div>
    <div class="cheat-box">
      <div class="cheat-h4">🌐 Red &amp; Infraestructura</div>
      <div class="ch-row"><span class="cheat-label">DNS</span><span class="cheat-val" onclick="copyTxt(this)">53/TCP+UDP</span></div>
      <div class="ch-row"><span class="cheat-label">DHCP Srv</span><span class="cheat-val" onclick="copyTxt(this)">67/UDP</span></div>
      <div class="ch-row"><span class="cheat-label">DHCP Cli</span><span class="cheat-val" onclick="copyTxt(this)">68/UDP</span></div>
      <div class="ch-row"><span class="cheat-label">NTP</span><span class="cheat-val" onclick="copyTxt(this)">123/UDP</span></div>
      <div class="ch-row"><span class="cheat-label">SNMP</span><span class="cheat-val" onclick="copyTxt(this)">161/UDP</span></div>
      <div class="ch-row"><span class="cheat-label">Syslog</span><span class="cheat-val" onclick="copyTxt(this)">514/UDP</span></div>
      <div class="ch-row"><span class="cheat-label">RADIUS</span><span class="cheat-val" onclick="copyTxt(this)">1812/UDP</span></div>
    </div>
    <div class="cheat-box">
      <div class="cheat-h4">🗄️ Bases de Datos</div>
      <div class="ch-row"><span class="cheat-label">SQL Server</span><span class="cheat-val" onclick="copyTxt(this)">1433/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">MySQL</span><span class="cheat-val" onclick="copyTxt(this)">3306/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">PostgreSQL</span><span class="cheat-val" onclick="copyTxt(this)">5432/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">MongoDB</span><span class="cheat-val" onclick="copyTxt(this)">27017/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">Redis</span><span class="cheat-val" onclick="copyTxt(this)">6379/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">ElasticSearch</span><span class="cheat-val" onclick="copyTxt(this)">9200/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">Oracle</span><span class="cheat-val" onclick="copyTxt(this)">1521/TCP</span></div>
    </div>
    <div class="cheat-box">
      <div class="cheat-h4">📦 DevOps &amp; Cloud</div>
      <div class="ch-row"><span class="cheat-label">Docker API</span><span class="cheat-val" onclick="copyTxt(this)">2375/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">Docker TLS</span><span class="cheat-val" onclick="copyTxt(this)">2376/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">Kubernetes</span><span class="cheat-val" onclick="copyTxt(this)">6443/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">Prometheus</span><span class="cheat-val" onclick="copyTxt(this)">9090/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">Grafana</span><span class="cheat-val" onclick="copyTxt(this)">3000/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">Jenkins</span><span class="cheat-val" onclick="copyTxt(this)">8080/TCP</span></div>
      <div class="ch-row"><span class="cheat-label">Consul</span><span class="cheat-val" onclick="copyTxt(this)">8500/TCP</span></div>
    </div>
  </div>
</div>

<!-- NET TOOLS -->
<div id="nettool" class="sec">
  <div class="sec-hdr"><div class="lvl la">● HERRAMIENTAS</div><h2>📡 Diagnóstico de Red</h2><p>// referencia de comandos de diagnóstico y análisis para todos los OS</p></div>
  <div class="net-info-grid">
    <div class="ninfo-card">
      <div class="ninfo-title">🔵 Ping &amp; Conectividad</div>
      <div class="ninfo-row"><span class="ninfo-lbl">Ping continuo Windows</span><span class="ninfo-val">ping -t HOST</span></div>
      <div class="ninfo-row"><span class="ninfo-lbl">Ping con tamaño pkt</span><span class="ninfo-val">ping -l 1400 HOST</span></div>
      <div class="ninfo-row"><span class="ninfo-lbl">Ping ipv6</span><span class="ninfo-val">ping -6 HOST</span></div>
      <div class="ninfo-row"><span class="ninfo-lbl">Ping Linux count</span><span class="ninfo-val">ping -c 10 HOST</span></div>
      <div class="ninfo-row"><span class="ninfo-lbl">Test-NetConnection PS</span><span class="ninfo-val">TNC host -Port 80</span></div>
    </div>
    <div class="ninfo-card">
      <div class="ninfo-title">🗺️ Traceroute &amp; MTR</div>
      <div class="ninfo-row"><span class="ninfo-lbl">Traceroute Windows</span><span class="ninfo-val">tracert -d HOST</span></div>
      <div class="ninfo-row"><span class="ninfo-lbl">Traceroute Linux</span><span class="ninfo-val">traceroute -n HOST</span></div>
      <div class="ninfo-row"><span class="ninfo-lbl">MTR (tiempo real)</span><span class="ninfo-val">mtr --report HOST</span></div>
      <div class="ninfo-row"><span class="ninfo-lbl">PathPing Windows</span><span class="ninfo-val">pathping HOST</span></div>
    </div>
    <div class="ninfo-card">
      <div class="ninfo-title">🔍 DNS &amp; Resolución</div>
      <div class="ninfo-row"><span class="ninfo-lbl">nslookup Windows</span><span class="ninfo-val">nslookup HOST</span></div>
      <div class="ninfo-row"><span class="ninfo-lbl">dig Linux/Mac</span><span class="ninfo-val">dig HOST @8.8.8.8</span></div>
      <div class="ninfo-row"><span class="ninfo-lbl">Reverse lookup</span><span class="ninfo-val">dig -x IP</span></div>
      <div class="ninfo-row"><span class="ninfo-lbl">Ver TTL DNS</span><span class="ninfo-val">dig HOST +ttlid</span></div>
      <div class="ninfo-row"><span class="ninfo-lbl">Check registro MX</span><span class="ninfo-val">dig HOST MX</span></div>
    </div>
    <div class="ninfo-card">
      <div class="ninfo-title">📊 Estadísticas &amp; Capturas</div>
      <div class="ninfo-row"><span class="ninfo-lbl">Captura tcpdump</span><span class="ninfo-val">tcpdump -i eth0 -w file.pcap</span></div>
      <div class="ninfo-row"><span class="ninfo-lbl">Filtro puerto</span><span class="ninfo-val">tcpdump port 443</span></div>
      <div class="ninfo-row"><span class="ninfo-lbl">Netstat stats</span><span class="ninfo-val">netstat -s | findstr TCP</span></div>
      <div class="ninfo-row"><span class="ninfo-lbl">Bandwidth Linux</span><span class="ninfo-val">iftop -i eth0</span></div>
      <div class="ninfo-row"><span class="ninfo-lbl">Speed test CLI</span><span class="ninfo-val">curl -s speedtest.net/speedtest</span></div>
    </div>
    <div class="ninfo-card">
      <div class="ninfo-title">📋 IPs Especiales</div>
      <div class="ninfo-row"><span class="ninfo-lbl">Loopback</span><span class="ninfo-val">127.0.0.1 / ::1</span></div>
      <div class="ninfo-row"><span class="ninfo-lbl">APIPA (sin DHCP)</span><span class="ninfo-val">169.254.x.x</span></div>
      <div class="ninfo-row"><span class="ninfo-lbl">Broadcast</span><span class="ninfo-val">255.255.255.255</span></div>
      <div class="ninfo-row"><span class="ninfo-lbl">DNS Google</span><span class="ninfo-val">8.8.8.8 / 8.8.4.4</span></div>
      <div class="ninfo-row"><span class="ninfo-lbl">DNS Cloudflare</span><span class="ninfo-val">1.1.1.1 / 1.0.0.1</span></div>
      <div class="ninfo-row"><span class="ninfo-lbl">DNS OpenDNS</span><span class="ninfo-val">208.67.222.222</span></div>
    </div>
    <div class="ninfo-card">
      <div class="ninfo-title">🔐 SSL &amp; Certificados</div>
      <div class="ninfo-row"><span class="ninfo-lbl">Check cert SSL</span><span class="ninfo-val">openssl s_client -connect HOST:443</span></div>
      <div class="ninfo-row"><span class="ninfo-lbl">Fecha expiración</span><span class="ninfo-val">openssl s_client -connect HOST:443 | openssl x509 -noout -dates</span></div>
      <div class="ninfo-row"><span class="ninfo-lbl">Curl con SSL debug</span><span class="ninfo-val">curl -vI https://HOST</span></div>
    </div>
  </div>
</div>

<!-- SUBNET CALC -->
<div id="subnet" class="sec">
  <div class="sec-hdr"><div class="lvl la">● FUNCIÓN</div><h2>🔢 Calculadora de Subnets</h2><p>// calcula red, broadcast, máscara, hosts y rangos CIDR</p></div>
  <div class="sub-card">
    <div class="input-row">
      <div class="field"><label>Dirección IP</label><input type="text" id="ip-in" placeholder="192.168.1.100" value="192.168.1.100"></div>
      <div class="field"><label>Prefijo CIDR</label><select id="cidr-in"></select></div>
      <button class="calc-btn" onclick="calcSubnet()">⚡ CALCULAR</button>
    </div>
    <div class="sub-results" id="sub-results" style="display:none">
      <div class="res-box"><div class="res-lbl">Dirección de Red</div><div class="result-val" id="r-net" onclick="copyTxt(this)">—</div></div>
      <div class="res-box"><div class="res-lbl">Broadcast</div><div class="result-val" id="r-bc" onclick="copyTxt(this)">—</div></div>
      <div class="res-box"><div class="res-lbl">Máscara</div><div class="result-val" id="r-mask" onclick="copyTxt(this)">—</div></div>
      <div class="res-box"><div class="res-lbl">Wildcard</div><div class="result-val" id="r-wild" onclick="copyTxt(this)">—</div></div>
      <div class="res-box"><div class="res-lbl">Primer Host</div><div class="result-val" id="r-first" onclick="copyTxt(this)">—</div></div>
      <div class="res-box"><div class="res-lbl">Último Host</div><div class="result-val" id="r-last" onclick="copyTxt(this)">—</div></div>
      <div class="res-box"><div class="res-lbl">Total Hosts</div><div class="result-val" id="r-hosts" onclick="copyTxt(this)">—</div></div>
      <div class="res-box"><div class="res-lbl">IP en Binario</div><div class="result-val" id="r-bin" onclick="copyTxt(this)" style="font-size:9px">—</div></div>
    </div>
  </div>
  <div class="sub-card">
    <div class="panel-ttl">// Referencia CIDR</div>
    <table class="cidr-tbl">
      <thead><tr><th>CIDR</th><th>Máscara</th><th>Hosts Útiles</th><th>Rango</th></tr></thead>
      <tbody id="cidr-tbody"></tbody>
    </table>
  </div>
</div>

<!-- REPORT -->
<div id="report" class="sec">
  <div class="sec-hdr"><div class="lvl la">● FUNCIÓN</div><h2>📄 Generador de Reporte IT</h2><p>// crea informes de incidencia profesionales con exportación PDF/TXT</p></div>
  <div class="rep-layout">
    <div class="rep-panel">
      <div class="panel-ttl">// Datos del Incidente</div>
      <div class="ff"><label>Técnico</label><input type="text" id="r-tec" placeholder="Tu nombre"></div>
      <div class="ff"><label>ID Ticket</label><input type="text" id="r-tick" placeholder="INC-2024-001"></div>
      <div class="ff"><label>Usuario Afectado</label><input type="text" id="r-usr" placeholder="usuario@empresa.com"></div>
      <div class="ff"><label>Equipo / Activo</label><input type="text" id="r-equip" placeholder="PC-VENTAS-01"></div>
      <div class="ff"><label>Prioridad</label><select id="r-pri"><option>🔴 Crítica</option><option>🟠 Alta</option><option selected>🟡 Media</option><option>🟢 Baja</option></select></div>
      <div class="ff"><label>Categoría</label><select id="r-cat"><option>Red / Conectividad</option><option>Hardware</option><option>Software</option><option>Active Directory</option><option>Email / M365</option><option>Seguridad</option><option>Impresión</option><option>Otro</option></select></div>
      <div class="ff"><label>Descripción del Problema</label><textarea id="r-desc" placeholder="Describe el problema reportado por el usuario..."></textarea></div>
      <div class="ff"><label>Pasos Realizados</label><textarea id="r-steps" placeholder="1. Verificar conectividad...&#10;2. Revisar logs..."></textarea></div>
      <div class="ff"><label>Solución Aplicada</label><textarea id="r-sol" placeholder="Se realizó..."></textarea></div>
      <div class="ff"><label>Estado</label><select id="r-stat"><option>✅ Resuelto</option><option>🔄 En Progreso</option><option>⏳ Pendiente Usuario</option><option>🔁 Escalado N2/N3</option></select></div>
      <div class="f-actions">
        <button class="btn btn-p" onclick="genReport()">⚡ Generar</button>
        <button class="btn btn-s" onclick="printReport()">🖨️ PDF</button>
        <button class="btn btn-n" onclick="exportTxt()">💾 TXT</button>
        <button class="btn btn-d" onclick="clearReport()">🗑️ Limpiar</button>
      </div>
    </div>
    <div class="rep-panel">
      <div class="panel-ttl">// Vista Previa del Reporte</div>
      <div id="rep-out">// Completa el formulario y pulsa ⚡ Generar</div>
    </div>
  </div>
</div>

<!-- TIMER SLA -->
<div id="timer" class="sec">
  <div class="sec-hdr"><div class="lvl la">● FUNCIÓN</div><h2>⏱️ Timer SLA de Incidentes</h2><p>// cronómetro para medir tiempo de resolución vs SLA comprometido</p></div>
  <div class="timer-layout">
    <div class="timer-panel">
      <div class="t-lbl">// TIEMPO TRANSCURRIDO</div>
      <div class="timer-disp" id="tDisp">00:00:00</div>
      <div class="sla-ind sla-ok" id="slaInd">SLA OK</div>
      <div class="t-meta">
        <input type="text" id="t-inc" placeholder="Descripción del incidente">
        <select id="t-sev">
          <option value="4">🔴 Crítico (SLA: 4h)</option>
          <option value="8" selected>🟠 Alto (SLA: 8h)</option>
          <option value="24">🟡 Medio (SLA: 24h)</option>
          <option value="72">🟢 Bajo (SLA: 72h)</option>
        </select>
      </div>
      <div class="t-ctrls">
        <button class="t-btn tb-s" onclick="startTimer()">▶ Iniciar</button>
        <button class="t-btn tb-p" onclick="pauseTimer()">⏸ Pausa</button>
        <button class="t-btn tb-st" onclick="stopTimer()">⏹ Registrar</button>
      </div>
    </div>
    <div class="inc-panel">
      <div class="panel-ttl" style="margin-bottom:12px">// Incidentes Registrados</div>
      <div id="incList"><div style="color:var(--tx3);font-family:var(--mono);font-size:11px;padding:20px 0;text-align:center">// Sin incidentes registrados</div></div>
    </div>
  </div>
</div>

<!-- NOTES -->
<div id="notes" class="sec">
  <div class="sec-hdr"><div class="lvl la">● FUNCIÓN</div><h2>📝 Mis Notas</h2><p>// notas persistentes en el navegador · se guardan automáticamente</p></div>
  <div class="notes-layout">
    <div class="notes-form">
      <div class="panel-ttl">// Nueva Nota</div>
      <div class="ff"><label>Título</label><input type="text" id="n-title" placeholder="Título de la nota"></div>
      <div class="ff"><label>Contenido</label><textarea id="n-body" placeholder="Escribe aquí..." style="min-height:180px"></textarea></div>
      <div class="f-actions">
        <button class="btn btn-p" onclick="saveNote()">💾 Guardar</button>
        <button class="btn btn-s" onclick="exportNotas()">📤 Exportar</button>
        <button class="btn btn-n" onclick="importNotas()">📥 Importar</button>
        <input type="file" id="n-import" style="display:none" accept=".json" onchange="importNotasFile(this)">
      </div>
    </div>
    <div class="notes-list">
      <div class="panel-ttl">// Notas Guardadas <span id="noteCnt" style="color:var(--tx3);font-size:9px"></span></div>
      <div id="notesList"><div style="color:var(--tx3);font-family:var(--mono);font-size:11px;padding:20px 0;text-align:center">// Sin notas guardadas</div></div>
    </div>
  </div>
</div>

</main>
</div>

<button class="scroll-top" id="scrollTopBtn" onclick="window.scrollTo({top:0,behavior:'smooth'})" aria-label="Volver arriba" data-tip="Arriba">↑</button>
<div id="toast" role="alert" aria-live="assertive"></div>

<script>
// ═══════════════════════════════════════════
// SCHEMA VERSIONING
// ═══════════════════════════════════════════
const ITK_SCHEMA_VERSION = 2;
const ITK_SCHEMA_KEY = 'itk_schema_v';

function migrateStorage() {
  try {
    const stored = parseInt(localStorage.getItem(ITK_SCHEMA_KEY) || '0');
    if (stored >= ITK_SCHEMA_VERSION) return;
    // v0/v1 → v2: validate all JSON arrays, remove corrupted data
    if (stored < 2) {
      ['itk_favs','itk_history','itk_notes','itk_incidents','itk_custom_cmds'].forEach(key => {
        try {
          const val = localStorage.getItem(key);
          if (val !== null) {
            const parsed = JSON.parse(val);
            if (!Array.isArray(parsed)) localStorage.removeItem(key);
          }
        } catch(e) { localStorage.removeItem(key); }
      });
    }
    localStorage.setItem(ITK_SCHEMA_KEY, String(ITK_SCHEMA_VERSION));
    console.info('✅ ITK migrado a schema v' + ITK_SCHEMA_VERSION);
  } catch(e) { console.warn('⚠️ migrateStorage:', e); }
}

// ═══════════════════════════════════════════
// SMOKE TESTS
// ═══════════════════════════════════════════
function smokeTest() {
  const errors = [];
  // Critical DOM elements
  ['envInd','gSearch','sDrop','toast','home','favCnt','histCnt','sideEnvChip','toolsContainer'].forEach(id => {
    if (!document.getElementById(id)) errors.push('DOM #' + id + ' no encontrado');
  });
  // localStorage availability
  try { localStorage.setItem('itk_test','1'); localStorage.removeItem('itk_test'); }
  catch(e) { errors.push('localStorage no disponible'); }
  // Critical functions
  ['setEnv','showSec','cpCmd','toggleFav','calcSubnet','genReport','filterTools','backupAll'].forEach(fn => {
    if (typeof window[fn] !== 'function') errors.push('Función no definida: ' + fn);
  });
  // Sections exist for every sidebar nav item
  document.querySelectorAll('.nav-item[onclick]').forEach(item => {
    const m = (item.getAttribute('onclick') || '').match(/showSec\('([^']+)'\)/);
    if (m && !document.getElementById(m[1])) errors.push('Sección #' + m[1] + ' no encontrada');
  });
  // Dynamic cards rendered
  const renderedCards = document.querySelectorAll('.cmd-card').length;
  const totalCmds = COMMANDS_DB.length + (Array.isArray(CUSTOM_CMDS) ? CUSTOM_CMDS.length : 0);
  if (renderedCards !== totalCmds) errors.push('Cards renderizadas (' + renderedCards + ') ≠ COMMANDS_DB+Custom (' + totalCmds + ')');
  // Phase 3: UI/UX elements
  ['scrollTopBtn','scrollProg','sidebarNav','sbOverlay','mainContent'].forEach(id => {
    if (!document.getElementById(id)) errors.push('Phase3 DOM #' + id + ' no encontrado');
  });
  ['toggleSidebar','animateCounters'].forEach(fn => {
    if (typeof window[fn] !== 'function') errors.push('Phase3 función no definida: ' + fn);
  });
  if (errors.length) {
    console.warn('⚠️ ITK Smoke Test — ' + errors.length + ' problema(s):', errors);
    toast('⚠️ ' + errors.length + ' problema(s) detectado(s) — ver consola (F12)');
  } else {
    console.info('✅ ITK Smoke Test OK — 0 problemas');
  }
  return errors;
}

// ═══════════════════════════════════════════
// UNIFIED BACKUP / RESTORE
// ═══════════════════════════════════════════
function backupAll() {
  try {
    const data = {
      _itk_backup: true,
      _version: ITK_SCHEMA_VERSION,
      _date: new Date().toISOString(),
      env: localStorage.getItem('itk_env') || 'default',
      theme: localStorage.getItem('itk_theme') || 'dark',
      favs: JSON.parse(localStorage.getItem('itk_favs') || '[]'),
      history: JSON.parse(localStorage.getItem('itk_history') || '[]'),
      notes: JSON.parse(localStorage.getItem('itk_notes') || '[]'),
      incidents: JSON.parse(localStorage.getItem('itk_incidents') || '[]'),
      customCmds: JSON.parse(localStorage.getItem('itk_custom_cmds') || '[]')
    };
    const d = new Date().toISOString().slice(0,10);
    dlFile('itk_backup_' + d + '.json', JSON.stringify(data, null, 2), 'application/json');
    toast('💾 Backup completo exportado (' + (data.favs.length + data.history.length + data.notes.length + data.incidents.length + data.customCmds.length) + ' registros)');
  } catch(e) { toast('⚠️ Error al generar backup'); }
}

function restoreAll() {
  document.getElementById('backup-import').click();
}

function restoreAllFile(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (!data._itk_backup) { toast('⚠️ Archivo no es un backup válido de ITK'); return; }
      if (!confirm('¿Restaurar backup del ' + (data._date || '?').slice(0,10) + '?\nSe reemplazarán TODOS los datos actuales (favoritos, historial, notas, incidentes, entorno y tema).')) return;
      if (data.env) localStorage.setItem('itk_env', data.env);
      if (data.theme) localStorage.setItem('itk_theme', data.theme);
      if (Array.isArray(data.favs)) localStorage.setItem('itk_favs', JSON.stringify(data.favs));
      if (Array.isArray(data.history)) localStorage.setItem('itk_history', JSON.stringify(data.history));
      if (Array.isArray(data.notes)) localStorage.setItem('itk_notes', JSON.stringify(data.notes));
      if (Array.isArray(data.incidents)) localStorage.setItem('itk_incidents', JSON.stringify(data.incidents));
      if (Array.isArray(data.customCmds)) localStorage.setItem('itk_custom_cmds', JSON.stringify(data.customCmds));
      localStorage.setItem(ITK_SCHEMA_KEY, String(data._version || ITK_SCHEMA_VERSION));
      toast('✅ Backup restaurado — recargando...');
      setTimeout(() => location.reload(), 1200);
    } catch(err) { toast('⚠️ Error al restaurar: archivo corrupto o formato inválido'); }
  };
  reader.readAsText(file);
  input.value = '';
}

// ═══════════════════════════════════════════
// ENVIRONMENT SYSTEM
// ═══════════════════════════════════════════
const ENV_NAMES = {
  default:'GENERAL',win:'WINDOWS',lin:'LINUX',mac:'MACOS',
  ad:'ACTIVE DIR',corp:'CORPORATIVO',sd:'SERVICE DESK',sec:'SEGURIDAD',net:'REDES'
};

const ENV_ICONS = {default:'⚡',win:'🪟',lin:'🐧',mac:'🍎',ad:'🏢',corp:'🏛️',sd:'🎧',sec:'🔐',net:'📡'};
const ENV_TOOL_MAP = {default:'all',win:'win',lin:'lin',mac:'mac',ad:'ad',corp:'corp',sd:'sd',sec:'sec',net:'net'};
const SIDEBAR_ENV_RULES = {
  home:['all'],
  favs:['all'],
  hist:['all'],
  'n1-red':['all','net','sd','win','lin','mac'],
  'n1-sis':['all','sd','win','lin','mac'],
  'n1-usr':['all','sd','ad','win','lin','mac'],
  'n1-chk':['all','sd','net'],
  'n2-disk':['all','sd','win','lin','mac'],
  'n2-proc':['all','sd','win','lin','mac'],
  'n2-logs':['all','sd','sec','win','lin','mac'],
  'n2-rem':['all','ad','corp','dev','win','lin','mac'],
  'n3-ad':['all','ad','corp','win','lin','mac'],
  'n3-sec':['all','sec','win','lin','mac'],
  'n3-srv':['all','corp','dev','win','lin','mac'],
  'n3-scr':['all','dev','ad','win','lin','mac'],
  tools:['all'],
  cheat:['all','net','sd'],
  nettool:['all','net','sd'],
  subnet:['all','net','sd'],
  report:['all','sd','corp'],
  timer:['all','sd'],
  notes:['all']
};

function navSectionId(item) {
  const onClick = item.getAttribute('onclick') || '';
  const m = onClick.match(/showSec\('([^']+)'\)/);
  return m ? m[1] : '';
}

function isSidebarItemAllowed(sectionId, env) {
  if (!sectionId || env === 'default') return true;
  const rules = SIDEBAR_ENV_RULES[sectionId] || ['all'];
  return rules.includes('all') || rules.includes(env);
}

function applySidebarFilter(env) {
  const sidebar = document.querySelector('.sidebar');
  if (!sidebar) return;
  const items = [...sidebar.querySelectorAll('.nav-item')];
  const chip = document.getElementById('sideEnvChip');
  if (chip) {
    const icon = ENV_ICONS[env] || '⚡';
    const name = ENV_NAMES[env] || 'GENERAL';
    chip.textContent = `${icon} Filtro: ${name}`;
  }

  items.forEach(item => {
    const id = navSectionId(item);
    item.style.display = isSidebarItemAllowed(id, env) ? '' : 'none';
  });

  const titles = [...sidebar.querySelectorAll('.s-ttl')];
  const divs = [...sidebar.querySelectorAll('.n-div')];
  if (env === 'default') {
    titles.forEach(t => t.style.display = '');
    divs.forEach(d => d.style.display = '');
  } else {
    titles.forEach(t => t.style.display = 'none');
    divs.forEach(d => d.style.display = 'none');

    let cursor = null;
    [...sidebar.children].forEach(ch => {
      if (ch.classList.contains('s-ttl')) cursor = ch;
      if (ch.classList.contains('nav-item') && ch.style.display !== 'none' && cursor) cursor.style.display = '';
    });

    [...sidebar.children].forEach(ch => {
      if (!ch.classList.contains('n-div')) return;
      let hasVisibleBefore = false;
      let hasVisibleAfter = false;
      let p = ch.previousElementSibling;
      while (p) {
        if (p.classList.contains('s-ttl')) break;
        if (p.classList.contains('nav-item') && p.style.display !== 'none') { hasVisibleBefore = true; break; }
        p = p.previousElementSibling;
      }
      let n = ch.nextElementSibling;
      while (n) {
        if (n.classList.contains('s-ttl')) break;
        if (n.classList.contains('nav-item') && n.style.display !== 'none') { hasVisibleAfter = true; break; }
        n = n.nextElementSibling;
      }
      ch.style.display = (hasVisibleBefore || hasVisibleAfter) ? '' : 'none';
    });
  }

  const active = sidebar.querySelector('.nav-item.act');
  if (active && active.style.display === 'none') showSec('home');
}

function setEnv(env) {
  document.body.dataset.env = env;
  const icon = ENV_ICONS[env] || '⚡';
  const name = ENV_NAMES[env] || 'GENERAL';
  document.getElementById('envInd').textContent = icon + ' ' + name;
  document.querySelectorAll('.env-tab').forEach(t => t.classList.toggle('on', t.dataset.env === env));
  // Sync tools filter
  const toolSel = document.getElementById('toolEnvFilter');
  if (toolSel) toolSel.value = ENV_TOOL_MAP[env] || 'all';
  if (typeof filterTools === 'function') filterTools();
  // NOTE: OS Filtering is now INDEPENDENT - User controls SO filter separately via pill buttons
  // No automatic SO change based on environment
  applySidebarFilter(env);
  try { localStorage.setItem('itk_env', env); } catch(e){}
}

// ═══════════════════════════════════════════
// THEME
// ═══════════════════════════════════════════
function toggleTheme() {
  const lm = document.body.classList.toggle('lm');
  const btn = document.getElementById('themeBtn');
  btn.textContent = lm ? '☀️' : '🌙';
  btn.title = lm ? 'Cambiar a modo oscuro' : 'Cambiar a modo claro';
  try { localStorage.setItem('itk_theme', lm ? 'light' : 'dark'); } catch(e){}
}

function toggleTooltips() {
  const disabled = document.body.classList.toggle('no-tooltips');
  const btn = document.getElementById('helpBtn');
  btn.title = disabled ? 'Mostrar información de ayuda' : 'Ocultar información de ayuda';
  btn.style.opacity = disabled ? '0.5' : '1';
  try { localStorage.setItem('itk_tooltips', disabled ? 'disabled' : 'enabled'); } catch(e){}
  toast(disabled ? '❌ Tooltips deshabilitados' : '✅ Tooltips habilitados');
}

// ═══════════════════════════════════════════
// NAVIGATION
// ═══════════════════════════════════════════
function showSec(id) {
  document.querySelectorAll('.sec').forEach(s => s.classList.remove('act'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('act'));
  const sec = document.getElementById(id);
  if (sec) sec.classList.add('act');
  document.querySelectorAll('.nav-item').forEach(n => {
    if (n.getAttribute('onclick') === "showSec('"+id+"')") n.classList.add('act');
  });
  window.scrollTo(0,0);
  renderCommandCards(id);
  applyCommandCodeFilter();
  if (id === 'hist') renderHistory();
  if (id === 'favs') renderFavs();
  if (id === 'notes') renderNotes();
}

// ═══════════════════════════════════════════
// COMMANDS DATABASE (Phase 2)
// ═══════════════════════════════════════════
const COMMANDS_DB = [
  // ── N1-RED: Red & Conectividad (12) ──
  {s:'n1-red',t:'tn',os:'win lin mac',sec:'Red',name:'🔵 Ping Básico',tag:'ICMP',desc:'Verifica conectividad y mide latencia hacia un host remoto.',code:'🪟 ping google.com -t\n🐧 ping -c 4 google.com\n🍎 ping -c 4 -i 0.5 google.com'},
  {s:'n1-red',t:'tn',os:'win lin mac',sec:'Red',name:'🧪 Test Conectividad',tag:'ICMP',desc:'Verifica conectividad a internet/DNS con un servidor público.',code:'🪟 ping 8.8.8.8\n🐧 ping -c 4 8.8.8.8\n🍎 ping -c 4 8.8.8.8'},
  {s:'n1-red',t:'tn',os:'win lin mac',sec:'Red',name:'🔌 Config. Red',tag:'IPCONFIG',desc:'Configuración IP completa de todos los adaptadores.',code:'🪟 ipconfig /all\n🐧 ip addr show && ip route show\n🍎 ifconfig -a && netstat -rn'},
  {s:'n1-red',t:'tn',os:'win lin mac',sec:'Red',name:'🗺️ Traceroute',tag:'ROUTING',desc:'Traza la ruta de paquetes, detecta saltos con alta latencia.',code:'🪟 tracert -d google.com\n🐧 traceroute -n google.com\n🍎 traceroute google.com'},
  {s:'n1-red',t:'tn',os:'win lin mac',sec:'Red',name:'🔍 DNS Lookup',tag:'DNS',desc:'Consulta registros DNS y verifica resolución de nombres.',code:'🪟 nslookup google.com 8.8.8.8\n🐧 dig google.com @8.8.8.8 +short\n🐧 dig google.com MX\n🍎 dig @8.8.8.8 google.com'},
  {s:'n1-red',t:'tn',os:'win lin mac',sec:'Red',name:'🧹 Flush DNS Cache',tag:'DNS',desc:'Limpia la caché DNS local — soluciona problemas de resolución.',code:'🪟 ipconfig /flushdns\n🐧 sudo systemd-resolve --flush-caches\n🍎 sudo dscacheutil -flushcache && sudo killall -HUP mDNSResponder'},
  {s:'n1-red',t:'tn',os:'win lin mac',sec:'Red',name:'📊 Puertos Activos',tag:'PORTS',desc:'Lista conexiones activas y puertos en escucha con proceso.',code:'🪟 netstat -ano | findstr LISTENING\n🪟 Get-NetTCPConnection -State Listen\n🐧 ss -tulpn\n🍎 lsof -i -P -n | grep LISTEN'},
  {s:'n1-red',t:'tn',os:'win lin',sec:'Red',name:'🔄 DHCP Renovar IP',tag:'DHCP',desc:'Libera y renueva la dirección IP asignada por DHCP.',code:'🪟 ipconfig /release && ipconfig /renew\n🐧 sudo dhclient -r eth0 && sudo dhclient eth0\n🐧 nmcli con down eth0 && nmcli con up eth0'},
  {s:'n1-red',t:'tn',os:'win lin mac',sec:'Red',name:'📋 Tabla ARP',tag:'ARP',desc:'Muestra y limpia la tabla ARP (IP → MAC Address).',code:'🪟 arp -a  |  Limpiar: arp -d *\n🐧 ip neigh show  |  ip neigh flush all\n🍎 arp -a  |  sudo arp -d -a'},
  {s:'n1-red',t:'tn',os:'win lin mac',sec:'Red',name:'🔌 Test Puerto TCP',tag:'PORT',desc:'Verifica si un puerto TCP está abierto en un host remoto.',code:'🪟 Test-NetConnection 192.168.1.1 -Port 443\n🐧 nc -zv 192.168.1.1 443\n🍎 nc -zv 192.168.1.1 443'},
  {s:'n1-red',t:'tn',os:'lin mac',sec:'Red',name:'🔍 Escaneo Puertos Básico',tag:'PORTS',desc:'Escaneo rápido de puertos comunes en un host destino.',code:'🐧 nc -zv 192.168.1.1 22 80 443\n🍎 nc -zv 192.168.1.1 22 80 443'},
  {s:'n1-red',t:'tn',os:'win',sec:'Red',name:'🔧 Reset TCP/IP Stack',tag:'STACK',desc:'Reinicia Winsock y la pila TCP/IP — soluciona problemas graves de red.',code:'🪟 netsh winsock reset\n🪟 netsh int ip reset\n🪟 netsh int ipv6 reset\n🪟 # Reiniciar el equipo después'},
  {s:'n1-red',t:'tn',os:'win lin mac',sec:'Red',name:'🗺️ Tabla de Rutas',tag:'ROUTING',desc:'Muestra la tabla de enrutamiento completa del sistema.',code:'🪟 route print\n🐧 ip route show && ip route show table all\n🍎 netstat -rn && route -n get default'},
  {s:'n1-red',t:'tn',os:'win lin',sec:'Red',name:'📶 WiFi Info',tag:'WIFI',desc:'Información del adaptador WiFi y redes disponibles.',code:'🪟 netsh wlan show all\n🪟 netsh wlan show profiles\n🐧 iwconfig && nmcli dev wifi list'},
  // ── N1-SIS: Sistema & SO (10) ──
  {s:'n1-sis',t:'ts',os:'win lin mac',sec:'Sistema',name:'📋 Info del Sistema',tag:'SYSINFO',desc:'Información completa de hardware y SO.',code:'🪟 systeminfo | findstr /B /C:"OS" /C:"Mem"\n🐧 uname -a && lscpu && free -h\n🍎 system_profiler SPSoftwareDataType SPHardwareDataType'},
  {s:'n1-sis',t:'ts',os:'win',sec:'Sistema',name:'🪟 Versión de Windows',tag:'WINVER',desc:'Muestra versión, build y arquitectura de Windows.',code:'🪟 winver\n🪟 wmic os get Caption,Version,BuildNumber\n🪟 ver'},
  {s:'n1-sis',t:'ts',os:'win',sec:'Sistema',name:'⬇️ Windows Updates',tag:'UPDATE',desc:'Inicia búsqueda e instalación de actualizaciones.',code:'🪟 wuauclt /detectnow\n🪟 wuauclt /ResetAuthorization /detectnow'},
  {s:'n1-sis',t:'ts',os:'win',sec:'Sistema',name:'🧰 Editar Arranque',tag:'BOOT',desc:'Modifica configuración de arranque en Windows.',code:'🪟 bcdedit /default\n🪟 bcdedit /set {current} description "Windows 10"'},
  {s:'n1-sis',t:'ts',os:'win',sec:'Sistema',name:'🔩 Reparar SO (SFC/DISM)',tag:'REPAIR',desc:'Escanea y repara archivos de sistema corruptos.',code:'🪟 sfc /scannow\n🪟 DISM /Online /Cleanup-Image /RestoreHealth\n🪟 DISM /Online /Cleanup-Image /ScanHealth'},
  {s:'n1-sis',t:'ts',os:'win lin mac',sec:'Sistema',name:'⏰ Uptime del Sistema',tag:'UPTIME',desc:'Tiempo activo del sistema sin reiniciar.',code:'🪟 (Get-Date)-(gcim Win32_OperatingSystem).LastBootUpTime\n🐧 uptime -p && who -b\n🍎 uptime && last reboot | head -1'},
  {s:'n1-sis',t:'ts',os:'win lin mac',sec:'Sistema',name:'🧠 Uso de RAM',tag:'MEMORY',desc:'Uso de memoria RAM en tiempo real.',code:'🪟 wmic memorychip get Capacity,Speed,Manufacturer\n🪟 Get-Process | Sort-Object WorkingSet -Desc | Select -First 10\n🐧 free -h && cat /proc/meminfo | head -10\n🍎 vm_stat && top -l1 -s0 | grep PhysMem'},
  {s:'n1-sis',t:'ts',os:'win lin mac',sec:'Sistema',name:'⚡ Apagar / Reiniciar',tag:'POWER',desc:'Apaga o reinicia el equipo local o remoto.',code:'🪟 shutdown /r /t 30 /c "Reinicio mantenimiento"\n🪟 shutdown /s /t 0  |  /r /m \\\\PCNAME /t 0\n🐧 sudo shutdown -r +5 "Reinicio en 5 min"\n🍎 sudo shutdown -r now'},
  {s:'n1-sis',t:'ts',os:'win',sec:'Sistema',name:'🖥️ Habilitar RDP',tag:'REMOTE',desc:'Habilita el servicio de Escritorio Remoto en Windows.',code:'🪟 powershell -Command "Set-ItemProperty -Path \'HKLM:\\System\\CurrentControlSet\\Control\\Terminal Server\' -Name fDenyTSConnections -Value 0"\n🪟 Enable-NetFirewallRule -DisplayGroup "Remote Desktop"'},
  {s:'n1-sis',t:'ts',os:'win',sec:'Sistema',name:'🔒 BitLocker Status',tag:'ENCRYPTION',desc:'Estado del cifrado BitLocker en todas las unidades.',code:'🪟 manage-bde -status\n🪟 Get-BitLockerVolume | Select MountPoint,ProtectionStatus,EncryptionPercentage'},
  {s:'n1-sis',t:'ts',os:'win',sec:'Sistema',name:'🧯 Deshabilitar Servicios',tag:'OPTIMIZE',desc:'Deshabilita servicios innecesarios para mejorar rendimiento.',code:'🪟 Get-Service SysMain | Disable-Service\n🪟 Get-Service WSearch | Disable-Service'},
  {s:'n1-sis',t:'ts',os:'lin',sec:'Sistema',name:'⚙️ Systemd Servicios',tag:'SYSTEMD',desc:'Gestión completa de servicios con systemd.',code:'🐧 systemctl status|start|stop|restart SERVICIO\n🐧 systemctl enable|disable SERVICIO\n🐧 systemctl list-units --type=service --state=failed\n🐧 journalctl -u SERVICIO -f --no-pager'},
  {s:'n1-sis',t:'ts',os:'mac',sec:'Sistema',name:'🍺 Homebrew Package Mgr',tag:'PACKAGE',desc:'Gestión de paquetes en macOS con Homebrew.',code:'🍎 brew update && brew upgrade\n🍎 brew install PAQUETE\n🍎 brew list && brew outdated\n🍎 brew cleanup --prune=all && brew doctor'},
  {s:'n1-sis',t:'ts',os:'lin mac',sec:'Sistema',name:'🔑 chmod / chown',tag:'PERMISSIONS',desc:'Cambia permisos y propietario de archivos Unix.',code:'🐧🍎 chmod 755 archivo  # rwxr-xr-x\n🐧🍎 chmod 644 archivo  # rw-r--r--\n🐧🍎 chown usuario:grupo archivo\n🐧🍎 chmod -R 755 /directorio\n🐧🍎 ls -la archivo     # Ver permisos'},
  {s:'n1-sis',t:'ts',os:'win',sec:'Sistema',name:'📶 WiFi Direct',tag:'WIFI',desc:'Activa WiFi Direct para conexión peer-to-peer.',code:'🪟 netsh wlan set hostednetwork mode=allow\n🪟 netsh wlan start hostednetwork'},
  {s:'n1-sis',t:'ts',os:'lin',sec:'Sistema',name:'📦 Gestión Paquetes',tag:'PACKAGE',desc:'Instalar y actualizar paquetes en distribuciones Linux.',code:'🐧 # Debian/Ubuntu:\nsudo apt update && sudo apt upgrade -y\nsudo apt install PAQUETE && apt list --installed\n🐧 # RHEL/Rocky/AlmaLinux:\nsudo dnf update -y && sudo dnf install PAQUETE'},
  // ── N1-USR: Usuarios & Cuentas (6) ──
  {s:'n1-usr',t:'tu',os:'win lin mac',sec:'Usuarios',name:'📋 Listar Usuarios',tag:'USERS',desc:'Lista todos los usuarios del sistema con detalle.',code:'🪟 net user | Get-LocalUser\n🐧 cat /etc/passwd | awk -F: \'$3>=1000{print $1,$3}\'\n🍎 dscl . list /Users | grep -v ^_'},
  {s:'n1-usr',t:'tu',os:'win lin mac',sec:'Usuarios',name:'➕ Crear Usuario Local',tag:'USER',desc:'Crea una nueva cuenta de usuario local.',code:'🪟 net user usuario Contraseña123 /add\n🐧 sudo useradd -m usuario\n🍎 sysadminctl -addUser usuario'},
  {s:'n1-usr',t:'tu',os:'win lin mac',sec:'Usuarios',name:'🔑 Reset Contraseña',tag:'PASSWORD',desc:'Cambia contraseña de usuario local desde administrador.',code:'🪟 net user USUARIO NuevaPass123!\n🪟 Set-LocalUser -Name USUARIO -Password (Read-Host -AsSecureString)\n🐧 sudo passwd USUARIO\n🍎 dscl . -passwd /Users/USUARIO NUEVAPASS'},
  {s:'n1-usr',t:'tu',os:'win lin',sec:'Usuarios',name:'🔓 Desbloquear Cuenta',tag:'UNLOCK',desc:'Desbloquea una cuenta bloqueada por intentos fallidos.',code:'🪟 net user USUARIO /active:yes\n🪟 Unlock-ADAccount -Identity "USUARIO"\n🐧 sudo pam_tally2 --reset --user USUARIO\n🐧 sudo faillock --reset --user USUARIO'},
  {s:'n1-usr',t:'tu',os:'win lin mac',sec:'Usuarios',name:'🪪 Usuario Actual',tag:'WHOAMI',desc:'Identidad del usuario actual y sus grupos/privilegios.',code:'🪟 whoami /all\n🪟 whoami /groups | whoami /priv\n🐧 id && groups $(whoami)\n🍎 id && dscl . read /Users/$(whoami) GroupMembership'},
  {s:'n1-usr',t:'tu',os:'win lin mac',sec:'Usuarios',name:'🖥️ Sesiones Activas',tag:'SESSIONS',desc:'Muestra usuarios con sesión activa en el sistema.',code:'🪟 query user | logoff ID_SESION\n🐧 who && w && last | head -10\n🍎 who && last | head -10'},
  {s:'n1-usr',t:'tu',os:'win',sec:'Usuarios',name:'👥 Agregar a Grupo',tag:'GROUP',desc:'Agrega usuario a un grupo local (ej: Administradores).',code:'🪟 net localgroup Administradores usuario /add'},
  {s:'n1-usr',t:'tu',os:'win',sec:'Usuarios',name:'🔐 Política de Contraseña',tag:'POLICY',desc:'Configura política de contraseñas del sistema.',code:'🪟 net accounts /maxpwage:90\n🪟 net accounts /minpwlen:8'},
  {s:'n1-usr',t:'tu',os:'win',sec:'Usuarios',name:'🚫 Deshabilitar Guest',tag:'SECURITY',desc:'Deshabilita la cuenta Guest por seguridad.',code:'🪟 net user Guest /active:no'},
  {s:'n1-usr',t:'tu',os:'lin mac',sec:'Usuarios',name:'🕒 Último Logon',tag:'AUDIT',desc:'Muestra últimos inicios de sesión del sistema.',code:'🐧 lastlog\n🍎 log show --predicate "eventMessage contains[c] \'session opened\'" --info'},
  {s:'n1-usr',t:'tu',os:'lin',sec:'Usuarios',name:'🧭 Intentos Login',tag:'SECURITY',desc:'Monitorea intentos de login fallidos.',code:'🐧 grep "Failed password" /var/log/auth.log | tail -20'},
  {s:'n1-usr',t:'tu',os:'win lin',sec:'Usuarios',name:'🛡️ Elevar Privilegios',tag:'PRIV',desc:'Ejecutar comandos con privilegios de otro usuario.',code:'🪟 runas /user:DOMINIO\\USUARIO cmd.exe\n🪟 runas /savecred /user:ADMIN powershell\n🐧 sudo -u USUARIO comando\n🐧 sudo su - USUARIO'},
  // ── N2-DISK: Disco & Storage (8) ──
  {s:'n2-disk',t:'td',os:'win lin mac',sec:'Disco',name:'📊 Uso de Disco',tag:'SPACE',desc:'Muestra uso del espacio en todas las unidades.',code:'🪟 Get-PSDrive -PSProvider FileSystem | Select Name,@{N=\'Usado(GB)\';E={[math]::Round($_.Used/1GB,2)}},@{N=\'Libre(GB)\';E={[math]::Round($_.Free/1GB,2)}}\n🐧 df -hT --exclude-type=tmpfs\n🍎 df -h | grep -v tmpfs'},
  {s:'n2-disk',t:'td',os:'win lin mac',sec:'Disco',name:'🧱 Discos y Particiones',tag:'DISK',desc:'Muestra información de discos y particiones.',code:'🪟 Get-Disk\n🪟 diskpart\n🐧 lsblk\n🐧 fdisk -l\n🍎 diskutil list'},
  {s:'n2-disk',t:'td',os:'win',sec:'Disco',name:'🗂️ DiskPart',tag:'DISK',desc:'Gestión avanzada de discos y particiones.',code:'🪟 diskpart\n   list disk\n   select disk 0\n   list partition\n   list volume'},
  {s:'n2-disk',t:'td',os:'win',sec:'Disco',name:'🧪 CHKDSK Reparar',tag:'REPAIR',desc:'Escanea y repara errores del disco.',code:'🪟 chkdsk C: /F /R\n🪟 chkdsk C: /V'},
  {s:'n2-disk',t:'td',os:'win lin',sec:'Disco',name:'🧽 Formatear Partición',tag:'FORMAT',desc:'Formatea partición (cuidado con los datos).',code:'🪟 format D: /FS:NTFS /Q\n🐧 sudo mkfs.ext4 /dev/sdb1'},
  {s:'n2-disk',t:'td',os:'win lin mac',sec:'Disco',name:'🧷 Montar Share SMB',tag:'SHARE',desc:'Monta una carpeta compartida en red.',code:'🪟 net use Z: \\\\servidor\\compartir\n🐧 sudo mount -t cifs -o username=user //servidor/share /mnt/punto\n🍎 mount -t smbfs //usuario@servidor/share /Volumes/share'},
  {s:'n2-disk',t:'td',os:'win lin',sec:'Disco',name:'❤️ Estado SMART',tag:'HEALTH',desc:'Verifica la salud del disco para predecir fallos.',code:'🪟 wmic diskdrive get status,model\n🪟 Get-WmiObject MSStorageDriver_FailurePredictStatus -Namespace root\\wmi\n🐧 sudo smartctl -a /dev/sda\n🐧 sudo smartctl -H /dev/nvme0'},
  {s:'n2-disk',t:'td',os:'win',sec:'Disco',name:'🧰 Desfragmentar Disco',tag:'DEFRAG',desc:'Desfragmenta disco duro (HDD).',code:'🪟 defrag C: /O\n🪟 Optimize-Volume -DriveLetter C -Defrag'},
  {s:'n2-disk',t:'td',os:'win lin mac',sec:'Disco',name:'⚡ TRIM para SSD',tag:'SSD',desc:'Optimiza SSD habilitando TRIM.',code:'🪟 fsutil behavior set disabledeletenotify 0\n🐧 fstrim /\n🍎 trimforce enable'},
  {s:'n2-disk',t:'td',os:'win lin mac',sec:'Disco',name:'🔁 Robocopy / Rsync',tag:'COPY',desc:'Copia robusta con reintentos y log detallado.',code:'🪟 robocopy C:\\ORIGEN D:\\DESTINO /MIR /LOG:C:\\copia.log /R:3 /W:5 /MT:8\n🐧 rsync -avzh --progress --partial /origen/ /destino/\n🍎 rsync -avz --progress /origen/ user@remoto:/destino/'},
  {s:'n2-disk',t:'td',os:'win',sec:'Disco',name:'🧩 Crear Disco Virtual',tag:'VIRTUAL',desc:'Crea un disco virtual VHD/VHDX.',code:'🪟 New-VirtualDisk -FriendlyName "VirtualDisk" -Size 10GB -StoragePoolFriendlyName "Storage Pool"'},
  {s:'n2-disk',t:'td',os:'win lin mac',sec:'Disco',name:'🔍 Archivos Grandes',tag:'SEARCH',desc:'Localiza los archivos más grandes del sistema.',code:'🪟 Get-ChildItem C:\\ -Recurse -EA SilentlyContinue | Where-Object {$_.Length -gt 500MB} | Sort-Object Length -Desc | Select Name,@{N=\'MB\';E={[math]::Round($_.Length/1MB)}},DirectoryName\n🐧 find / -size +500M -type f 2>/dev/null | xargs ls -lh\n🍎 find / -size +500M -type f 2>/dev/null'},
  {s:'n2-disk',t:'td',os:'win',sec:'Disco',name:'🛡️ Permisos NTFS',tag:'NTFS ACL',desc:'Consulta y modifica permisos NTFS de archivos y carpetas.',code:'🪟 icacls C:\\carpeta\n🪟 icacls C:\\carpeta /grant USUARIO:(OI)(CI)F\n🪟 takeown /f C:\\carpeta /r /d y\n🪟 icacls C:\\carpeta /reset /T /C'},
  {s:'n2-disk',t:'td',os:'win',sec:'Disco',name:'🧹 Limpiar Temporales',tag:'CLEANUP',desc:'Elimina archivos temporales y libera espacio rápidamente.',code:'🪟 Remove-Item $env:TEMP\\* -Recurse -Force -EA SilentlyContinue\n🪟 Remove-Item C:\\Windows\\Temp\\* -Recurse -Force -EA SilentlyContinue\n🪟 cleanmgr /sagerun:1'},
  {s:'n2-disk',t:'td',os:'lin mac',sec:'Disco',name:'📁 Carpetas Más Pesadas',tag:'SIZE',desc:'Encuentra las carpetas que más espacio consumen.',code:'🐧 du -sh /* 2>/dev/null | sort -rh | head -20\n🐧 du -h --max-depth=2 /home | sort -rh | head -15\n🍎 du -sh /Users/* 2>/dev/null | sort -rh'},
  {s:'n2-disk',t:'td',os:'lin',sec:'Disco',name:'🧯 Backup Imagen Disco',tag:'BACKUP',desc:'Crea imagen de disco para backup.',code:'🐧 sudo dd if=/dev/sda of=/mnt/backup/sda.img\n🐧 sudo tar -czf /mnt/backup/home.tar.gz /home'},
  // ── N2-PROC: Procesos & Servicios (6) ──
  {s:'n2-proc',t:'tp',os:'win lin mac',sec:'Procesos',name:'📈 Top Procesos CPU',tag:'PROCESS',desc:'Los procesos que más recursos consumen.',code:'🪟 Get-Process | Sort-Object CPU -Desc | Select -First 15 Name,CPU,@{N=\'RAM_MB\';E={[math]::Round($_.WorkingSet/1MB)}}\n🐧 ps aux --sort=-%cpu | head -15\n🍎 top -l1 -o cpu | head -20'},
  {s:'n2-proc',t:'tp',os:'win lin mac',sec:'Procesos',name:'💀 Terminar Proceso',tag:'KILL',desc:'Termina un proceso por nombre o PID de forma forzada.',code:'🪟 Stop-Process -Name "chrome" -Force\n🪟 taskkill /IM chrome.exe /F /T\n🐧 kill -9 PID || killall -9 nombre\n🍎 kill -9 PID || pkill -9 nombre'},
  {s:'n2-proc',t:'tp',os:'win',sec:'Procesos',name:'🖨️ Cola de Impresión',tag:'QUEUE',desc:'Limpia la cola de impresión atascada.',code:'🪟 Stop-Service Spooler -Force\n🪟 Remove-Item C:\\Windows\\System32\\spool\\PRINTERS\\* -Force\n🪟 Start-Service Spooler\n🪟 Get-Service Spooler | Select Status'},
  {s:'n2-proc',t:'tp',os:'win lin mac',sec:'Procesos',name:'🔎 Proceso por Puerto',tag:'PROCESS',desc:'Identifica qué proceso está usando un puerto.',code:'🪟 netstat -ano | findstr :8080\n🪟 Get-Process -Id (Get-NetTCPConnection -LocalPort 8080).OwningProcess\n🐧 lsof -i :8080 || ss -tulpn | grep :8080\n🍎 lsof -i :8080 -P -n'},
  {s:'n2-proc',t:'tp',os:'win lin',sec:'Procesos',name:'⚡ Gestión Servicios',tag:'SERVICES',desc:'Gestión completa de servicios del sistema.',code:'🪟 Get-Service | Where {$_.Status -eq "Stopped" -and $_.StartType -eq "Automatic"}\n🪟 Start-Service|Stop-Service|Restart-Service NOMBRE\n🪟 Set-Service -Name NOMBRE -StartupType Automatic\n🐧 systemctl start|stop|restart|enable|disable SERVICIO'},
  {s:'n2-proc',t:'tp',os:'win lin mac',sec:'Procesos',name:'📅 Tareas Programadas',tag:'SCHEDULED',desc:'Lista y gestiona tareas programadas del sistema.',code:'🪟 Get-ScheduledTask | Where {$_.State -ne "Disabled"} | Select TaskName,State,TaskPath\n🪟 Start-ScheduledTask -TaskName "NOMBRE"\n🐧 crontab -l && crontab -e\n🍎 launchctl list | grep -v com.apple'},
  {s:'n2-proc',t:'tp',os:'win',sec:'Procesos',name:'🧩 Crear Tarea',tag:'SCHEDULED',desc:'Crea una tarea programada en Windows.',code:'🪟 schtasks /create /tn "Mi Tarea" /tr "notepad.exe" /sc daily /st 12:00'},
  {s:'n2-proc',t:'tp',os:'win lin mac',sec:'Procesos',name:'🌐 Conexiones de Red',tag:'NETWORK',desc:'Muestra conexiones de red activas.',code:'🪟 Get-NetTCPConnection | Where State -eq ESTABLISHED\n🐧 netstat -tuln\n🍎 netstat -an'},
  // ── N2-LOGS: Logs & Eventos (5) ──
  {s:'n2-logs',t:'tl',os:'win lin mac',sec:'Logs',name:'📰 Últimos Errores',tag:'ERRORS',desc:'Muestra los errores más recientes del sistema.',code:'🪟 Get-EventLog -LogName System -EntryType Error -Newest 20\n🐧 journalctl -p err -n 50 --no-pager\n🍎 log show --predicate \'eventType == faultEvent\' --last 1h | tail -50'},
  {s:'n2-logs',t:'tl',os:'win',sec:'Logs',name:'📂 Visor de Eventos',tag:'EVENTLOG',desc:'Abre el visor de eventos de Windows.',code:'🪟 eventvwr.msc'},
  {s:'n2-logs',t:'tl',os:'win lin',sec:'Logs',name:'🔐 Fallos de Login',tag:'LOGIN',desc:'Intentos fallidos de inicio de sesión (Event ID 4625).',code:'🪟 Get-WinEvent -FilterHashtable @{LogName="Security";Id=4625} -MaxEvents 50 | Select TimeCreated,@{N=\'User\';E={$_.Properties[5].Value}},@{N=\'IP\';E={$_.Properties[19].Value}}\n🐧 grep "Failed password" /var/log/auth.log | tail -50'},
  {s:'n2-logs',t:'tl',os:'win',sec:'Logs',name:'🎯 Filtrar Log por ID',tag:'FILTER',desc:'Filtra eventos por tipo o ID.',code:'🪟 Get-EventLog -LogName System -EntryType Error | Select TimeGenerated, Source, Message | Out-GridView'},
  {s:'n2-logs',t:'tl',os:'win lin mac',sec:'Logs',name:'📡 Log en Tiempo Real',tag:'MONITOR',desc:'Monitorea un archivo de log en tiempo real.',code:'🪟 Get-Content C:\\archivo.log -Wait -Tail 30\n🐧 tail -f /var/log/syslog | grep -i error\n🐧 journalctl -f -u nginx\n🍎 tail -f /var/log/system.log'},
  {s:'n2-logs',t:'tl',os:'win lin mac',sec:'Logs',name:'🔎 Buscar en Logs',tag:'SEARCH',desc:'Busca texto específico en logs.',code:'🪟 Select-String -Path C:\\Windows\\System32\\LogFiles\\* -Pattern "error"\n🐧 grep -r "error" /var/log/\n🍎 grep -r "error" /var/log/'},
  {s:'n2-logs',t:'tl',os:'win',sec:'Logs',name:'💥 Análisis BSOD',tag:'CRASH',desc:'Analiza el último pantallazo azul y eventos de apagado inesperado.',code:'🪟 Get-WinEvent -FilterHashtable @{LogName="System";Id=1001,6008,41} -MaxEvents 10 | Select TimeCreated,Id,Message | Format-List\n🪟 dir C:\\Windows\\Minidump\\\n🪟 # Herramienta: WhoCrashed portable'},
  {s:'n2-logs',t:'tl',os:'win',sec:'Logs',name:'🧪 Debug Logging',tag:'DEBUG',desc:'Habilita logging detallado en Windows.',code:'🪟 Get-Service eventlog | Set-Service -StartupType Automatic -PassThru | Start-Service'},
  {s:'n2-logs',t:'tl',os:'win',sec:'Logs',name:'💾 Exportar Logs',tag:'EXPORT',desc:'Exporta logs de eventos a CSV o EVTX.',code:'🪟 Get-EventLog -LogName System -EntryType Error -Newest 100 | Export-Csv C:\\logs.csv -NoTypeInformation\n🪟 wevtutil epl System C:\\system_$(Get-Date -f yyyyMMdd).evtx'},
  {s:'n2-logs',t:'tl',os:'win',sec:'Logs',name:'🧹 Limpiar Log Aplicación',tag:'CLEAR',desc:'Limpia los registros de aplicación.',code:'🪟 Clear-EventLog -LogName Application'},
  {s:'n2-logs',t:'tl',os:'win',sec:'Logs',name:'🗂️ Logs IIS',tag:'WEB',desc:'Accede a logs de IIS.',code:'🪟 Get-Content "C:\\inetpub\\logs\\LogFiles\\W3SVC1\\*" -Tail 100'},
  {s:'n2-logs',t:'tl',os:'lin',sec:'Logs',name:'📦 Comprimir Logs',tag:'ARCHIVE',desc:'Comprime logs antiguos para ahorrar espacio.',code:'🐧 find /var/log -type f -mtime +30 -exec gzip {} \\;'},
  // ── N2-REM: Acceso Remoto (5) ──
  {s:'n2-rem',t:'tr',os:'win',sec:'Remoto',name:'🖥️ Conexión RDP',tag:'REMOTE',desc:'Conecta a equipos remotos por escritorio remoto.',code:'🪟 mstsc /v:192.168.1.100\n🪟 mstsc /v:SERVER /u:DOMINIO\\USUARIO /admin\n🪟 # Habilitar RDP:\nSet-ItemProperty "HKLM:\\System\\CurrentControlSet\\Control\\Terminal Server" fDenyTSConnections 0\nEnable-NetFirewallRule -DisplayGroup "Remote Desktop"'},
  {s:'n2-rem',t:'tr',os:'win lin mac',sec:'Remoto',name:'🔑 SSH Avanzado',tag:'SSH',desc:'Conexión SSH con túneles, claves y jump host.',code:'🐧🍎 ssh usuario@192.168.1.100\n    ssh -p 2222 usuario@servidor\n    ssh -i ~/.ssh/id_rsa usuario@servidor\n    ssh -L 8080:localhost:80 usuario@servidor\n    ssh -J bastion usuario@servidor-interno'},
  {s:'n2-rem',t:'tr',os:'win',sec:'Remoto',name:'⚡ PowerShell Remoto',tag:'WINRM',desc:'PowerShell Remoting para gestión masiva de equipos.',code:'🪟 Enable-PSRemoting -Force\n🪟 Enter-PSSession -ComputerName SERVER -Credential DOMINIO\\ADMIN\n🪟 Invoke-Command -ComputerName SRV1,SRV2 -ScriptBlock {Get-Service | Where Status -eq "Stopped"}\n🪟 $s = New-PSSession -ComputerName SERVER'},
  {s:'n2-rem',t:'tr',os:'win lin mac',sec:'Remoto',name:'📁 Copiar Archivos Remoto',tag:'TRANSFER',desc:'Transferir archivos de forma segura a equipos remotos.',code:'🪟 Copy-Item "C:\\archivo" -Destination "\\\\SERVER\\C$\\destino" -Credential $cred\n🐧🍎 scp archivo.txt usuario@servidor:/ruta/\n    scp -r /directorio/ usuario@servidor:/destino/\n    rsync -avz --progress local/ user@server:/remoto/'},
  {s:'n2-rem',t:'tr',os:'win',sec:'Remoto',name:'📊 Sesiones RDP Activas',tag:'SESSION',desc:'Lista y gestiona sesiones RDP activas en servidores.',code:'🪟 query session /server:SERVIDOR\n🪟 logoff IDSESION /server:SERVIDOR\n🪟 msg IDSESION /server:SERVIDOR "Mantenimiento en 5 min"\n🪟 Get-WmiObject Win32_ComputerSystem -ComputerName SERVIDOR'},
  // ── N3-AD: Active Directory (8) ──
  {s:'n3-ad',t:'ta',os:'win',sec:'Active Directory',name:'📋 Listar Usuarios AD',tag:'AD',desc:'Muestra todos los usuarios en Active Directory.',code:'🪟 Get-ADUser -Filter * | Select Name, SamAccountName, Enabled'},
  {s:'n3-ad',t:'ta',os:'win',sec:'Active Directory',name:'🔍 Buscar Usuario AD',tag:'SEARCH',desc:'Consulta información completa de usuarios en AD.',code:'🪟 Get-ADUser -Identity "jgarcia" -Properties *\n🪟 Get-ADUser -Filter {Name -like "*Garcia*"} -Properties Department,Title,LastLogonDate\n🪟 Get-ADUser -Filter {LockedOut -eq $true} -Properties LockedOut,LastBadPasswordAttempt'},
  {s:'n3-ad',t:'ta',os:'win',sec:'Active Directory',name:'🔓 Desbloquear + Reset AD',tag:'UNLOCK',desc:'Desbloquea y resetea contraseña en Active Directory.',code:'🪟 Unlock-ADAccount -Identity "jgarcia"\n🪟 Set-ADAccountPassword -Identity "jgarcia" -Reset -NewPassword (ConvertTo-SecureString "Temp2024#!" -AsPlainText -Force)\n🪟 Set-ADUser -Identity "jgarcia" -ChangePasswordAtLogon $true'},
  {s:'n3-ad',t:'ta',os:'win',sec:'Active Directory',name:'👥 Grupos AD',tag:'GROUP',desc:'Gestiona grupos y membresías en Active Directory.',code:'🪟 Get-ADGroupMember "Administradores TI" -Recursive\n🪟 Add-ADGroupMember -Identity "GrupoIT" -Members "jgarcia","mlopez"\n🪟 Remove-ADGroupMember -Identity "GrupoIT" -Members "jgarcia" -Confirm:$false\n🪟 Get-ADPrincipalGroupMembership "jgarcia" | Select Name'},
  {s:'n3-ad',t:'ta',os:'win',sec:'Active Directory',name:'📤 Exportar Usuarios AD',tag:'EXPORT',desc:'Exporta lista completa de usuarios AD a CSV.',code:'🪟 Get-ADUser -Filter * | Select Name, SamAccountName, Mail, Enabled | Export-Csv usuarios.csv'},
  {s:'n3-ad',t:'ta',os:'win',sec:'Active Directory',name:'🏗️ Onboarding AD',tag:'NEW USER',desc:'Crea nuevo usuario en AD con grupos y configuración estándar.',code:'🪟 New-ADUser -Name "Juan Garcia" -SamAccountName "jgarcia" -UserPrincipalName "jgarcia@empresa.com" -Department "Ventas" -Title "Comercial" -Enabled $true -AccountPassword (ConvertTo-SecureString "Temp2024#!" -AsPlainText -Force) -ChangePasswordAtLogon $true\nAdd-ADGroupMember "Grupo_Ventas" "jgarcia"'},
  {s:'n3-ad',t:'ta',os:'win',sec:'Active Directory',name:'🚪 Offboarding AD',tag:'DISABLE',desc:'Proceso completo de baja: deshabilitar, limpiar grupos y mover OU.',code:'🪟 $u = "jgarcia"\nDisable-ADAccount -Identity $u\nGet-ADPrincipalGroupMembership $u | Where Name -ne "Domain Users" | ForEach-Object { Remove-ADGroupMember -Identity $_ -Members $u -Confirm:$false }\nSet-ADUser -Identity $u -Description "Baja: $(Get-Date -f dd/MM/yyyy)"\nMove-ADObject -Identity (Get-ADUser $u) -TargetPath "OU=Desactivados,DC=empresa,DC=local"'},
  {s:'n3-ad',t:'ta',os:'win',sec:'Active Directory',name:'🏛️ GPO & Directivas',tag:'POLICY',desc:'Actualiza y audita directivas de grupo aplicadas.',code:'🪟 gpupdate /force\n🪟 gpresult /R\n🪟 gpresult /H C:\\gpo_report.html && start C:\\gpo_report.html\n🪟 Get-GPO -All | Select DisplayName,GpoStatus\n🪟 nltest /sc_verify:empresa.local'},
  {s:'n3-ad',t:'ta',os:'win',sec:'Active Directory',name:'🔄 Replicación AD',tag:'REPLICATION',desc:'Verifica y fuerza la replicación entre controladores de dominio.',code:'🪟 repadmin /showrepl && repadmin /replsummary\n🪟 repadmin /syncall /AdeP\n🪟 dcdiag /test:replications /v\n🪟 Test-ComputerSecureChannel -Repair -Credential EMPRESA\\Admin'},
  {s:'n3-ad',t:'ta',os:'win',sec:'Active Directory',name:'🏢 Controladores de Dominio',tag:'DOMAIN',desc:'Lista todos los controladores de dominio.',code:'🪟 Get-ADDomainController -Filter *\n🪟 nltest /dclist:dominio.com'},
  {s:'n3-ad',t:'ta',os:'win',sec:'Active Directory',name:'📊 Últimos Logins AD',tag:'AUDIT',desc:'Audita últimos inicios de sesión y cuentas inactivas.',code:'🪟 Get-ADUser -Filter * -Properties LastLogonDate | Sort-Object LastLogonDate -Desc | Select Name,LastLogonDate,Enabled | Select -First 30\n🪟 # Inactivos +90 días:\nGet-ADUser -Filter {LastLogonDate -lt (Get-Date).AddDays(-90) -and Enabled -eq $true} -Properties LastLogonDate | Select Name,LastLogonDate'},
  // ── N3-SEC: Seguridad (6) ──
  {s:'n3-sec',t:'tc2',os:'win lin',sec:'Seguridad',name:'🛡️ Firewall Estado',tag:'FIREWALL',desc:'Gestiona reglas de firewall en Windows y Linux.',code:'🪟 Get-NetFirewallRule | Where {$_.Enabled -eq "True" -and $_.Direction -eq "Inbound"} | Select DisplayName,Action,LocalPort\n🪟 New-NetFirewallRule -DisplayName "HTTPS" -Direction Inbound -LocalPort 443 -Protocol TCP -Action Allow\n🐧 sudo ufw status verbose\n🐧 sudo firewall-cmd --list-all'},
  {s:'n3-sec',t:'tc2',os:'win',sec:'Seguridad',name:'🧱 Habilitar Firewall',tag:'FIREWALL',desc:'Habilita Windows Firewall en todos los perfiles.',code:'🪟 Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled True'},
  {s:'n3-sec',t:'tc2',os:'win',sec:'Seguridad',name:'🦠 Windows Defender',tag:'DEFENDER',desc:'Gestiona Windows Defender desde PowerShell.',code:'🪟 Get-MpComputerStatus | Select AMRunningMode,AntivirusEnabled,RealTimeProtectionEnabled,AntivirusSignatureLastUpdated\n🪟 Start-MpScan -ScanType QuickScan\n🪟 Update-MpSignature\n🪟 Add-MpPreference -ExclusionPath "C:\\excepciones"'},
  {s:'n3-sec',t:'tc2',os:'win',sec:'Seguridad',name:'🧬 Escaneo Completo',tag:'SCAN',desc:'Ejecuta escaneo completo de malware.',code:'🪟 Start-MpScan -ScanType FullScan'},
  {s:'n3-sec',t:'tc2',os:'win lin',sec:'Seguridad',name:'📊 Conexiones Sospechosas',tag:'NETWORK',desc:'Detecta conexiones activas con proceso responsable.',code:'🪟 Get-NetTCPConnection -State Established | Select LocalAddress,LocalPort,RemoteAddress,RemotePort,@{N=\'Proc\';E={(Get-Process -Id $_.OwningProcess -EA SilentlyContinue).Name}} | Sort-Object RemoteAddress\n🐧 ss -tulpn && lsof -i -n -P | grep ESTABLISHED'},
  {s:'n3-sec',t:'tc2',os:'win lin',sec:'Seguridad',name:'📡 Puertos Escuchando',tag:'PORT',desc:'Muestra puertos abiertos y servicios escuchando.',code:'🪟 Get-NetTCPConnection -State Listen\n🐧 sudo netstat -tuln'},
  {s:'n3-sec',t:'tc2',os:'win',sec:'Seguridad',name:'🏅 Certificados SSL',tag:'CERT',desc:'Gestiona certificados y detecta los próximos a expirar.',code:'🪟 Get-ChildItem Cert:\\LocalMachine\\My\n🪟 # Próximos a expirar (30 días):\nGet-ChildItem Cert:\\LocalMachine\\My | Where-Object {$_.NotAfter -lt (Get-Date).AddDays(30)} | Select Subject,NotAfter\n🪟 Export-Certificate -Cert $cert -FilePath C:\\cert.cer'},
  {s:'n3-sec',t:'tc2',os:'win',sec:'Seguridad',name:'🧾 UAC Estricto',tag:'UAC',desc:'Activa Control de Cuentas de Usuario.',code:'🪟 powershell -Command "Set-ItemProperty -Path HKLM:\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System -Name ConsentPromptBehaviorAdmin -Value 2"'},
  {s:'n3-sec',t:'tc2',os:'win',sec:'Seguridad',name:'🗝️ Directiva Auditoría',tag:'AUDITPOL',desc:'Configura y consulta políticas de auditoría.',code:'🪟 auditpol /get /category:*\n🪟 auditpol /set /subcategory:"Logon" /success:enable /failure:enable\n🪟 auditpol /set /subcategory:"Account Lockout" /success:enable /failure:enable\n🪟 auditpol /backup /file:C:\\auditpol_$(Get-Date -f yyyyMMdd).csv'},
  {s:'n3-sec',t:'tc2',os:'win',sec:'Seguridad',name:'🕵️ Scan Rootkits',tag:'MALWARE',desc:'Busca rootkits y software malicioso profundo.',code:'🪟 Get-MpComputerStatus\n🪟 Start-MpScan -ScanType FullScan'},
  {s:'n3-sec',t:'tc2',os:'win',sec:'Seguridad',name:'📁 Recursos Compartidos SMB',tag:'SHARE',desc:'Lista, crea y gestiona recursos compartidos SMB.',code:'🪟 Get-SmbShare | Select Name,Path,Description\n🪟 Get-SmbSession | Select ClientUserName,ClientComputerName,NumOpens\n🪟 New-SmbShare -Name "Datos" -Path "C:\\Datos" -FullAccess "EMPRESA\\GrupoIT" -ReadAccess "EMPRESA\\Usuarios"'},
  // ── N3-SRV: Servidores & Virtualización (7) ──
  {s:'n3-srv',t:'ts',os:'win',sec:'Servidores',name:'🌐 IIS Web Server',tag:'IIS',desc:'Gestión de sitios y App Pools en IIS.',code:'🪟 Import-Module WebAdministration\n🪟 Get-Website | Select Name,State,PhysicalPath\n🪟 Restart-WebAppPool "DefaultAppPool"\n🪟 Start-Website "MiSitio" | Stop-Website "MiSitio"\n🪟 iisreset /restart'},
  {s:'n3-srv',t:'ts',os:'win',sec:'Servidores',name:'🗂️ DNS & DHCP Server',tag:'DNS',desc:'Gestiona zonas DNS y ámbitos DHCP en Windows Server.',code:'🪟 Get-DnsServerZone\n🪟 Add-DnsServerResourceRecordA -ZoneName "empresa.local" -Name "srv01" -IPv4Address "10.0.1.10"\n🪟 Get-DhcpServerv4Scope\n🪟 Get-DhcpServerv4Lease -ScopeId 192.168.1.0'},
  {s:'n3-srv',t:'ts',os:'win',sec:'Servidores',name:'🖥️ Hyper-V VMs',tag:'HYPER-V',desc:'Gestiona máquinas virtuales con Hyper-V PowerShell.',code:'🪟 Get-VM | Select Name,State,CPUUsage,MemoryAssigned\n🪟 Start-VM "NombreVM" | Stop-VM "NombreVM" -Force\n🪟 Checkpoint-VM -Name "NombreVM" -SnapshotName "Pre-Update-$(Get-Date -f yyyyMMdd)"\n🪟 Export-VM -Name "NombreVM" -Path "D:\\Backups\\"'},
  {s:'n3-srv',t:'ts',os:'win lin',sec:'Servidores',name:'🐳 Docker',tag:'CONTAINER',desc:'Gestión esencial de contenedores Docker.',code:'🪟🐧 docker ps -a && docker images\ndocker logs CONTAINER --tail 100 -f\ndocker exec -it CONTAINER /bin/bash\ndocker stats --no-stream\ndocker system prune -af --volumes'},
  {s:'n3-srv',t:'tex',os:'win',sec:'Servidores',name:'📧 Exchange / M365',tag:'EXCHANGE',desc:'PowerShell para Exchange Online y Microsoft 365.',code:'🪟 Connect-ExchangeOnline -UserPrincipalName admin@empresa.com\n🪟 Get-Mailbox -Identity "usuario@empresa.com" | Select ProhibitSendQuota\n🪟 Get-MailboxStatistics "usuario" | Select DisplayName,TotalItemSize\n🪟 Set-Mailbox "usuario" -ProhibitSendQuota 25GB\n🪟 Get-MsolUser -UserPrincipalName "usuario@empresa.com" | Select Licenses'},
  {s:'n3-srv',t:'ts',os:'win',sec:'Servidores',name:'💾 Backup WSB + VSS',tag:'BACKUP',desc:'Backup y Shadow Copies en Windows Server.',code:'🪟 wbadmin get versions && wbadmin get status\n🪟 wbadmin start backup -backuptarget:E: -include:C: -allCritical -quiet\n🪟 vssadmin list shadows\n🪟 vssadmin create shadow /for=C:'},
  {s:'n3-srv',t:'ts',os:'lin',sec:'Servidores',name:'🐧 Nginx / Apache',tag:'WEB',desc:'Gestión de servidores web en Linux.',code:'🐧 sudo systemctl status nginx\nsudo nginx -t && sudo nginx -s reload\nsudo tail -f /var/log/nginx/error.log\n🐧 sudo systemctl status apache2\nsudo apache2ctl configtest && sudo apachectl restart'},
  // ── N3-SCR: Scripts PowerShell (6) ──
  {s:'n3-scr',t:'ta',os:'win',sec:'Scripts',name:'📦 Inventario Equipos AD',tag:'PS',desc:'Genera inventario CSV de todos los equipos del dominio.',code:'$computers = Get-ADComputer -Filter * -Properties *\n$report = foreach ($pc in $computers) {\n  [PSCustomObject]@{\n    Nombre=$pc.Name; OS=$pc.OperatingSystem\n    UltimoLogin=$pc.LastLogonDate\n    IP=(Resolve-DnsName $pc.Name -EA SilentlyContinue).IPAddress\n  }\n}\n$report | Export-Csv "C:\\inventario_$(Get-Date -f yyyyMMdd).csv" -NoTypeInformation -Encoding UTF8'},
  {s:'n3-scr',t:'ta',os:'win',sec:'Scripts',name:'🔴 Deshabilitar Cuentas Inactivas',tag:'PS',desc:'Detecta y deshabilita cuentas sin actividad en X días.',code:'$dias = 90; $fecha = (Get-Date).AddDays(-$dias)\n$inactivos = Get-ADUser -Filter {LastLogonDate -lt $fecha -and Enabled -eq $true} -Properties LastLogonDate\n$inactivos | ForEach-Object {\n  Disable-ADAccount -Identity $_\n  Write-Host "Deshabilitado: $($_.SamAccountName)"\n}\n$inactivos | Export-Csv "C:\\cuentas_inactivas.csv" -NoTypeInformation'},
  {s:'n3-scr',t:'tn',os:'win',sec:'Scripts',name:'📡 Ping Masivo Paralelo',tag:'PS',desc:'Escanea un rango de red completo en paralelo.',code:'1..254 | ForEach-Object -Parallel {\n  $ip = "192.168.1.$_"\n  if (Test-Connection -ComputerName $ip -Count 1 -Quiet -TimeoutSeconds 1) {\n    $hn = (Resolve-DnsName $ip -EA SilentlyContinue).NameHost\n    [PSCustomObject]@{ IP=$ip; Hostname=$hn; Estado="ACTIVO" }\n  }\n} -ThrottleLimit 50 | Sort-Object IP | Export-Csv C:\\scan_red.csv -NoTypeInformation'},
  {s:'n3-scr',t:'td',os:'win',sec:'Scripts',name:'⚠️ Alerta Disco Lleno',tag:'PS',desc:'Monitorea espacio y alerta cuando baja del umbral.',code:'$umbral = 15\nGet-WmiObject Win32_LogicalDisk -Filter "DriveType=3" | ForEach-Object {\n  $libre = [math]::Round(($_.FreeSpace / $_.Size) * 100, 1)\n  $msg = "[$($_.DeviceID)] $libre% libre de $([math]::Round($_.Size/1GB))GB"\n  if ($libre -lt $umbral) { Write-Warning "DISCO BAJO: $msg" }\n  else { Write-Host "OK: $msg" }\n}'},
  {s:'n3-scr',t:'ts',os:'win',sec:'Scripts',name:'🧹 Limpieza Temp Masiva',tag:'PS',desc:'Limpia temporales de todos los perfiles del sistema.',code:'$rutas = @("C:\\Windows\\Temp") + (Get-ChildItem "C:\\Users" -Directory | ForEach-Object { "C:\\Users\\$($_.Name)\\AppData\\Local\\Temp" })\n$total = 0\nforeach ($ruta in $rutas) {\n  if (Test-Path $ruta) {\n    $size = (Get-ChildItem $ruta -Recurse -EA SilentlyContinue | Measure-Object Length -Sum).Sum\n    Get-ChildItem $ruta -Recurse -EA SilentlyContinue | Remove-Item -Recurse -Force -EA SilentlyContinue\n    $total += $size; Write-Host "Limpiado: $ruta ($([math]::Round($size/1MB,1)) MB)"\n  }\n}\nWrite-Host "Total liberado: $([math]::Round($total/1MB,1)) MB"'},
  {s:'n3-scr',t:'ta',os:'win',sec:'Scripts',name:'📊 Reporte Uptime Servidores',tag:'PS',desc:'Reporte de uptime y estado de múltiples servidores.',code:'$servers = @("SRV-DC01","SRV-FILE01","SRV-APP01","SRV-SQL01")\n$report = foreach ($s in $servers) {\n  $os = Get-WmiObject Win32_OperatingSystem -ComputerName $s -EA SilentlyContinue\n  if ($os) { $up = (Get-Date) - $os.ConvertToDateTime($os.LastBootUpTime)\n    [PSCustomObject]@{ Servidor=$s; UptimeDias=[math]::Round($up.TotalDays,1); Estado="Online" }\n  } else { [PSCustomObject]@{ Servidor=$s; Estado="Offline" } }\n}\n$report | Format-Table -AutoSize'}
];

// Section metadata for rendering
const SECTIONS_META = {
  'n1-red':{lvl:'l1',lvlTxt:'● N1 — Helpdesk',icon:'🌐',title:'Red &amp; Conectividad',desc:'// diagnóstico de conexión, DNS, routing y puertos · separado por OS',hasTabs:true},
  'n1-sis':{lvl:'l1',lvlTxt:'● N1 — Helpdesk',icon:'💻',title:'Sistema &amp; SO',desc:'// info del equipo, actualizaciones, arranque y hardware'},
  'n1-usr':{lvl:'l1',lvlTxt:'● N1 — Helpdesk',icon:'👤',title:'Usuarios &amp; Cuentas',desc:'// gestión de cuentas locales, contraseñas y sesiones'},
  'n2-disk':{lvl:'l2',lvlTxt:'● N2 — Técnico',icon:'💾',title:'Disco &amp; Storage',desc:'// particiones, espacio, SMART, permisos y sistema de archivos'},
  'n2-proc':{lvl:'l2',lvlTxt:'● N2 — Técnico',icon:'⚙️',title:'Procesos &amp; Servicios',desc:'// gestión de procesos, servicios y tareas programadas'},
  'n2-logs':{lvl:'l2',lvlTxt:'● N2 — Técnico',icon:'📋',title:'Logs &amp; Eventos',desc:'// visor de eventos, análisis de logs y auditoría del sistema'},
  'n2-rem':{lvl:'l2',lvlTxt:'● N2 — Técnico',icon:'🔗',title:'Acceso Remoto',desc:'// RDP, SSH, WinRM y gestión de equipos remotos'},
  'n3-ad':{lvl:'l3',lvlTxt:'● N3 — Sysadmin',icon:'🏢',title:'Active Directory',desc:'// usuarios, grupos, GPO, OUs, replicación y domain health'},
  'n3-sec':{lvl:'l3',lvlTxt:'● N3 — Sysadmin',icon:'🔐',title:'Seguridad',desc:'// firewall, certificados, auditoría, antivirus y detección de amenazas'},
  'n3-srv':{lvl:'l3',lvlTxt:'● N3 — Sysadmin',icon:'🖥️',title:'Servidores &amp; Virtualización',desc:'// IIS, DNS, DHCP, Hyper-V, Docker, Exchange y M365'},
  'n3-scr':{lvl:'l3',lvlTxt:'● N3 — Sysadmin',icon:'📜',title:'Scripts PowerShell',desc:'// scripts listos para copiar, adaptar y ejecutar en tu entorno'}
};

// ═══════════════════════════════════════════
// CUSTOM COMMANDS (CRUD)
// ═══════════════════════════════════════════
const CUSTOM_CMDS_KEY = 'itk_custom_cmds';
let CUSTOM_CMDS = [];

function loadCustomCmds() {
  try {
    const raw = localStorage.getItem(CUSTOM_CMDS_KEY);
    const parsed = raw ? JSON.parse(raw) : [];
    CUSTOM_CMDS = Array.isArray(parsed) ? parsed : [];
  } catch(e) { CUSTOM_CMDS = []; }
}

function saveCustomCmds() {
  localStorage.setItem(CUSTOM_CMDS_KEY, JSON.stringify(CUSTOM_CMDS));
}

// EXPORT COMMANDS AS JSON
function exportCustomCmds() {
  const customCmds = JSON.parse(localStorage.getItem('itk_custom_cmds') || '[]');
  if (customCmds.length === 0) {
    toast('⚠️ No hay comandos para descargar');
    return;
  }
  
  const data = {
    version: "4.0",
    timestamp: new Date().toISOString(),
    count: customCmds.length,
    commands: customCmds
  };
  
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `mis-comandos-${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
  toast(`✅ Descargados ${customCmds.length} comandos`);
}

// IMPORT COMMANDS FROM JSON
function importCustomCmds() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = event => {
      try {
        const data = JSON.parse(event.target.result);
        
        if (!data.commands || !Array.isArray(data.commands)) {
          throw new Error('Formato JSON inválido. Esperaba { commands: [...] }');
        }
        
        // Merge: evita duplicados por ID
        const existing = JSON.parse(localStorage.getItem('itk_custom_cmds') || '[]');
        const existingIds = new Set(existing.map(c => c.id));
        const newCmds = data.commands.filter(c => !existingIds.has(c.id));
        
        const merged = [...existing, ...newCmds];
        localStorage.setItem('itk_custom_cmds', JSON.stringify(merged));
        CUSTOM_CMDS = merged;
        
        renderCustomList();
        renderAllCards();
        
        toast(`✅ Importados ${newCmds.length} comandos nuevos (${existingIds.size} no duplicados)`);
      } catch(err) {
        toast(`❌ Error: ${err.message}`);
        console.error(err);
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

function updateCommandCount() {
  const sCEl = document.getElementById('sC');
  if (sCEl) sCEl.textContent = COMMANDS_DB.length + (CUSTOM_CMDS ? CUSTOM_CMDS.length : 0);
}

function sectionLabel(secId) {
  const m = SECTIONS_META[secId];
  if (!m) return secId || 'General';
  return m.title.replace(/&amp;/g,'&');
}

function getCustomOs() {
  const os = [];
  if (document.getElementById('cc-os-win')?.checked) os.push('win');
  if (document.getElementById('cc-os-lin')?.checked) os.push('lin');
  if (document.getElementById('cc-os-mac')?.checked) os.push('mac');
  return os.length ? os.join(' ') : 'win';
}

function setCustomForm(cmd) {
  if (!cmd) return;
  document.getElementById('cc-id').value = cmd.id || '';
  document.getElementById('cc-name').value = cmd.name || '';
  document.getElementById('cc-desc').value = cmd.desc || '';
  document.getElementById('cc-tag').value = cmd.tag || '';
  document.getElementById('cc-sec').value = cmd.s || 'n1-red';
  document.getElementById('cc-code').value = cmd.code || '';
  const os = (cmd.os || '').split(' ');
  document.getElementById('cc-os-win').checked = os.includes('win');
  document.getElementById('cc-os-lin').checked = os.includes('lin');
  document.getElementById('cc-os-mac').checked = os.includes('mac');
}

function clearCustomForm() {
  document.getElementById('cc-id').value = '';
  document.getElementById('cc-name').value = '';
  document.getElementById('cc-desc').value = '';
  document.getElementById('cc-tag').value = '';
  document.getElementById('cc-sec').value = 'n1-red';
  document.getElementById('cc-code').value = '';
  document.getElementById('cc-os-win').checked = true;
  document.getElementById('cc-os-lin').checked = false;
  document.getElementById('cc-os-mac').checked = false;
}

function renderCustomList() {
  const list = document.getElementById('customList');
  const countA = document.getElementById('customCount');
  const countB = document.getElementById('customCountFeed');
  const total = CUSTOM_CMDS.length;
  if (countA) countA.textContent = total;
  if (countB) countB.textContent = total;
  if (!list) return;
  if (!CUSTOM_CMDS.length) {
    list.innerHTML = '<div class="custom-empty">// Sin comandos personalizados</div>';
    return;
  }
  list.innerHTML = CUSTOM_CMDS.map(c => `
    <div class="custom-item" data-id="${c.id}">
      <div class="ci-top">
        <div class="ci-name">${c.name}</div>
        <div class="ci-actions">
          <button class="nbtn" onclick="editCustomCmd('${c.id}')">✎</button>
          <button class="nbtn del" onclick="deleteCustomCmd('${c.id}')">🗑️</button>
        </div>
      </div>
      <div class="ci-meta">${sectionLabel(c.s)} · ${c.tag || 'CUSTOM'}</div>
      <div class="custom-os">${(c.os || 'win').split(' ').map(o => ({win:'<span class="cos cos-w">WIN</span>',lin:'<span class="cos cos-l">LIN</span>',mac:'<span class="cos cos-m">MAC</span>'}[o]||'')).join('')}</div>
    </div>
  `).join('');
}

function initCustomCmds() {
  const sel = document.getElementById('cc-sec');
  if (sel) {
    sel.innerHTML = Object.keys(SECTIONS_META).map(id => {
      const m = SECTIONS_META[id];
      return `<option value="${id}">${m.icon} ${sectionLabel(id)}</option>`;
    }).join('');
  }
  renderCustomList();
}

function saveCustomCmd() {
  const id = document.getElementById('cc-id').value || 'cc_' + Date.now();
  const name = document.getElementById('cc-name').value.trim();
  const desc = document.getElementById('cc-desc').value.trim() || 'Comando personalizado.';
  const tag = document.getElementById('cc-tag').value.trim() || 'CUSTOM';
  const s = document.getElementById('cc-sec').value;
  const os = getCustomOs();
  const code = document.getElementById('cc-code').value.trim();
  if (!name || !code) { toast('⚠️ Nombre y comandos son obligatorios'); return; }
  const sec = sectionLabel(s);
  const cmd = { id, s, t:'tn', os, sec, name, tag, desc, code };
  const idx = CUSTOM_CMDS.findIndex(c => c.id === id);
  if (idx >= 0) CUSTOM_CMDS[idx] = cmd;
  else CUSTOM_CMDS.unshift(cmd);
  saveCustomCmds();
  renderCustomList();
  renderCommandCards(s, true);
  applyCommandCodeFilter();
  updateCommandCount();
  clearCustomForm();
  toast('✅ Comando personalizado guardado');
}

function editCustomCmd(id) {
  const cmd = CUSTOM_CMDS.find(c => c.id === id);
  if (!cmd) return;
  setCustomForm(cmd);
  showSec('home');
}

function deleteCustomCmd(id) {
  const cmd = CUSTOM_CMDS.find(c => c.id === id);
  if (!cmd) return;
  if (!confirm('¿Eliminar comando personalizado "' + cmd.name + '"?')) return;
  CUSTOM_CMDS = CUSTOM_CMDS.filter(c => c.id !== id);
  saveCustomCmds();
  renderCustomList();
  renderCommandCards(cmd.s, true);
  applyCommandCodeFilter();
  updateCommandCount();
  toast('🗑️ Comando eliminado');
}

function buildCardHTML(cmd) {
  const osArr = cmd.os.split(' ');
  const osBadges = osArr.map(o => ({win:'<span class="ob ob-w">🪟WIN</span>',lin:'<span class="ob ob-l">🐧LIN</span>',mac:'<span class="ob ob-m">🍎MAC</span>'}[o]||'')).join('');
  return `<div class="cmd-card ${cmd.t}" data-os="${cmd.os}" data-sec="${cmd.sec}"><div class="ct"><span class="cmd-name">${cmd.name}</span><span class="cmd-tag">${cmd.tag}</span></div><div class="cmd-desc">${cmd.desc}</div><div class="cmd-code">${cmd.code}</div><div class="cf"><div class="os-bs">${osBadges}</div><div class="cmd-acts"><button class="fvb" onclick="toggleFav(this)" title="Agregar/quitar de favoritos">⭐</button><button class="cpb" onclick="cpCmd(this)" title="Copiar comando al portapapeles">⧉</button></div></div></div>`;
}

function getAllCommands() {
  return COMMANDS_DB.concat(CUSTOM_CMDS || []);
}

function renderCommandCards(secId, force = false) {
  const grid = document.getElementById('g-'+secId);
  if (!grid) return;
  if (grid.dataset.rendered === '1' && !force) return; // already rendered
  const cards = getAllCommands().filter(c => c.s === secId);
  grid.innerHTML = cards.map(buildCardHTML).join('\n    ');
  grid.dataset.rendered = '1';
  // Re-apply favs state
  if (typeof loadFavs === 'function') loadFavs();
}

function renderAllCards() {
  Object.keys(SECTIONS_META).forEach(renderCommandCards);
}

// ═══════════════════════════════════════════
// OS TABS (within section)
// ═══════════════════════════════════════════
const ALT_OS_CMDS = {
  '🔧 Reset TCP/IP Stack': {
    lin: 'sudo sysctl -w net.ipv4.ip_forward=1\nsudo systemctl restart NetworkManager || sudo systemctl restart networking\nsudo ip addr flush dev eth0 && sudo dhclient eth0',
    mac: 'sudo ifconfig en0 down && sudo ifconfig en0 up\nsudo dscacheutil -flushcache\nsudo route -n flush'
  },
  '🔩 Reparar SO (SFC/DISM)': {
    lin: 'sudo fsck -Af -M\nsudo debsums -s  # Debian/Ubuntu\nsudo dnf reinstall "*" --setopt=install_weak_deps=False  # RHEL/Fedora',
    mac: 'diskutil verifyVolume /\ndiskutil resetUserPermissions / `id -u`\nsudo softwareupdate --install --all'
  },
  '🔒 BitLocker Status': {
    lin: 'lsblk -f\nsudo cryptsetup status LUKS_DEV\nsudo dmsetup ls --target crypt',
    mac: 'fdesetup status\ndiskutil apfs list\nsudo fdesetup list'
  },
  '🗂️ DiskPart': {
    lin: 'sudo lsblk -o NAME,SIZE,FSTYPE,MOUNTPOINT\nsudo fdisk -l\nsudo parted -l',
    mac: 'diskutil list\ndiskutil info disk0\nsudo gpt -r show disk0'
  },
  '🛡️ Permisos NTFS': {
    lin: 'getfacl /ruta\nsetfacl -m u:usuario:rwx /ruta\nchown -R usuario:grupo /ruta',
    mac: 'ls -le /ruta\nchmod -R 755 /ruta\nchown -R usuario:staff /ruta'
  },
  '🧹 Limpiar Temporales': {
    lin: 'sudo rm -rf /tmp/* /var/tmp/*\nsudo journalctl --vacuum-time=7d\nsudo apt clean || sudo dnf clean all',
    mac: 'rm -rf ~/Library/Caches/*\nsudo rm -rf /Library/Caches/*\nsudo periodic daily weekly monthly'
  },
  '🖨️ Cola de Impresión': {
    lin: 'sudo systemctl stop cups\nsudo cancel -a\nsudo systemctl start cups',
    mac: 'sudo launchctl stop org.cups.cupsd\ncancel -a\nsudo launchctl start org.cups.cupsd'
  },
  '💥 Análisis BSOD': {
    lin: 'journalctl -b -1 -p err..alert --no-pager\ncoredumpctl list\ndmesg -T | tail -n 120',
    mac: 'log show --last 1h --predicate "eventType == crash"\nls -lah ~/Library/Logs/DiagnosticReports\npanic -a 2>/dev/null || true'
  },
  '💾 Exportar Logs': {
    lin: 'journalctl -b --no-pager > /tmp/system_journal.log\nsudo cp /var/log/syslog /tmp/syslog_$(date +%F).log\ngrep -iE "error|fail" /var/log/auth.log > /tmp/auth_errors.log',
    mac: 'log show --last 24h > ~/Desktop/macos_logs_$(date +%F).log\nsyslog -C > ~/Desktop/syslog_snapshot.log\ncp /var/log/system.log ~/Desktop/system_$(date +%F).log'
  },
  '🖥️ Conexión RDP': {
    lin: 'xfreerdp /v:192.168.1.100 /u:USUARIO /cert:ignore\nremmina -c rdp://USUARIO@192.168.1.100\nrdesktop -u USUARIO 192.168.1.100',
    mac: 'open -a "Microsoft Remote Desktop"\n/Applications/Microsoft\ Remote\ Desktop.app/Contents/MacOS/Microsoft\ Remote\ Desktop\nopen "rdp://full%20address=s:192.168.1.100"'
  },
  '⚡ PowerShell Remoto': {
    lin: 'pwsh -c "Enter-PSSession -HostName server -UserName admin"\nssh admin@server\nansible all -i inventario -m ping',
    mac: 'pwsh -c "Invoke-Command -HostName server -UserName admin -ScriptBlock {hostname}"\nssh admin@server\nmosh usuario@server'
  },
  '📊 Sesiones RDP Activas': {
    lin: 'who\nw\nloginctl list-sessions',
    mac: 'who\nw\nlast | head -20'
  },
  '🔍 Buscar Usuario AD': {
    lin: 'getent passwd jgarcia\nid jgarcia\nldapsearch -x -H ldap://dc.empresa.local -b "dc=empresa,dc=local" "(sAMAccountName=jgarcia)"',
    mac: 'id jgarcia\ndscl /Search -search /Users RecordName jgarcia\nldapsearch -x -H ldap://dc.empresa.local -b "dc=empresa,dc=local" "(uid=jgarcia)"'
  },
  '🔓 Desbloquear + Reset AD': {
    lin: 'sudo samba-tool user unlock jgarcia\nsudo samba-tool user setpassword jgarcia --newpassword="Temp2026#!"\nkinit administrador@EMPRESA.LOCAL',
    mac: 'pwsh -c "Unlock-ADAccount -Identity jgarcia"\npwsh -c "Set-ADAccountPassword -Identity jgarcia -Reset -NewPassword (ConvertTo-SecureString \"Temp2026#!\" -AsPlainText -Force)"\nldapmodify -x -H ldap://dc.empresa.local -D "cn=admin,dc=empresa,dc=local" -W'
  },
  '👥 Grupos AD': {
    lin: 'id jgarcia\ngetent group "Administradores TI"\nsamba-tool group listmembers "Administradores TI"',
    mac: 'dscacheutil -q group -a name "Administradores TI"\nldapsearch -x -H ldap://dc.empresa.local -b "dc=empresa,dc=local" "(cn=Administradores TI)" member\npwsh -c "Get-ADPrincipalGroupMembership jgarcia | Select Name"'
  },
  '🏗️ Onboarding AD': {
    lin: 'sudo samba-tool user create jgarcia Temp2026#! --given-name=Juan --surname=Garcia --mail-address=jgarcia@empresa.com\nsudo samba-tool group addmembers Grupo_Ventas jgarcia\ngetent passwd jgarcia',
    mac: 'pwsh -c "New-ADUser -Name \"Juan Garcia\" -SamAccountName jgarcia -Enabled $true -AccountPassword (ConvertTo-SecureString \"Temp2026#!\" -AsPlainText -Force)"\npwsh -c "Add-ADGroupMember Grupo_Ventas jgarcia"\nldapsearch -x -H ldap://dc.empresa.local -b "dc=empresa,dc=local" "(sAMAccountName=jgarcia)"'
  },
  '🚪 Offboarding AD': {
    lin: 'sudo samba-tool user disable jgarcia\nsudo samba-tool group removemembers Grupo_Ventas jgarcia\nldapsearch -x -H ldap://dc.empresa.local -b "dc=empresa,dc=local" "(sAMAccountName=jgarcia)" userAccountControl',
    mac: 'pwsh -c "Disable-ADAccount -Identity jgarcia"\npwsh -c "Set-ADUser -Identity jgarcia -Description \"Baja $(Get-Date -f dd/MM/yyyy)\""\npwsh -c "Move-ADObject -Identity (Get-ADUser jgarcia).DistinguishedName -TargetPath \"OU=Desactivados,DC=empresa,DC=local\""'
  },
  '🏛️ GPO & Directivas': {
    lin: 'sudo realm list\nsssctl domain-status empresa.local\n/opt/likewise/bin/lwgp info 2>/dev/null || true',
    mac: 'profiles show -type configuration\nprofiles renew -type enrollment\npwsh -c "gpresult /R"'
  },
  '🔄 Replicación AD': {
    lin: 'sudo samba-tool drs showrepl\nsudo samba-tool drs replicate DC2 DC1 dc=empresa,dc=local\nldapsearch -x -H ldap://dc.empresa.local -b "" -s base namingContexts',
    mac: 'pwsh -c "repadmin /replsummary"\npwsh -c "dcdiag /test:replications /v"\nldapsearch -x -H ldap://dc.empresa.local -b "dc=empresa,dc=local" "(objectClass=domainDNS)"'
  },
  '📊 Últimos Logins AD': {
    lin: 'sudo samba-tool user list\nsudo grep -i "authentication" /var/log/auth.log | tail -50\nldapsearch -x -H ldap://dc.empresa.local -b "dc=empresa,dc=local" "(objectClass=user)" lastLogonTimestamp',
    mac: 'pwsh -c "Get-ADUser -Filter * -Properties LastLogonDate | Sort LastLogonDate -Desc | Select -First 30 Name,LastLogonDate"\nlog show --last 1d --predicate "process == \"opendirectoryd\""\nldapsearch -x -H ldap://dc.empresa.local -b "dc=empresa,dc=local" "(objectClass=user)" | head -80'
  },
  '🦠 Windows Defender': {
    lin: 'sudo freshclam\nsudo clamscan -r /home --bell -i\nsudo systemctl status falcon-sensor || sudo systemctl status clamav-daemon',
    mac: 'softwareupdate --background-critical\n/usr/libexec/ApplicationFirewall/socketfilterfw --getglobalstate\nspctl --status'
  },
  '🏅 Certificados SSL': {
    lin: 'sudo trust list | head -50\nopenssl x509 -in cert.pem -noout -subject -dates\nfor c in /etc/ssl/certs/*.pem; do openssl x509 -in "$c" -noout -enddate; done | head -30',
    mac: 'security find-certificate -a -p /System/Library/Keychains/SystemRootCertificates.keychain | head -40\nsecurity find-identity -v -p ssl\nopenssl s_client -connect host:443 -servername host </dev/null | openssl x509 -noout -dates -subject'
  },
  '🗝️ Directiva Auditoría': {
    lin: 'sudo auditctl -s\nsudo auditctl -l\nsudo ausearch -m USER_LOGIN -ts today',
    mac: 'praudit /var/audit/current 2>/dev/null | head -80\nlog show --last 1h --predicate "eventMessage CONTAINS[c] \"auth\""\nsudo audit -s'
  },
  '📁 Recursos Compartidos SMB': {
    lin: 'smbclient -L //server -U usuario\ntestparm -s\nsudo smbstatus',
    mac: 'mount | grep smb\nsmbutil view //usuario@server\nsmbutil statshares -a'
  },
  '🌐 IIS Web Server': {
    lin: 'sudo systemctl status nginx || sudo systemctl status apache2\nsudo nginx -t && sudo systemctl reload nginx\nsudo apachectl configtest && sudo systemctl reload apache2',
    mac: 'brew services list | grep -E "nginx|httpd"\nsudo apachectl -t && sudo apachectl restart\nsudo nginx -t && sudo nginx -s reload'
  },
  '🗂️ DNS & DHCP Server': {
    lin: 'sudo named-checkconf && sudo rndc status\nsudo dhcpd -t -cf /etc/dhcp/dhcpd.conf\nsudo systemctl status named dhcpd',
    mac: 'scutil --dns\nsudo dscacheutil -flushcache\nnetworksetup -getinfo Wi-Fi'
  },
  '🖥️ Hyper-V VMs': {
    lin: 'virsh list --all\nvirsh start VMNAME && virsh shutdown VMNAME\nvirsh snapshot-list VMNAME',
    mac: 'prlctl list -a 2>/dev/null || true\nVBoxManage list vms 2>/dev/null || true\nutmctl list 2>/dev/null || true'
  },
  '📧 Exchange / M365': {
    lin: 'pwsh -c "Connect-ExchangeOnline -UserPrincipalName admin@empresa.com"\npwsh -c "Get-Mailbox -Identity usuario@empresa.com | Select ProhibitSendQuota"\nopen https://admin.microsoft.com 2>/dev/null || xdg-open https://admin.microsoft.com',
    mac: 'pwsh -c "Connect-ExchangeOnline -UserPrincipalName admin@empresa.com"\npwsh -c "Get-MailboxStatistics usuario | Select DisplayName,TotalItemSize"\nopen https://admin.exchange.microsoft.com'
  },
  '💾 Backup WSB + VSS': {
    lin: 'sudo rsync -aAXv / /backup/ --exclude={/proc,/sys,/dev,/run,/tmp}\nsudo tar -czf /backup/system_$(date +%F).tar.gz /etc /home\nsudo restic backup /etc /home',
    mac: 'tmutil startbackup --auto\ntmutil listbackups\nrsync -aE --progress /Users /Volumes/Backup/'
  },
  '📦 Inventario Equipos AD': {
    lin: 'getent passwd | awk -F: "{print $1,$3,$6}" > inventario_linux.csv\nhostnamectl; lscpu; free -h\nfor h in $(cat hosts.txt); do ping -c1 -W1 $h && echo "$h,UP"; done > inventario.csv',
    mac: 'system_profiler SPHardwareDataType SPSoftwareDataType > inventario_macos.txt\ndscl . list /Users > usuarios_macos.txt\npython3 - <<\'PY\'\nimport csv,platform;csv.writer(open("inventario_macos.csv","w")).writerow([platform.node(),platform.platform()])\nPY'
  },
  '🔴 Deshabilitar Cuentas Inactivas': {
    lin: 'sudo usermod -L USUARIO\nchage -l USUARIO\nlastlog | awk "NR==1 || $NF==\"Never\""',
    mac: 'sudo pwpolicy -u USUARIO -setpolicy "isDisabled=1"\ndscl . -read /Users/USUARIO\nlast | head -40'
  },
  '📡 Ping Masivo Paralelo': {
    lin: 'seq 1 254 | xargs -I{} -P 50 sh -c "ping -c1 -W1 192.168.1.{} >/dev/null && echo 192.168.1.{}"\nnmap -sn 192.168.1.0/24\nfping -a -g 192.168.1.0/24 2>/dev/null',
    mac: 'seq 1 254 | xargs -I{} -P 50 sh -c "ping -c1 -t1 192.168.1.{} >/dev/null && echo 192.168.1.{}"\nnmap -sn 192.168.1.0/24\nfor i in {1..254}; do ping -c1 192.168.1.$i >/dev/null && echo 192.168.1.$i; done'
  },
  '⚠️ Alerta Disco Lleno': {
    lin: 'df -hP | awk "NR>1{gsub(/%/,\"\",$5); if($5>85) print \"ALERTA:\",$6,$5\"%\"; else print \"OK:\",$6,$5\"%\"}"\nlsblk -f\nwatch -n 30 df -h',
    mac: 'df -h | awk "NR>1{gsub(/%/,\"\",$5); if($5>85) print \"ALERTA:\",$9,$5\"%\"; else print \"OK:\",$9,$5\"%\"}"\ndiskutil list\nwatch -n 30 df -h'
  },
  '🧹 Limpieza Temp Masiva': {
    lin: 'sudo find /tmp /var/tmp -type f -mtime +3 -delete\nsudo apt autoremove -y || sudo dnf autoremove -y\nsudo journalctl --vacuum-size=200M',
    mac: 'rm -rf ~/Library/Caches/*\nfind ~/Library/Logs -type f -mtime +15 -delete\nsudo rm -rf /private/var/tmp/*'
  },
  '📊 Reporte Uptime Servidores': {
    lin: 'for s in SRV-DC01 SRV-FILE01 SRV-APP01 SRV-SQL01; do ssh $s "echo -n \"$s,\"; uptime -p"; done\nfor s in $(cat servers.txt); do ping -c1 -W1 $s >/dev/null && echo "$s,Online" || echo "$s,Offline"; done\nansible all -i inventario -m shell -a "uptime -p"',
    mac: 'for s in SRV-DC01 SRV-FILE01 SRV-APP01 SRV-SQL01; do ssh $s "uptime"; done\nsystem_profiler SPSoftwareDataType | grep "Time since boot"\npython3 - <<\'PY\'\nimport subprocess; print(subprocess.check_output(["uptime"]).decode())\nPY'
  }
};

function hasAltForOs(card, os) {
  if (os === 'all') return false;
  const name = card?.querySelector('.cmd-name')?.innerText || '';
  return !!(ALT_OS_CMDS[name] && ALT_OS_CMDS[name][os]);
}

function osTab(tab, secId, os) {
  const bar = tab.closest('.os-tab-bar');
  bar.querySelectorAll('.os-tab').forEach(t => t.classList.remove('on'));
  tab.classList.add('on');
  const grid = document.getElementById('g-'+secId) || tab.closest('.sec').querySelector('.cmd-grid');
  if (!grid) return;
  grid.querySelectorAll('.cmd-card').forEach(card => {
    if (os === 'all') { card.classList.remove('osh'); }
    else {
      const cardOs = card.dataset.os || '';
      const canShow = cardOs.includes(os) || hasAltForOs(card, os);
      card.classList.toggle('osh', !canShow);
    }
  });
  applyCommandCodeFilter();
}

// ═══════════════════════════════════════════
// GLOBAL OS FILTER
// ═══════════════════════════════════════════
let curOsF = 'all';
function setOsF(os) {
  curOsF = os;
  ['all','win','lin','mac'].forEach(o => {
    const pill = document.getElementById('pill-'+o);
    if (pill) pill.classList.toggle('on', o === os);
  });
  document.querySelectorAll('.cmd-card').forEach(card => {
    if (os === 'all') { card.classList.remove('osh'); }
    else {
      const cardOs = card.dataset.os || '';
      const canShow = cardOs.includes(os) || hasAltForOs(card, os);
      card.classList.toggle('osh', !canShow);
    }
  });
  applyCommandCodeFilter();
}

function detectSectionOsFilter(sec) {
  if (!sec) return 'all';
  const onTab = sec.querySelector('.os-tab-bar .os-tab.on');
  if (!onTab) return 'all';
  const click = onTab.getAttribute('onclick') || '';
  const m = click.match(/,'([^']+)'\)\s*$/);
  return m ? m[1] : 'all';
}

function filterCommandTextByOs(raw, os) {
  if (!raw || os === 'all') return raw || '';
  const iconMap = { win:'🪟', lin:'🐧', mac:'🍎' };
  const target = iconMap[os];
  if (!target) return raw;
  const lines = raw.split('\n');
  let keep = true;
  const out = [];
  const iconPrefix = /^\s*([🪟🐧🍎]+)\s*/;
  for (const line of lines) {
    const m = line.match(iconPrefix);
    if (m) {
      const icons = m[1];
      keep = icons.includes(target);
      if (keep) out.push(line.replace(iconPrefix, ''));
    } else if (keep) {
      out.push(line);
    }
  }
  return out.join('\n').trim();
}

function applyCommandCodeFilter() {
  document.querySelectorAll('.cmd-card .cmd-code').forEach(codeEl => {
    const card = codeEl.closest('.cmd-card');
    if (!card) return;
    if (!card.dataset.codeRaw) card.dataset.codeRaw = codeEl.innerText;
    const sec = card.closest('.sec');
    const sectionOs = detectSectionOsFilter(sec);
    const effectiveOs = curOsF !== 'all' ? curOsF : sectionOs;
    const cardOs = card.dataset.os || '';
    if (effectiveOs !== 'all' && !cardOs.includes(effectiveOs) && hasAltForOs(card, effectiveOs)) {
      const name = card.querySelector('.cmd-name')?.innerText || '';
      codeEl.innerText = ALT_OS_CMDS[name][effectiveOs];
      return;
    }
    const filtered = filterCommandTextByOs(card.dataset.codeRaw, effectiveOs);
    codeEl.innerText = filtered || card.dataset.codeRaw;
  });
}

// ═══════════════════════════════════════════
// COPY COMMAND
// ═══════════════════════════════════════════
function cpCmd(btn) {
  const card = btn.closest('.cmd-card');
  const code = card.querySelector('.cmd-code').innerText;
  const name = card.querySelector('.cmd-name').innerText;
  const sec = card.dataset.sec || '—';
  const os = card.dataset.os || '—';
  navigator.clipboard.writeText(code).then(() => {
    card.classList.add('cp');
    setTimeout(() => card.classList.remove('cp'), 700);
    toast('⧉ Copiado: ' + name);
    logHistory({name, code, sec, os});
  }).catch(() => {
    const ta = document.createElement('textarea');
    ta.value = code; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy');
    document.body.removeChild(ta);
    card.classList.add('cp');
    setTimeout(() => card.classList.remove('cp'), 700);
    toast('⧉ Copiado: ' + name);
    logHistory({name, code, sec, os});
  });
}

function copyTxt(el) {
  const txt = el.innerText;
  navigator.clipboard.writeText(txt).then(() => {
    toast('⧉ Copiado: ' + txt);
  }).catch(() => {
    try {
      const ta = document.createElement('textarea');
      ta.value = txt;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      toast('⧉ Copiado: ' + txt);
    } catch(e) {
      toast('⚠️ No se pudo copiar automáticamente');
    }
  });
}

// ═══════════════════════════════════════════
// FAVORITES
// ═══════════════════════════════════════════
let favs = [];
function loadFavs() {
  try { favs = JSON.parse(localStorage.getItem('itk_favs') || '[]'); } catch(e){ favs=[]; }
  document.querySelectorAll('.fvb').forEach(btn => {
    const card = btn.closest('.cmd-card');
    const name = card.querySelector('.cmd-name').innerText;
    btn.classList.toggle('on', favs.some(f => f.name === name));
  });
  updateFavCnt();
}

function saveFavs() {
  try { localStorage.setItem('itk_favs', JSON.stringify(favs)); } catch(e){}
  updateFavCnt();
}

function updateFavCnt() {
  const c = favs.length;
  document.getElementById('favCnt').textContent = c;
  document.getElementById('sF').textContent = c;
}

function toggleFav(btn) {
  const card = btn.closest('.cmd-card');
  const name = card.querySelector('.cmd-name').innerText;
  const code = card.querySelector('.cmd-code').innerText;
  const sec = card.dataset.sec || '';
  const os = card.dataset.os || '';
  const desc = card.querySelector('.cmd-desc').innerText;
  const tag = card.querySelector('.cmd-tag').innerText;
  const obs = card.querySelector('.os-bs').innerHTML;
  const cls = [...card.classList].filter(c => ['tn','ts','td','tp','tu','tc2','tr','tl','ta','tex'].includes(c)).join(' ');
  const idx = favs.findIndex(f => f.name === name);
  if (idx === -1) {
    favs.push({name, code, sec, os, desc, tag, obs, cls});
    btn.classList.add('on');
    toast('⭐ Guardado en favoritos');
  } else {
    favs.splice(idx, 1);
    btn.classList.remove('on');
    toast('✕ Eliminado de favoritos');
  }
  saveFavs();
}

function renderFavs() {
  const c = document.getElementById('favsContainer');
  if (!favs.length) { c.innerHTML = '<div class="fav-empty">// Sin favoritos — pulsa ⭐ en cualquier tarjeta</div>'; return; }
  c.innerHTML = '<div class="cmd-grid">' + favs.map(f => `
    <div class="cmd-card ${f.cls}" data-os="${f.os}" data-sec="${f.sec}">
      <div class="ct"><span class="cmd-name">${f.name}</span><span class="cmd-tag">${f.tag}</span></div>
      <div class="cmd-desc">${f.desc}</div>
      <div class="cmd-code">${f.code}</div>
      <div class="cf"><div class="os-bs">${f.obs}</div>
      <div class="cmd-acts">
        <button class="fvb on" onclick="toggleFav(this)" title="Quitar de favoritos">⭐</button>
        <button class="cpb" onclick="cpCmd(this)" title="Copiar comando al portapapeles">⧉</button>
      </div></div>
    </div>`).join('') + '</div>';
}

// ═══════════════════════════════════════════
// HISTORY
// ═══════════════════════════════════════════
let history = [];
function loadHistory() {
  try { history = JSON.parse(localStorage.getItem('itk_history') || '[]'); } catch(e){ history=[]; }
  updateHistCnt();
}

function saveHistory() {
  try { localStorage.setItem('itk_history', JSON.stringify(history.slice(0,200))); } catch(e){}
  updateHistCnt();
}

function updateHistCnt() {
  const c = history.length;
  document.getElementById('histCnt').textContent = c;
  document.getElementById('sH').textContent = c;
}

function logHistory(entry) {
  history.unshift({...entry, ts: new Date().toISOString()});
  saveHistory();
}

function renderHistory() {
  const list = document.getElementById('histList');
  if (!history.length) { list.innerHTML = '<div class="h-empty">// Aún no has copiado ningún comando</div>'; return; }
  list.innerHTML = history.slice(0,100).map((h, i) => {
    const d = new Date(h.ts);
    const ts = d.toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'}) + ' ' + d.toLocaleDateString('es',{day:'2-digit',month:'2-digit'});
    return `<div class="h-entry" onclick="goHistory(${i})" role="button" tabindex="0">
      <span class="h-ico">⚡</span>
      <div class="h-bd">
        <div class="h-nm">${h.name}</div>
        <div class="h-code">${h.code.split('\n')[0].substring(0,80)}...</div>
        <div class="h-meta"><span>${h.sec}</span><span>${h.os}</span><span>${ts}</span></div>
      </div>
    </div>`;
  }).join('');
  // Stats
  const today = new Date().toDateString();
  const todayCount = history.filter(h => new Date(h.ts).toDateString() === today).length;
  const nameCount = {};
  history.forEach(h => nameCount[h.name] = (nameCount[h.name]||0)+1);
  const topName = Object.entries(nameCount).sort((a,b)=>b[1]-a[1])[0];
  const secCount = {};
  history.forEach(h => secCount[h.sec] = (secCount[h.sec]||0)+1);
  const topSec = Object.entries(secCount).sort((a,b)=>b[1]-a[1])[0];
  const osCount = {};
  history.forEach(h => (h.os||'').split(' ').forEach(o => { if(o) osCount[o]=(osCount[o]||0)+1; }));
  const topOs = Object.entries(osCount).sort((a,b)=>b[1]-a[1])[0];
  document.getElementById('hs1').textContent = history.length;
  document.getElementById('hs2').textContent = todayCount;
  document.getElementById('hs3').textContent = topName ? topName[0] : '—';
  document.getElementById('hs4').textContent = topSec ? topSec[0] : '—';
  document.getElementById('hs5').textContent = topOs ? topOs[0] : '—';
}

function goHistory(i) {
  const h = history[i];
  if (!h) return;
  const all = getAllCommands();
  let cmd = all.find(c => c.name === h.name && c.sec === h.sec);
  if (!cmd) cmd = all.find(c => c.name === h.name);
  if (!cmd) { toast('⚠️ Comando no encontrado'); return; }
  showSec(cmd.s);
  setTimeout(() => {
    const grid = document.getElementById('g-' + cmd.s);
    if (!grid) return;
    const card = [...grid.querySelectorAll('.cmd-card')].find(c => {
      const name = c.querySelector('.cmd-name')?.innerText || '';
      return name === cmd.name;
    });
    if (!card) { toast('⚠️ Tarjeta no disponible'); return; }
    card.scrollIntoView({behavior:'smooth',block:'center'});
    card.style.boxShadow = '0 0 0 3px rgba(var(--ear),.4)';
    setTimeout(() => card.style.boxShadow = '', 1200);
  }, 100);
}

function exportHistory() {
  if (!history.length) { toast('Sin historial que exportar'); return; }
  const csv = 'Nombre,Sección,OS,Timestamp,Código\n' + history.map(h =>
    `"${h.name}","${h.sec}","${h.os}","${h.ts}","${h.code.replace(/"/g,'""').replace(/\n/g,' | ')}"`
  ).join('\n');
  dlFile('historial_comandos.csv', csv, 'text/csv');
  toast('📊 Historial exportado');
}

function clearHistory() {
  if (!confirm('¿Borrar todo el historial?')) return;
  history = [];
  saveHistory();
  renderHistory();
  toast('🗑️ Historial borrado');
}

// ═══════════════════════════════════════════
// CHECKLIST
// ═══════════════════════════════════════════
function chk(el) {
  el.classList.toggle('dn');
  el.querySelector('.chbox').textContent = el.classList.contains('dn') ? '✓' : '';
}

function resetChks() {
  document.querySelectorAll('.chi').forEach(c => {
    c.classList.remove('dn');
    c.querySelector('.chbox').textContent = '';
  });
}

// ═══════════════════════════════════════════
// SEARCH (with keyboard navigation)
// ═══════════════════════════════════════════
const srchIn = document.getElementById('gSearch');
const sDrop = document.getElementById('sDrop');
let _srIdx = -1; // active search result index

srchIn.addEventListener('input', () => { _srIdx = -1; doSearch(); });
srchIn.addEventListener('focus', () => { if(srchIn.value) sDrop.classList.add('open'); srchIn.setAttribute('aria-expanded','true'); });
document.addEventListener('click', e => { if (!e.target.closest('.srch-wrap')) { sDrop.classList.remove('open'); srchIn.setAttribute('aria-expanded','false'); } });

// Global keyboard shortcuts
document.addEventListener('keydown', e => {
  // Ctrl+K / Cmd+K → focus search
  if ((e.ctrlKey || e.metaKey) && e.key === 'k') { e.preventDefault(); srchIn.focus(); srchIn.select(); return; }
  // Escape → close search / sidebar
  if (e.key === 'Escape') {
    if (sDrop.classList.contains('open')) { sDrop.classList.remove('open'); srchIn.value = ''; srchIn.setAttribute('aria-expanded','false'); _srIdx = -1; return; }
    const sb = document.getElementById('sidebarNav');
    if (sb && sb.classList.contains('open')) { toggleSidebar(); return; }
  }
  // Arrow keys in search results
  if (sDrop.classList.contains('open') && (e.key === 'ArrowDown' || e.key === 'ArrowUp')) {
    e.preventDefault();
    const items = sDrop.querySelectorAll('.sr-item');
    if (!items.length) return;
    items.forEach(it => it.classList.remove('sr-active'));
    if (e.key === 'ArrowDown') _srIdx = (_srIdx + 1) % items.length;
    else _srIdx = _srIdx <= 0 ? items.length - 1 : _srIdx - 1;
    items[_srIdx].classList.add('sr-active');
    items[_srIdx].scrollIntoView({block:'nearest'});
    return;
  }
  // Enter on active search result
  if (e.key === 'Enter' && sDrop.classList.contains('open') && _srIdx >= 0) {
    e.preventDefault();
    goResult(_srIdx);
    _srIdx = -1;
    return;
  }
});

// Sidebar keyboard: Enter/Space activates nav-item
document.getElementById('sidebarNav').addEventListener('keydown', e => {
  if ((e.key === 'Enter' || e.key === ' ') && e.target.classList.contains('nav-item')) {
    e.preventDefault();
    e.target.click();
  }
  // Arrow Up/Down navigates between nav-items
  if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
    const items = [...document.querySelectorAll('.nav-item[tabindex]')];
    const ci = items.indexOf(e.target);
    if (ci < 0) return;
    e.preventDefault();
    const ni = e.key === 'ArrowDown' ? (ci + 1) % items.length : (ci <= 0 ? items.length - 1 : ci - 1);
    items[ni].focus();
  }
});

function doSearch() {
  const q = srchIn.value.toLowerCase().trim();
  if (!q) { sDrop.classList.remove('open'); srchIn.setAttribute('aria-expanded','false'); return; }
  const esc = s => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const hl = (txt, q) => { const re = new RegExp('('+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','gi'); return esc(txt).replace(re,'<span class="sr-hl">$1</span>'); };
  const cards = document.querySelectorAll('.cmd-card[data-sec]');
  const results = [];
  cards.forEach(card => {
    if (card.classList.contains('osh') || card.classList.contains('hid')) return;
    const secEl = card.closest('.sec');
    const secId = secEl ? secEl.id : '';
    const curEnv = document.body.getAttribute('data-env') || 'default';
    if (secId && !isSidebarItemAllowed(secId, curEnv)) return;
    const name = card.querySelector('.cmd-name')?.innerText || '';
    const desc = card.querySelector('.cmd-desc')?.innerText || '';
    const code = card.querySelector('.cmd-code')?.innerText || '';
    const sec = card.dataset.sec || '';
    const os = card.dataset.os || '';
    if ((name+desc+code+sec).toLowerCase().includes(q)) {
      results.push({name, code: code.split('\n')[0], sec, os, card});
    }
  });
  // Also search cheatsheet
  const envOkForCheat = isSidebarItemAllowed('cheat', document.body.getAttribute('data-env') || 'default');
  if (envOkForCheat) document.querySelectorAll('.ch-row').forEach(row => {
    const lbl = row.querySelector('.cheat-label')?.innerText || '';
    const val = row.querySelector('.cheat-val')?.innerText || '';
    if ((lbl+val).toLowerCase().includes(q)) {
      results.push({name: lbl, code: val, sec: 'Puertos', os: 'all', card: null, isPort: true});
    }
  });
  if (!results.length) {
    sDrop.innerHTML = '<div class="sr-empty">// Sin resultados para "'+q+'"</div>';
  } else {
    sDrop.innerHTML = results.slice(0,12).map((r,i) => `
      <div class="sr-item" role="option" onclick="goResult(${i})" data-i="${i}">
        <span class="sr-ico">⚡</span>
        <div class="sr-bd">
          <div class="sr-name">${hl(r.name, q)}</div>
          <div class="sr-code">${hl(r.code.substring(0,70), q)}</div>
          <div class="sr-meta"><span>📂 ${esc(r.sec)}</span><span>💻 ${esc(r.os)}</span></div>
        </div>
      </div>`).join('');
    window._srResults = results;
  }
  sDrop.classList.add('open');
  srchIn.setAttribute('aria-expanded','true');
}

function goResult(i) {
  const r = window._srResults[i];
  sDrop.classList.remove('open');
  srchIn.value = '';
  srchIn.setAttribute('aria-expanded','false');
  _srIdx = -1;
  // Close mobile sidebar if open
  const sb = document.getElementById('sidebarNav');
  if (sb && sb.classList.contains('open')) toggleSidebar();
  if (r.isPort) { showSec('cheat'); return; }
  if (r.card) {
    const sec = r.card.closest('.sec');
    if (sec) {
      showSec(sec.id);
      setTimeout(() => {
        r.card.scrollIntoView({behavior:'smooth',block:'center'});
        // Brief highlight pulse
        r.card.style.boxShadow = '0 0 0 3px rgba(var(--ear),.4)';
        setTimeout(() => r.card.style.boxShadow = '', 1200);
      }, 100);
    }
  }
}

// ═══════════════════════════════════════════
// PHASE 3: UI/UX ENHANCEMENTS
// ═══════════════════════════════════════════

// Scroll-to-top button visibility
(function initScrollTop() {
  const btn = document.getElementById('scrollTopBtn');
  const prog = document.getElementById('scrollProg');
  if (!btn) return;
  let ticking = false;
  window.addEventListener('scroll', () => {
    if (!ticking) {
      window.requestAnimationFrame(() => {
        const scrollY = window.scrollY || window.pageYOffset;
        btn.classList.toggle('vis', scrollY > 300);
        // Scroll progress bar
        if (prog) {
          const docH = document.documentElement.scrollHeight - window.innerHeight;
          prog.style.width = docH > 0 ? ((scrollY / docH) * 100) + '%' : '0%';
        }
        ticking = false;
      });
      ticking = true;
    }
  }, {passive: true});
})();

// Hamburger sidebar toggle (mobile)
function toggleSidebar() {
  const sb = document.getElementById('sidebarNav');
  const ov = document.getElementById('sbOverlay');
  if (!sb) return;
  // v5: Use drawer-open class for mobile drawer
  sb.classList.toggle('drawer-open');
  if (ov) ov.classList.toggle('open');
  // Toggle body scroll lock
  document.body.style.overflow = sb.classList.contains('drawer-open') ? 'hidden' : '';
}

// Close sidebar on navigation (mobile)
const _origShowSec = showSec;
showSec = function(id) {
  _origShowSec(id);
  // Close drawer when navigating (mobile only)
  const sb = document.getElementById('sidebarNav');
  const ov = document.getElementById('sbOverlay');
  if (sb && sb.classList.contains('drawer-open')) {
    sb.classList.remove('drawer-open');
    if (ov) ov.classList.remove('open');
    document.body.style.overflow = '';
  }
}

// v5: Bottom navigation click handler
function bottomNavClick(section) {
  // Update active state in bottom nav
  document.querySelectorAll('.nav-item-mobile').forEach(item => {
    item.classList.remove('active');
  });
  const clicked = document.querySelector(`[data-nav="${section}"]`);
  if (clicked) clicked.classList.add('active');
  
  // Navigate to section
  if (section === 'search') {
    // Focus global search
    const searchInput = document.getElementById('gSearch');
    if (searchInput) {
      searchInput.focus();
      searchInput.select();
    }
  } else if (section === 'home' || section === 'favs' || section === 'tools') {
    showSec(section);
  }
}

// Animate stat counters on home load (count-up effect)
function animateCounters() {
  document.querySelectorAll('.stat-num').forEach(el => {
    const target = parseInt(el.textContent);
    if (isNaN(target) || target === 0) return;
    el.classList.add('pop');
    const dur = 600, step = 16;
    let current = 0;
    const inc = target / (dur / step);
    const timer = setInterval(() => {
      current += inc;
      if (current >= target) { el.textContent = target; clearInterval(timer); return; }
      el.textContent = Math.floor(current);
    }, step);
  });
}

// ═══════════════════════════════════════════
// SUBNET CALCULATOR
// ═══════════════════════════════════════════
const CIDR_DATA = [
  {c:8,m:'255.0.0.0',h:16777214},{c:9,m:'255.128.0.0',h:8388606},
  {c:10,m:'255.192.0.0',h:4194302},{c:11,m:'255.224.0.0',h:2097150},
  {c:12,m:'255.240.0.0',h:1048574},{c:13,m:'255.248.0.0',h:524286},
  {c:14,m:'255.252.0.0',h:262142},{c:15,m:'255.254.0.0',h:131070},
  {c:16,m:'255.255.0.0',h:65534},{c:17,m:'255.255.128.0',h:32766},
  {c:18,m:'255.255.192.0',h:16382},{c:19,m:'255.255.224.0',h:8190},
  {c:20,m:'255.255.240.0',h:4094},{c:21,m:'255.255.248.0',h:2046},
  {c:22,m:'255.255.252.0',h:1022},{c:23,m:'255.255.254.0',h:510},
  {c:24,m:'255.255.255.0',h:254},{c:25,m:'255.255.255.128',h:126},
  {c:26,m:'255.255.255.192',h:62},{c:27,m:'255.255.255.224',h:30},
  {c:28,m:'255.255.255.240',h:14},{c:29,m:'255.255.255.248',h:6},
  {c:30,m:'255.255.255.252',h:2},{c:31,m:'255.255.255.254',h:0},
  {c:32,m:'255.255.255.255',h:0}
];

(function initSubnet() {
  const sel = document.getElementById('cidr-in');
  CIDR_DATA.forEach(d => {
    const o = document.createElement('option');
    o.value = d.c; o.textContent = '/'+d.c+' — '+d.m;
    if (d.c === 24) o.selected = true;
    sel.appendChild(o);
  });
  const tbody = document.getElementById('cidr-tbody');
  tbody.innerHTML = CIDR_DATA.map(d => `<tr onclick="copyTxt(this.cells[0])"><td>/${d.c}</td><td>${d.m}</td><td>${d.h.toLocaleString()}</td><td>${d.c <= 24 ? 'Subredes grandes' : d.c <= 28 ? 'Subredes medianas' : 'Subredes pequeñas'}</td></tr>`).join('');
})();

function calcSubnet() {
  const ipStr = document.getElementById('ip-in').value.trim();
  const cidr = parseInt(document.getElementById('cidr-in').value);
  const parts = ipStr.split('.').map(Number);
  if (parts.length !== 4 || parts.some(p => isNaN(p) || p<0 || p>255)) { toast('⚠️ IP inválida'); return; }
  const ipNum = (parts[0]<<24)|(parts[1]<<16)|(parts[2]<<8)|parts[3];
  const maskNum = cidr === 0 ? 0 : (~0 << (32-cidr)) >>> 0;
  const netNum = (ipNum & maskNum) >>> 0;
  const bcNum = (netNum | (~maskNum >>> 0)) >>> 0;
  const n2ip = n => [(n>>>24)&255,(n>>>16)&255,(n>>>8)&255,n&255].join('.');
  const hosts = cidr >= 31 ? 0 : Math.pow(2,32-cidr)-2;
  const wild = n2ip(~maskNum>>>0);
  document.getElementById('r-net').textContent = n2ip(netNum);
  document.getElementById('r-bc').textContent = n2ip(bcNum);
  document.getElementById('r-mask').textContent = n2ip(maskNum);
  document.getElementById('r-wild').textContent = wild;
  document.getElementById('r-first').textContent = cidr < 31 ? n2ip(netNum+1) : n2ip(netNum);
  document.getElementById('r-last').textContent = cidr < 31 ? n2ip(bcNum-1) : n2ip(bcNum);
  document.getElementById('r-hosts').textContent = hosts.toLocaleString();
  document.getElementById('r-bin').textContent = parts.map(p=>p.toString(2).padStart(8,'0')).join('.');
  document.getElementById('sub-results').style.display = 'grid';
  toast('✅ Subnet calculada');
}

// ═══════════════════════════════════════════
// REPORT GENERATOR
// ═══════════════════════════════════════════
function genReport() {
  const v = id => document.getElementById(id)?.value || '';
  const now = new Date().toLocaleString('es');
  const txt = `╔══════════════════════════════════════════════════════╗
║           REPORTE DE INCIDENCIA IT                  ║
╚══════════════════════════════════════════════════════╝

DATOS GENERALES
───────────────────────────────────────────────────────
Fecha/Hora    : ${now}
Técnico       : ${v('r-tec') || '—'}
Ticket ID     : ${v('r-tick') || '—'}
Usuario       : ${v('r-usr') || '—'}
Equipo/Activo : ${v('r-equip') || '—'}
Prioridad     : ${v('r-pri')}
Categoría     : ${v('r-cat')}
Estado        : ${v('r-stat')}

DESCRIPCIÓN DEL PROBLEMA
───────────────────────────────────────────────────────
${v('r-desc') || '(sin descripción)'}

PASOS REALIZADOS
───────────────────────────────────────────────────────
${v('r-steps') || '(sin pasos registrados)'}

SOLUCIÓN APLICADA
───────────────────────────────────────────────────────
${v('r-sol') || '(sin solución registrada)'}

───────────────────────────────────────────────────────
Generado con IT Toolkit v4.0 — ${now}`;
  document.getElementById('rep-out').textContent = txt;
  toast('📄 Reporte generado');
}

function printReport() {
  const out = document.getElementById('rep-out').textContent;
  if (!out.includes('REPORTE')) { toast('⚠️ Genera el reporte primero'); return; }
  const w = window.open('','_blank');
  w.document.write('<pre style="font-family:monospace;font-size:12px;padding:30px;white-space:pre-wrap">'+out+'</pre>');
  w.document.close(); w.print();
}

function exportTxt() {
  const out = document.getElementById('rep-out').textContent;
  if (!out.includes('REPORTE')) { toast('⚠️ Genera el reporte primero'); return; }
  const tick = document.getElementById('r-tick')?.value || 'reporte';
  dlFile(`${tick}.txt`, out, 'text/plain');
  toast('💾 Reporte exportado');
}

function clearReport() {
  ['r-tec','r-tick','r-usr','r-equip','r-desc','r-steps','r-sol'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  document.getElementById('rep-out').textContent = '// Completa el formulario y pulsa ⚡ Generar';
}

// ═══════════════════════════════════════════
// SLA TIMER
// ═══════════════════════════════════════════
let tInterval = null, tSeconds = 0, tRunning = false;

function startTimer() {
  if (tRunning) return;
  tRunning = true;
  tInterval = setInterval(() => {
    tSeconds++;
    const h = Math.floor(tSeconds/3600), m = Math.floor((tSeconds%3600)/60), s = tSeconds%60;
    const disp = document.getElementById('tDisp');
    disp.textContent = String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
    disp.className = 'timer-disp run';
    // SLA check
    const slaH = parseInt(document.getElementById('t-sev').value);
    const pct = tSeconds / (slaH * 3600);
    const ind = document.getElementById('slaInd');
    if (pct >= 1) { ind.className='sla-ind sla-cr'; ind.textContent='⚠️ SLA VENCIDO'; }
    else if (pct >= 0.8) { ind.className='sla-ind sla-wn'; ind.textContent='⏰ SLA en riesgo'; }
    else { ind.className='sla-ind sla-ok'; ind.textContent='✅ SLA OK'; }
  }, 1000);
  toast('▶ Timer iniciado');
}

function pauseTimer() {
  if (!tRunning) return;
  clearInterval(tInterval); tRunning = false;
  document.getElementById('tDisp').className = 'timer-disp pau';
  toast('⏸ Timer pausado');
}

function stopTimer() {
  clearInterval(tInterval); tRunning = false;
  const inc = document.getElementById('t-inc').value || 'Incidente sin título';
  const sev = document.getElementById('t-sev').selectedOptions[0].text;
  const h = Math.floor(tSeconds/3600), m = Math.floor((tSeconds%3600)/60), s = tSeconds%60;
  const timeStr = String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
  const entry = {inc, sev, time: timeStr, ts: new Date().toLocaleString('es')};
  let incidents = [];
  try { incidents = JSON.parse(localStorage.getItem('itk_incidents') || '[]'); } catch(e){}
  incidents.unshift(entry);
  try { localStorage.setItem('itk_incidents', JSON.stringify(incidents.slice(0,50))); } catch(e){}
  tSeconds = 0;
  document.getElementById('tDisp').textContent = '00:00:00';
  document.getElementById('tDisp').className = 'timer-disp';
  document.getElementById('slaInd').className = 'sla-ind sla-ok';
  document.getElementById('slaInd').textContent = 'SLA OK';
  renderIncidents();
  toast('⏹ Incidente registrado: '+timeStr);
}

function renderIncidents() {
  let incidents = [];
  try { incidents = JSON.parse(localStorage.getItem('itk_incidents') || '[]'); } catch(e){}
  const list = document.getElementById('incList');
  if (!incidents.length) { list.innerHTML = '<div style="color:var(--tx3);font-family:var(--mono);font-size:11px;padding:20px 0;text-align:center">// Sin incidentes registrados</div>'; return; }
  list.innerHTML = incidents.slice(0,20).map((inc,i) => `
    <div class="inc-entry">
      <div class="inc-time">${inc.time}</div>
      <div class="inc-info">
        <div class="inc-ttl">${inc.inc}</div>
        <div class="inc-meta"><span>${inc.sev.substring(0,8)}</span><span>${inc.ts}</span></div>
      </div>
      <button class="xbtn" onclick="delIncident(${i})">✕</button>
    </div>`).join('');
}

function delIncident(i) {
  let incidents = [];
  try { incidents = JSON.parse(localStorage.getItem('itk_incidents') || '[]'); } catch(e){}
  incidents.splice(i,1);
  try { localStorage.setItem('itk_incidents', JSON.stringify(incidents)); } catch(e){}
  renderIncidents();
}

// ═══════════════════════════════════════════
// NOTES
// ═══════════════════════════════════════════
let notes = [];
function loadNotes() {
  try { notes = JSON.parse(localStorage.getItem('itk_notes') || '[]'); } catch(e){ notes=[]; }
}

function saveNote() {
  const title = document.getElementById('n-title').value.trim();
  const body = document.getElementById('n-body').value.trim();
  if (!title) { toast('⚠️ Escribe un título'); return; }
  notes.unshift({title, body, ts: new Date().toLocaleString('es')});
  try { localStorage.setItem('itk_notes', JSON.stringify(notes)); } catch(e){}
  document.getElementById('n-title').value = '';
  document.getElementById('n-body').value = '';
  renderNotes();
  toast('💾 Nota guardada');
}

function renderNotes() {
  const list = document.getElementById('notesList');
  const cnt = document.getElementById('noteCnt');
  cnt.textContent = `(${notes.length})`;
  if (!notes.length) { list.innerHTML = '<div style="color:var(--tx3);font-family:var(--mono);font-size:11px;padding:20px 0;text-align:center">// Sin notas guardadas</div>'; return; }
  list.innerHTML = notes.map((n,i) => `
    <div class="note-c">
      <div class="note-tt">${n.title}</div>
      <div class="note-bd">${n.body}</div>
      <div class="note-ft">
        <span class="note-dt">${n.ts}</span>
        <div class="note-acts">
          <button class="nbtn" onclick="editNote(${i})">✏️</button>
          <button class="nbtn del" onclick="delNote(${i})">🗑️</button>
        </div>
      </div>
    </div>`).join('');
}

function editNote(i) {
  document.getElementById('n-title').value = notes[i].title;
  document.getElementById('n-body').value = notes[i].body;
  notes.splice(i,1);
  try { localStorage.setItem('itk_notes', JSON.stringify(notes)); } catch(e){}
  renderNotes();
}

function delNote(i) {
  notes.splice(i,1);
  try { localStorage.setItem('itk_notes', JSON.stringify(notes)); } catch(e){}
  renderNotes();
  toast('🗑️ Nota eliminada');
}

function exportNotas() {
  if (!notes.length) { toast('Sin notas que exportar'); return; }
  dlFile('notas_it.json', JSON.stringify(notes, null, 2), 'application/json');
  toast('📤 Notas exportadas');
}

function importNotas() {
  document.getElementById('n-import').click();
}

function importNotasFile(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const imported = JSON.parse(e.target.result);
      if (Array.isArray(imported)) {
        notes = [...imported, ...notes];
        try { localStorage.setItem('itk_notes', JSON.stringify(notes)); } catch(err){}
        renderNotes();
        toast('📥 '+imported.length+' notas importadas');
      }
    } catch(err) { toast('⚠️ Error al importar'); }
  };
  reader.readAsText(file);
}

// ═══════════════════════════════════════════
// UTILITY
// ═══════════════════════════════════════════
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(t._to);
  t._to = setTimeout(() => t.classList.remove('show'), 2200);
}

function dlFile(name, content, type) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([content], {type}));
  a.download = name;
  a.click();
}


// ═══════════════════════════════════════════
// TOOLS DATABASE
// ═══════════════════════════════════════════
const TOOLS_DB = [
  // ── N1 GENERAL ──
  { name:"CrystalDiskInfo", ico:"💿", desc:"Estado SMART y salud de discos duros y SSD en tiempo real.", url:"https://crystalmark.info", price:"free", env:["general","win","sd"], os:["win"], tags:["Portable","SMART","Disco"], level:"N1" },
  { name:"CPU-Z", ico:"🔬", desc:"Información detallada de CPU, RAM, placa base y voltajes.", url:"https://www.cpuid.com", price:"free", env:["general","win","sd"], os:["win"], tags:["Portable","Hardware","CPU"], level:"N1" },
  { name:"HWiNFO64", ico:"🖥️", desc:"Monitorización completa de hardware, sensores y temperatura.", url:"https://www.hwinfo.com", price:"free", env:["general","win","sd"], os:["win"], tags:["Portable","Sensores","Monitor"], level:"N1" },
  { name:"GPU-Z", ico:"🎮", desc:"Información detallada de la tarjeta gráfica, VRAM y temperaturas.", url:"https://www.techpowerup.com/gpuz", price:"free", env:["general","win","sd"], os:["win"], tags:["Portable","GPU","Hardware"], level:"N1" },
  { name:"Recuva", ico:"♻️", desc:"Recuperación de archivos borrados de discos, USBs y tarjetas SD.", url:"https://www.ccleaner.com/recuva", price:"free", env:["general","win","sd"], os:["win"], tags:["Recovery","Datos"], level:"N1" },
  { name:"WinDirStat", ico:"🗂️", desc:"Visualización gráfica del uso del espacio en disco por carpetas.", url:"https://windirstat.net", price:"free", env:["general","win","sd"], os:["win"], tags:["Disco","Espacio","Visual"], level:"N1" },
  { name:"SpaceSniffer", ico:"🗺️", desc:"Mapa visual de uso de disco con interacción en tiempo real.", url:"http://www.uderzo.it/main_products/space_sniffer", price:"free", env:["general","win","sd"], os:["win"], tags:["Disco","Portable"], level:"N1" },
  { name:"TeamViewer QS", ico:"🎮", desc:"Control remoto rápido sin instalación (QuickSupport).", url:"https://www.teamviewer.com", price:"free", env:["general","win","lin","mac","sd","corp"], os:["win","lin","mac"], tags:["Remote","Portable"], level:"N1" },
  { name:"AnyDesk", ico:"🖱️", desc:"Control remoto ultraligero, baja latencia. Alternativa a TeamViewer.", url:"https://anydesk.com", price:"free", env:["general","win","sd","corp"], os:["win","lin","mac"], tags:["Remote","Portable"], level:"N1" },
  { name:"Malwarebytes", ico:"🦠", desc:"Escaneo de malware y ransomware sin instalación requerida.", url:"https://www.malwarebytes.com", price:"free", env:["general","win","sd","sec"], os:["win"], tags:["Antimalware","Portable"], level:"N1" },
  { name:"Autoruns", ico:"🚀", desc:"Lista TODO lo que arranca con Windows. Esencial para malware.", url:"https://learn.microsoft.com/sysinternals/downloads/autoruns", price:"free", env:["general","win","sd","sec"], os:["win"], tags:["Startup","Malware","Sysinternals"], level:"N1" },
  { name:"WhoCrashed", ico:"💥", desc:"Analiza dumps de pantallazos azules (BSOD) de forma sencilla.", url:"https://www.resplendence.com/whoCrashed", price:"free", env:["general","win","sd"], os:["win"], tags:["BSOD","Crash","Diagnóstico"], level:"N1" },
  { name:"Ventoy", ico:"💾", desc:"Crea USB booteable con múltiples ISOs sin formatear cada vez.", url:"https://www.ventoy.net", price:"free", env:["general","win","lin","sd"], os:["win","lin"], tags:["Booteable","ISO","USB"], level:"N1" },
  { name:"Rufus", ico:"📀", desc:"Crea unidades USB arrancables desde imágenes ISO.", url:"https://rufus.ie", price:"free", env:["general","win","sd"], os:["win"], tags:["Booteable","ISO","USB"], level:"N1" },
  // ── N2 TÉCNICO ──
  { name:"Wireshark", ico:"🦈", desc:"Análisis de tráfico de red y captura de paquetes en profundidad.", url:"https://www.wireshark.org", price:"free", env:["general","win","lin","mac","net","sec"], os:["win","lin","mac"], tags:["Network","Sniffer","Packets"], level:"N2" },
  { name:"Nmap / ZenMap", ico:"🗺️", desc:"Escáner de red, detección de hosts y servicios abiertos.", url:"https://nmap.org", price:"free", env:["general","win","lin","net","sec"], os:["win","lin"], tags:["Scanner","Network","Ports"], level:"N2" },
  { name:"Angry IP Scanner", ico:"📡", desc:"Escáner de red rápido y ligero. Escanea IPs, puertos y hostname.", url:"https://angryip.org", price:"free", env:["general","win","lin","mac","net","sd"], os:["win","lin","mac"], tags:["Scanner","Network","Fast"], level:"N2" },
  { name:"Process Monitor", ico:"🔭", desc:"Monitor avanzado de sistema de archivos, registro y red en tiempo real.", url:"https://learn.microsoft.com/sysinternals/downloads/procmon", price:"free", env:["win","sec","sd"], os:["win"], tags:["Sysinternals","Monitor","Registro"], level:"N2" },
  { name:"Process Explorer", ico:"🔬", desc:"Task Manager avanzado con árbol de procesos y DLLs cargadas.", url:"https://learn.microsoft.com/sysinternals/downloads/process-explorer", price:"free", env:["win","sec","sd"], os:["win"], tags:["Sysinternals","Procesos","DLL"], level:"N2" },
  { name:"TCPView", ico:"🔌", desc:"Muestra conexiones TCP/UDP activas con proceso responsable.", url:"https://learn.microsoft.com/sysinternals/downloads/tcpview", price:"free", env:["win","net","sec"], os:["win"], tags:["Sysinternals","Network","Puertos"], level:"N2" },
  { name:"PuTTY", ico:"🐚", desc:"Cliente SSH, Telnet y Serial clásico y portable.", url:"https://www.putty.org", price:"free", env:["general","win","net","sd","dev"], os:["win"], tags:["SSH","Telnet","Serial"], level:"N2" },
  { name:"MobaXterm", ico:"💻", desc:"Terminal SSH, RDP, VNC, FTP todo en uno. Perfecto para sysadmins.", url:"https://mobaxterm.mobatek.net", price:"free", env:["general","win","dev","ad","net"], os:["win"], tags:["SSH","RDP","Terminal"], level:"N2" },
  { name:"Nirsoft Suite", ico:"🧰", desc:"+200 utilidades portátiles: passwords, red, registry, browsers...", url:"https://www.nirsoft.net", price:"free", env:["general","win","sd","sec"], os:["win"], tags:["Suite","Portable","Passwords"], level:"N2" },
  { name:"WinSCP", ico:"📂", desc:"Cliente SFTP/FTP con interfaz gráfica para transferencia segura.", url:"https://winscp.net", price:"free", env:["win","dev","corp"], os:["win"], tags:["SFTP","FTP","Transferencia"], level:"N2" },
  { name:"FileZilla", ico:"📁", desc:"Cliente FTP/SFTP multiplataforma con interfaz clara.", url:"https://filezilla-project.org", price:"free", env:["general","win","lin","mac","dev"], os:["win","lin","mac"], tags:["FTP","SFTP","Transfer"], level:"N2" },
  { name:"Rclone", ico:"☁️", desc:"Sincronización de archivos a la nube: S3, GDrive, OneDrive, Azure...", url:"https://rclone.org", price:"free", env:["corp","dev","lin","mac"], os:["win","lin","mac"], tags:["Cloud","Sync","Backup"], level:"N2" },
  { name:"7-Zip", ico:"📦", desc:"Compresor portable con soporte para +20 formatos incluyendo cifrado AES.", url:"https://www.7-zip.org", price:"free", env:["general","win","sd"], os:["win","lin"], tags:["Portable","Compresión","Cifrado"], level:"N1" },
  { name:"Notepad++", ico:"📝", desc:"Editor de texto avanzado con resaltado de sintaxis y macros.", url:"https://notepad-plus-plus.org", price:"free", env:["general","win","sd","dev"], os:["win"], tags:["Editor","Código","Portable"], level:"N1" },
  // ── N3 SYSADMIN ──
  { name:"KeePass Portable", ico:"🔐", desc:"Gestor de contraseñas local con cifrado AES-256. Sin nube.", url:"https://keepass.info", price:"free", env:["general","win","lin","mac","sec","ad","corp"], os:["win","lin","mac"], tags:["Passwords","AES","Portable"], level:"N3" },
  { name:"RSAT Tools", ico:"🏢", desc:"Herramientas de administración remota Microsoft para AD, DNS, DHCP.", url:"https://learn.microsoft.com/windows-server/remote/remote-server-administration-tools", price:"free", env:["ad","win","corp"], os:["win"], tags:["AD","DNS","DHCP"], level:"N3" },
  { name:"AD Explorer", ico:"🔍", desc:"Explorador avanzado de Active Directory sin necesidad de ADUC.", url:"https://learn.microsoft.com/sysinternals/downloads/adexplorer", price:"free", env:["ad","sec","corp"], os:["win"], tags:["Sysinternals","AD","LDAP"], level:"N3" },
  { name:"LDAPAdmin", ico:"📋", desc:"Editor LDAP gráfico para gestión detallada de Active Directory.", url:"http://www.ldapadmin.org", price:"free", env:["ad","corp"], os:["win"], tags:["LDAP","AD","GUI"], level:"N3" },
  { name:"Volatility", ico:"🧠", desc:"Framework forense para análisis de memoria RAM. Detecta malware avanzado.", url:"https://volatilityfoundation.org", price:"free", env:["sec","win","lin"], os:["win","lin"], tags:["Forense","RAM","Malware"], level:"N3" },
  { name:"Wireshark", ico:"🦈", desc:"También esencial para N3: análisis profundo de protocolos y seguridad.", url:"https://www.wireshark.org", price:"free", env:["sec","net","dev"], os:["win","lin","mac"], tags:["Forense","Seguridad","Network"], level:"N3" },
  { name:"Fiddler Classic", ico:"🌐", desc:"Proxy HTTP para depuración y análisis de tráfico web.", url:"https://www.telerik.com/fiddler", price:"free", env:["sec","dev","corp"], os:["win","lin","mac"], tags:["HTTP","Proxy","Debug"], level:"N3" },
  { name:"HashCalc", ico:"🔑", desc:"Calcula hashes MD5, SHA1, SHA256 de archivos para verificación.", url:"https://www.slavasoft.com/hashcalc", price:"free", env:["sec","general"], os:["win"], tags:["Hashes","Integridad","Forense"], level:"N2" },
  { name:"OpenSSL", ico:"🔒", desc:"Suite criptográfica CLI: certificados, TLS, cifrado de archivos.", url:"https://www.openssl.org", price:"free", env:["sec","dev","net"], os:["win","lin","mac"], tags:["SSL","Certificados","CLI"], level:"N3" },
  // ── LINUX ──
  { name:"htop", ico:"📊", desc:"Monitor de procesos interactivo y visual para Linux/macOS.", url:"https://htop.dev", price:"free", env:["lin","mac","dev","sec"], os:["lin","mac"], tags:["Monitor","Procesos","CPU"], level:"N2" },
  { name:"glances", ico:"👁️", desc:"Monitor del sistema todo en uno: CPU, RAM, red, disco, procesos.", url:"https://nicolargo.github.io/glances", price:"free", env:["lin","mac","dev"], os:["lin","mac"], tags:["Monitor","Sistema","Web UI"], level:"N2" },
  { name:"netdata", ico:"📈", desc:"Monitorización en tiempo real con dashboard web. Cero config.", url:"https://www.netdata.cloud", price:"free", env:["lin","dev","net"], os:["lin","mac"], tags:["Monitor","Dashboard","Web"], level:"N2" },
  { name:"ncdu", ico:"📁", desc:"Analizador de espacio en disco interactivo para terminal.", url:"https://dev.yorhel.nl/ncdu", price:"free", env:["lin","mac","dev"], os:["lin","mac"], tags:["Disco","Espacio","TUI"], level:"N2" },
  { name:"tmux", ico:"🖥️", desc:"Multiplexor de terminal: múltiples sesiones, paneles y ventanas.", url:"https://github.com/tmux/tmux", price:"free", env:["lin","mac","dev"], os:["lin","mac"], tags:["Terminal","SSH","Sesiones"], level:"N2" },
  { name:"mtr", ico:"🗺️", desc:"Combina ping y traceroute en tiempo real. Diagnóstico de red.", url:"https://www.bitwizard.nl/mtr", price:"free", env:["lin","mac","net"], os:["lin","mac"], tags:["Network","Ping","Traceroute"], level:"N1" },
  { name:"iperf3", ico:"⚡", desc:"Medición de ancho de banda de red entre dos puntos.", url:"https://iperf.fr", price:"free", env:["net","lin","mac","dev"], os:["win","lin","mac"], tags:["Bandwidth","Network","Test"], level:"N2" },
  { name:"Ansible", ico:"⚙️", desc:"Automatización de infraestructura sin agentes. IaC.", url:"https://www.ansible.com", price:"free", env:["dev","lin","mac"], os:["lin","mac"], tags:["Automatización","IaC","SSH"], level:"N3" },
  { name:"Terraform", ico:"🏗️", desc:"Infraestructura como código para cloud: AWS, Azure, GCP.", url:"https://www.terraform.io", price:"free", env:["dev","corp"], os:["win","lin","mac"], tags:["IaC","Cloud","DevOps"], level:"N3" },
  // ── MACINTOSH ──
  { name:"iStat Menus", ico:"📊", desc:"Monitor del sistema para menú macOS: CPU, RAM, red, disco.", url:"https://bjango.com/mac/istatmenus", price:"paid", env:["mac"], os:["mac"], tags:["Monitor","Sistema","macOS"], level:"N1" },
  { name:"DiskDiag", ico:"💿", desc:"Diagnóstico de disco SMART y rendimiento para macOS.", url:"https://apps.apple.com/app/diskdiag/id672706660", price:"free", env:["mac"], os:["mac"], tags:["SMART","Disco","macOS"], level:"N1" },
  { name:"Homebrew", ico:"🍺", desc:"Gestor de paquetes para macOS. Instala herramientas CLI fácilmente.", url:"https://brew.sh", price:"free", env:["mac","dev","lin"], os:["mac","lin"], tags:["Paquetes","CLI","Essential"], level:"N1" },
  { name:"iTerm2", ico:"🖥️", desc:"Terminal para macOS con pestañas, splits y búsqueda.", url:"https://iterm2.com", price:"free", env:["mac","dev"], os:["mac"], tags:["Terminal","SSH","macOS"], level:"N1" },
  { name:"Disk Diag & Cleaner", ico:"🧹", desc:"Herramientas de limpieza y diagnóstico para macOS.", url:"https://apps.apple.com/us/app/disk-diag/id672706660", price:"free", env:["mac","sd"], os:["mac"], tags:["Limpieza","macOS","Disco"], level:"N1" },
  // ── CORP / M365 ──
  { name:"Microsoft 365 Admin Center", ico:"☁️", desc:"Portal web de administración de M365: usuarios, licencias, dominios.", url:"https://admin.microsoft.com", price:"paid", env:["corp","ad"], os:["win","mac","lin"], tags:["M365","Admin","Web"], level:"N3" },
  { name:"Azure AD Connect", ico:"🔗", desc:"Sincronización de identidades entre AD local y Azure AD.", url:"https://learn.microsoft.com/azure/active-directory/hybrid/whatis-azure-ad-connect", price:"free", env:["corp","ad"], os:["win"], tags:["Azure AD","Sync","Identidad"], level:"N3" },
  { name:"Exchange Admin Center", ico:"📧", desc:"Portal de administración de Exchange Online vía web.", url:"https://admin.exchange.microsoft.com", price:"paid", env:["corp","ad"], os:["win","mac","lin"], tags:["Exchange","Email","M365"], level:"N3" },
  { name:"Microsoft Teams Admin", ico:"💬", desc:"Portal web de administración de Teams: usuarios, políticas, reuniones.", url:"https://admin.teams.microsoft.com", price:"paid", env:["corp","sd"], os:["win","mac","lin"], tags:["Teams","M365","Admin"], level:"N3" },
  { name:"PowerShell 7", ico:"⚡", desc:"Shell de automatización multiplataforma con módulos para M365, Azure, AD.", url:"https://github.com/PowerShell/PowerShell", price:"free", env:["win","ad","corp","dev"], os:["win","lin","mac"], tags:["Automatización","CLI","M365"], level:"N2" },
  { name:"Windows Terminal", ico:"🖥️", desc:"Terminal moderno de Microsoft: múltiples tabs, PS, CMD, WSL.", url:"https://github.com/microsoft/terminal", price:"free", env:["win","dev","ad"], os:["win"], tags:["Terminal","Moderno","Tabs"], level:"N1" },
  // ── DEVOPS ──
  { name:"Docker Desktop", ico:"🐳", desc:"Plataforma de contenedores con GUI para Windows y macOS.", url:"https://www.docker.com/products/docker-desktop", price:"free", env:["dev","win","mac","lin"], os:["win","mac"], tags:["Contenedores","DevOps","GUI"], level:"N3" },
  { name:"Lens (Kubernetes IDE)", ico:"🔭", desc:"IDE visual para gestión de clústeres Kubernetes.", url:"https://k8slens.dev", price:"free", env:["dev","corp"], os:["win","lin","mac"], tags:["Kubernetes","DevOps","GUI"], level:"N3" },
  { name:"VS Code", ico:"💙", desc:"Editor de código extensible con soporte para remoto SSH, DevContainers.", url:"https://code.visualstudio.com", price:"free", env:["dev","general"], os:["win","lin","mac"], tags:["Editor","IDE","Git"], level:"N1" },
  { name:"Git", ico:"🌿", desc:"Control de versiones. Esencial para gestión de scripts y configs.", url:"https://git-scm.com", price:"free", env:["dev","general"], os:["win","lin","mac"], tags:["Git","VCS","Scripts"], level:"N1" },
  { name:"Postman", ico:"🚀", desc:"Plataforma de pruebas de APIs REST/GraphQL con colecciones.", url:"https://www.postman.com", price:"free", env:["dev","corp"], os:["win","lin","mac"], tags:["API","REST","Test"], level:"N2" },
  // ── SEGURIDAD ──
  { name:"Burp Suite Community", ico:"🔓", desc:"Proxy y escáner de seguridad web. Intercepta y modifica peticiones HTTP.", url:"https://portswigger.net/burp/communitydownload", price:"free", env:["sec"], os:["win","lin","mac"], tags:["Web","Security","Proxy"], level:"N3" },
  { name:"CyberChef", ico:"🍳", desc:"Navaja suiza de operaciones de datos: codificación, cifrado, análisis forense.", url:"https://gchq.github.io/CyberChef", price:"free", env:["sec","dev"], os:["win","lin","mac"], tags:["Forense","Encoding","Web"], level:"N2" },
  { name:"Sysinternals Suite", ico:"🛠️", desc:"Suite completa de +70 utilidades de Microsoft para diagnóstico avanzado.", url:"https://learn.microsoft.com/sysinternals/downloads/sysinternals-suite", price:"free", env:["win","sec","ad","sd"], os:["win"], tags:["Suite","Microsoft","Sysadmin"], level:"N2" },
  { name:"Netcat (nc)", ico:"🔌", desc:"Herramienta de red versátil: escucha puertos, tunneling, transferencia.", url:"https://nmap.org/ncat", price:"free", env:["sec","net","lin","mac"], os:["win","lin","mac"], tags:["Network","Puertos","Tunneling"], level:"N2" },
];

const ENV_LABELS = {
  all:"⚡ Todos", general:"⚡ General/Helpdesk", win:"🪟 Windows", lin:"🐧 Linux",
  mac:"🍎 macOS", ad:"🏢 Active Directory", corp:"🏛️ Corporativo", 
  sd:"🎧 Service Desk", sec:"🔐 Seguridad", net:"📡 Redes", dev:"⚙️ DevOps"
};

const LEVEL_COLORS = { N1:"var(--gr)", N2:"var(--yw)", N3:"var(--rd)" };

function filterTools() {
  const env = document.getElementById('toolEnvFilter')?.value || 'all';
  const os = document.getElementById('toolOsFilter')?.value || 'all';
  const price = document.getElementById('toolPriceFilter')?.value || 'all';
  
  const filtered = TOOLS_DB.filter(t => {
    const envOk = env === 'all' || t.env.includes(env);
    const osOk = os === 'all' || t.os.includes(os);
    const priceOk =
      price === 'all' ||
      (price === 'free' && t.price === 'free') ||
      (price === 'paid' && t.price === 'paid');
    return envOk && osOk && priceOk;
  });
  
  // Remove duplicates by name
  const seen = new Set();
  const unique = filtered.filter(t => !seen.has(t.name) && seen.add(t.name));
  
  const container = document.getElementById('toolsContainer');
  if (!container) return;
  
  const lc = document.getElementById('toolCount');
  if (lc) lc.textContent = unique.length;
  
  container.innerHTML = unique.map(t => {
    const osBadges = t.os.map(o => ({win:'<span class="ob ob-w">🪟WIN</span>',lin:'<span class="ob ob-l">🐧LIN</span>',mac:'<span class="ob ob-m">🍎MAC</span>'}[o]||'')).join('');
    const tags = t.tags.map(tg => `<span class="tool-tag">${tg}</span>`).join('');
    const priceClass = t.price === 'free' ? 'tf' : 'tp2';
    const priceLabel = t.price === 'free' ? '✅ GRATIS' : '💼 DE PAGO';
    const envBadge = env !== 'all' ? `<span class="tool-tag" style="border-color:var(--ea);color:var(--ea)">${ENV_LABELS[env]||''}</span>` : '';
    return `<div class="tool-c" style="border-top:2px solid ${LEVEL_COLORS[t.level]||'var(--ea)'}">
      <div class="tool-top">
        <span class="tool-ico">${t.ico}</span>
        <span class="tool-nm">${t.name}</span>
        <span class="tool-bdg ${priceClass}">${priceLabel}</span>
      </div>
      <div class="cmd-desc">${t.desc}</div>
      <div class="os-bs" style="margin:6px 0">${osBadges}</div>
      <a href="${t.url}" target="_blank" rel="noopener" class="tool-lnk">🔗 ${t.url.replace('https://','').replace('http://','').split('/')[0]}</a>
      <div class="tool-tags" style="margin-top:6px"><span class="tool-tag" style="border-color:${LEVEL_COLORS[t.level]};color:${LEVEL_COLORS[t.level]}">${t.level}</span>${tags}${envBadge}</div>
    </div>`;
  }).join('');
  
  if (unique.length === 0) {
    container.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;font-family:var(--mono);color:var(--tx3);font-size:11px;">// Sin herramientas para este filtro</div>';
  }
}

// ═══════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════
(function init() {
  // v5: Register Service Worker for PWA
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('service-worker.js')
        .then(reg => console.log('✓ Service Worker registered:', reg.scope))
        .catch(err => console.log('✗ SW registration failed:', err));
    });
  }
  
  // Schema migration (must run first)
  migrateStorage();
  // Restore env
  try {
    const env = localStorage.getItem('itk_env');
    if (env) setEnv(env);
  } catch(e){}
  // Restore theme
  try {
    if (localStorage.getItem('itk_theme') === 'light') {
      document.body.classList.add('lm');
      document.getElementById('themeBtn').textContent = '☀️';
    }
  } catch(e){}
  // Restore tooltips state
  try {
    if (localStorage.getItem('itk_tooltips') === 'disabled') {
      document.body.classList.add('no-tooltips');
      const helpBtn = document.getElementById('helpBtn');
      if (helpBtn) {
        helpBtn.style.opacity = '0.5';
        helpBtn.title = 'Mostrar información de ayuda';
      }
    }
  } catch(e){}
  loadCustomCmds();
  initCustomCmds();
  renderAllCards();
  updateCommandCount();
  loadFavs();
  loadHistory();
  loadNotes();
  renderIncidents();
  filterTools();
  applyCommandCodeFilter();
  
  // Sync tools env filter with current env
  const curEnv = document.body.getAttribute('data-env') || 'default';
  const toolSel = document.getElementById('toolEnvFilter');
  if (toolSel && curEnv !== 'default') {
    toolSel.value = curEnv;
    filterTools();
  }
  applySidebarFilter(curEnv);
  // Initialize OS filter (default: all)  
  setOsF('all');
  // Animate stat counters (Phase 3)
  animateCounters();
  // Smoke test (runs last, non-blocking)
  smokeTest();
})();
</script>

<!-- BOTTOM NAVIGATION (Mobile) -->
<nav class="bottom-nav" id="bottomNav" role="navigation" aria-label="Navegación móvil inferior">
  <div class="bottom-nav-items">
    <a class="nav-item-mobile active" data-nav="home" onclick="bottomNavClick('home')" title="Inicio" aria-label="Ir a inicio">
      🏠
      <span>Inicio</span>
    </a>
    <a class="nav-item-mobile" data-nav="search" onclick="bottomNavClick('search')" title="Buscar" aria-label="Buscar comandos">
      🔍
      <span>Buscar</span>
    </a>
    <a class="nav-item-mobile" data-nav="favs" onclick="bottomNavClick('favs')" title="Favoritos" aria-label="Ver favoritos">
      ⭐
      <span>Favoritos</span>
    </a>
    <a class="nav-item-mobile" data-nav="tools" onclick="bottomNavClick('tools')" title="Herramientas" aria-label="Ver herramientas">
      🧰
      <span>Tools</span>
    </a>
    <a class="nav-item-mobile" data-nav="menu" onclick="toggleSidebar()" title="Menú" aria-label="Abrir menú">
      ☰
      <span>Menú</span>
    </a>
  </div>
</nav>

</body>
</html>
